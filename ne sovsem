using System;
using System.Collections.Generic;
using System.Data.SQLite;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Telegram.Bot;
using Telegram.Bot.Polling;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;
using Telegram.Bot.Types.ReplyMarkups;

namespace InvestmentBot
{
    class Program
    {
        #region Constants and Fields

        private const string BotToken = "8306720947:AAHKnXBWxuRT5uWVQQO6R6mcxeFnMxsFrsY";
        private static readonly long[] AdminIds = { 1800817933 };
        private static readonly TimeSpan InterestInterval = TimeSpan.FromDays(7);
        private static readonly ITelegramBotClient BotClient = new TelegramBotClient(BotToken);
        private static readonly SQLiteConnection DbConnection = new SQLiteConnection("Data Source=investments.db;Version=3;");
        private static readonly System.Timers.Timer InterestTimer = new System.Timers.Timer(InterestInterval.TotalMilliseconds);
        private static readonly Dictionary<long, string> UserStates = new Dictionary<long, string>();
        private static readonly Dictionary<long, int> LastMessageIds = new Dictionary<long, int>();
        private static readonly Dictionary<long, (string Data, DateTime Timestamp)> LastCallbackData =
    new Dictionary<long, (string Data, DateTime Timestamp)>();

        #endregion

        #region Data Models

        public class Deposit
        {
            public int Id { get; set; }
            public long UserId { get; set; }
            public string Username { get; set; }
            public decimal Amount { get; set; }
            public DateTime Date { get; set; }
            public string Status { get; set; }
        }

        public class Withdrawal
        {
            public int Id { get; set; }
            public long UserId { get; set; }
            public string Username { get; set; }
            public decimal Amount { get; set; }
            public DateTime Date { get; set; }
            public string Status { get; set; }
        }

        public class Requisite
        {
            public int Id { get; set; }
            public string Type { get; set; }
            public string BankOrCoin { get; set; }
            public string Details { get; set; }
            public DateTime DateAdded { get; set; }
        }

        #endregion

        #region Program Initialization

        static Program()
        {
            InterestTimer.Elapsed += async (sender, e) => await CalculateInterestAsync();
            InterestTimer.AutoReset = true;
        }

        static async Task Main(string[] args)
        {
            try
            {
                await DbConnection.OpenAsync();
                await InitializeDatabaseAsync();
                InterestTimer.Start();

                var cts = new CancellationTokenSource();
                var receiverOptions = new ReceiverOptions { AllowedUpdates = { } };
                BotClient.StartReceiving(HandleUpdateAsync, HandleErrorAsync, receiverOptions, cts.Token);

                Console.WriteLine("–ë–æ—Ç FAST INVEST –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –≤—ã—Ö–æ–¥–∞.");
                Console.ReadKey();

                cts.Cancel();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {ex}");
            }
            finally
            {
                await DbConnection.CloseAsync();
            }
        }

        #endregion

        #region Database Methods

        private static async Task InitializeDatabaseAsync()
        {
            string[] queries = {
        @"CREATE TABLE IF NOT EXISTS Users (
            TelegramId INTEGER PRIMARY KEY,
            Username TEXT,
            Deposit REAL DEFAULT 0,
            Interest REAL DEFAULT 0,
            Status TEXT DEFAULT '–ù–æ–≤–∏—á–æ–∫',
            ReferralCode TEXT,
            ReferralCount INTEGER DEFAULT 0,
            IsBlocked INTEGER DEFAULT 0
        )",
        @"CREATE TABLE IF NOT EXISTS Deposits (
            Id INTEGER PRIMARY KEY AUTOINCREMENT,
            TelegramId INTEGER,
            Amount REAL,
            Date TEXT,
            Status TEXT DEFAULT '–û–∂–∏–¥–∞–µ—Ç'
        )",
        @"CREATE TABLE IF NOT EXISTS Withdrawals (
            Id INTEGER PRIMARY KEY AUTOINCREMENT,
            TelegramId INTEGER,
            Amount REAL,
            Date TEXT,
            Status TEXT DEFAULT '–û–∂–∏–¥–∞–µ—Ç'
        )",
        @"CREATE TABLE IF NOT EXISTS Referrals (
            Id INTEGER PRIMARY KEY AUTOINCREMENT,
            ReferrerId INTEGER,
            RefereeId INTEGER,
            Bonus REAL,
            Date TEXT
        )",
        @"CREATE TABLE IF NOT EXISTS Requisites (
            Id INTEGER PRIMARY KEY AUTOINCREMENT,
            Type TEXT,
            BankOrCoin TEXT,
            Details TEXT,
            DateAdded TEXT
        )",
        @"CREATE TABLE IF NOT EXISTS DepositProofs (
            Id INTEGER PRIMARY KEY AUTOINCREMENT,
            TelegramId INTEGER,
            DepositId INTEGER,
            FileId TEXT,
            FileType TEXT,
            Date TEXT,
            Status TEXT DEFAULT '–û–∂–∏–¥–∞–µ—Ç',
            FOREIGN KEY(DepositId) REFERENCES Deposits(Id)
        )"
    };

            foreach (var query in queries)
            {
                using var cmd = new SQLiteCommand(query, DbConnection);
                await cmd.ExecuteNonQueryAsync();
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É DepositId –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            using var checkColumnCmd = new SQLiteCommand(
                "PRAGMA table_info(DepositProofs)", DbConnection);
            using var reader = await checkColumnCmd.ExecuteReaderAsync();

            bool hasDepositId = false;
            while (await reader.ReadAsync())
            {
                if (reader.GetString(1) == "DepositId")
                {
                    hasDepositId = true;
                    break;
                }
            }

            if (!hasDepositId)
            {
                using var alterCmd = new SQLiteCommand(
                    "ALTER TABLE DepositProofs ADD COLUMN DepositId INTEGER", DbConnection);
                await alterCmd.ExecuteNonQueryAsync();
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É IsBlocked –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            using var checkBlockedColumnCmd = new SQLiteCommand(
                "PRAGMA table_info(Users)", DbConnection);
            using var blockedReader = await checkBlockedColumnCmd.ExecuteReaderAsync();

            bool hasBlockedColumn = false;
            while (await blockedReader.ReadAsync())
            {
                if (blockedReader.GetString(1) == "IsBlocked")
                {
                    hasBlockedColumn = true;
                    break;
                }
            }

            if (!hasBlockedColumn)
            {
                using var alterBlockedCmd = new SQLiteCommand(
                    "ALTER TABLE Users ADD COLUMN IsBlocked INTEGER DEFAULT 0", DbConnection);
                await alterBlockedCmd.ExecuteNonQueryAsync();
            }
        }

        private static async Task RegisterUserAsync(long chatId, string username)
        {
            using var checkCmd = new SQLiteCommand("SELECT COUNT(*) FROM Users WHERE TelegramId = @id", DbConnection);
            checkCmd.Parameters.AddWithValue("@id", chatId);
            var exists = (long)await checkCmd.ExecuteScalarAsync() > 0;

            if (!exists)
            {
                string referralCode;
                do
                {
                    referralCode = Guid.NewGuid().ToString().Substring(0, 8);
                    using var codeCheckCmd = new SQLiteCommand("SELECT COUNT(*) FROM Users WHERE ReferralCode = @code", DbConnection);
                    codeCheckCmd.Parameters.AddWithValue("@code", referralCode);
                    var codeExists = (long)await codeCheckCmd.ExecuteScalarAsync() > 0;
                    if (!codeExists) break;
                } while (true);

                using var cmd = new SQLiteCommand(
                    "INSERT INTO Users (TelegramId, Username, ReferralCode) VALUES (@id, @username, @code)", DbConnection);
                cmd.Parameters.AddWithValue("@id", chatId);
                cmd.Parameters.AddWithValue("@username", username);
                cmd.Parameters.AddWithValue("@code", referralCode);
                await cmd.ExecuteNonQueryAsync();
            }
            else
            {
                await UpdateUsernameAsync(chatId, username);
            }
        }
        private static async Task UpdateUserStatusAsync(long telegramId)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞
                decimal totalDeposit = 0;
                using (var cmd = new SQLiteCommand(
                    "SELECT SUM(Amount) FROM Deposits WHERE TelegramId = @id AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", telegramId);
                    var result = await cmd.ExecuteScalarAsync();
                    totalDeposit = result is DBNull ? 0 : Convert.ToDecimal(result);
                }

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                int referralCount = 0;
                using (var cmd = new SQLiteCommand(
                    "SELECT COUNT(*) FROM Referrals WHERE ReferrerId = @id",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", telegramId);
                    referralCount = Convert.ToInt32(await cmd.ExecuteScalarAsync());
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                string status;
                if (totalDeposit >= 100000 && referralCount >= 10)
                {
                    status = "–ö–∏—Ç";
                }
                else if (totalDeposit >= 50000 || referralCount >= 5)
                {
                    status = "–ü—Ä–æ—Ñ–∏";
                }
                else
                {
                    status = "–ù–æ–≤–∏—á–æ–∫";
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ
                using (var cmd = new SQLiteCommand(
                    "UPDATE Users SET Status = @status WHERE TelegramId = @id",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@status", status);
                    cmd.Parameters.AddWithValue("@id", telegramId);
                    await cmd.ExecuteNonQueryAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è {telegramId}: {ex}");
            }
        }
        private static async Task UpdateUsernameAsync(long chatId, string username)
        {
            using var cmd = new SQLiteCommand(
                "UPDATE Users SET Username = @username WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@username", username);
            cmd.Parameters.AddWithValue("@id", chatId);
            await cmd.ExecuteNonQueryAsync();
        }

        private static async Task<string> GetReferralCodeAsync(long chatId)
        {
            using var cmd = new SQLiteCommand("SELECT ReferralCode FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var result = await cmd.ExecuteScalarAsync();
            return result?.ToString() ?? string.Empty;
        }

        private static async Task<string> GetUsernameAsync(long chatId)
        {
            using var cmd = new SQLiteCommand("SELECT Username FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var result = await cmd.ExecuteScalarAsync();
            return result?.ToString() ?? "–ù–µ —É–∫–∞–∑–∞–Ω";
        }

        private static async Task<int> GetReferralCountAsync(long telegramId)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT COUNT(*) FROM Referrals WHERE ReferrerId = @id",
                    DbConnection);
                cmd.Parameters.AddWithValue("@id", telegramId);
                var result = await cmd.ExecuteScalarAsync();
                return Convert.ToInt32(result);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–ª—è {telegramId}: {ex}");
                return 0;
            }
        }

        private static async Task<(decimal deposit, decimal interest, string status)> GetUserInfoAsync(long chatId)
        {
            using var cmd = new SQLiteCommand(
                "SELECT Deposit, Interest, Status FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                return (reader.GetDecimal(0), reader.GetDecimal(1), reader.GetString(2));
            }
            return (0, 0, "–ù–æ–≤–∏—á–æ–∫");
        }

        private static async Task<DateTime?> GetLastDepositDateAsync(long chatId)
        {
            using var cmd = new SQLiteCommand(
                "SELECT Date FROM Deposits WHERE TelegramId = @id AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' ORDER BY Date DESC LIMIT 1",
                DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var result = await cmd.ExecuteScalarAsync();
            return result != null ? DateTime.Parse(result.ToString()) : (DateTime?)null;
        }

        private static async Task<Requisite> GetRequisiteByIdAsync(int id)
        {
            using var cmd = new SQLiteCommand("SELECT * FROM Requisites WHERE Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", id);
            using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                return new Requisite
                {
                    Id = reader.GetInt32(0),
                    Type = reader.GetString(1),
                    BankOrCoin = reader.GetString(2),
                    Details = reader.GetString(3),
                    DateAdded = DateTime.Parse(reader.GetString(4))
                };
            }
            return null;
        }

        private static async Task<List<Requisite>> GetAllRequisitesAsync()
        {
            var requisites = new List<Requisite>();
            using var cmd = new SQLiteCommand("SELECT * FROM Requisites ORDER BY DateAdded DESC", DbConnection);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                requisites.Add(new Requisite
                {
                    Id = reader.GetInt32(0),
                    Type = reader.GetString(1),
                    BankOrCoin = reader.GetString(2),
                    Details = reader.GetString(3),
                    DateAdded = DateTime.Parse(reader.GetString(4))
                });
            }
            return requisites;
        }

        private static async Task<Deposit> GetDepositByIdAsync(int id)
        {
            using var cmd = new SQLiteCommand(
                "SELECT d.Id, d.TelegramId, u.Username, d.Amount, d.Date, d.Status " +
                "FROM Deposits d LEFT JOIN Users u ON d.TelegramId = u.TelegramId " +
                "WHERE d.Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", id);
            using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                return new Deposit
                {
                    Id = reader.GetInt32(0),
                    UserId = reader.GetInt64(1),
                    Username = reader.IsDBNull(2) ? "N/A" : reader.GetString(2),
                    Amount = reader.GetDecimal(3),
                    Date = DateTime.Parse(reader.GetString(4)),
                    Status = reader.GetString(5)
                };
            }
            return null;
        }

        private static async Task<List<Deposit>> GetPendingDepositsAsync()
        {
            var deposits = new List<Deposit>();
            using var cmd = new SQLiteCommand(
                "SELECT d.Id, d.TelegramId, u.Username, d.Amount, d.Date, d.Status " +
                "FROM Deposits d LEFT JOIN Users u ON d.TelegramId = u.TelegramId " +
                "WHERE d.Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY d.Date", DbConnection);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                deposits.Add(new Deposit
                {
                    Id = reader.GetInt32(0),
                    UserId = reader.GetInt64(1),
                    Username = reader.IsDBNull(2) ? "N/A" : reader.GetString(2),
                    Amount = reader.GetDecimal(3),
                    Date = DateTime.Parse(reader.GetString(4)),
                    Status = reader.GetString(5)
                });
            }
            return deposits;
        }

        private static async Task<List<Withdrawal>> GetPendingWithdrawalsAsync()
        {
            var withdrawals = new List<Withdrawal>();
            using var cmd = new SQLiteCommand(
                "SELECT w.Id, w.TelegramId, u.Username, w.Amount, w.Date, w.Status " +
                "FROM Withdrawals w LEFT JOIN Users u ON w.TelegramId = u.TelegramId " +
                "WHERE w.Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY w.Date", DbConnection);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                withdrawals.Add(new Withdrawal
                {
                    Id = reader.GetInt32(0),
                    UserId = reader.GetInt64(1),
                    Username = reader.IsDBNull(2) ? "N/A" : reader.GetString(2),
                    Amount = reader.GetDecimal(3),
                    Date = DateTime.Parse(reader.GetString(4)),
                    Status = reader.GetString(5)
                });
            }
            return withdrawals;
        }

        private static async Task RegisterReferralAsync(long chatId, string referrerCode)
        {
            using var selfCheckCmd = new SQLiteCommand(
                "SELECT COUNT(*) FROM Users WHERE TelegramId = @id AND ReferralCode = @code", DbConnection);
            selfCheckCmd.Parameters.AddWithValue("@id", chatId);
            selfCheckCmd.Parameters.AddWithValue("@code", referrerCode);
            if ((long)await selfCheckCmd.ExecuteScalarAsync() > 0) return;

            using var existingCheckCmd = new SQLiteCommand(
                "SELECT COUNT(*) FROM Referrals WHERE RefereeId = @id", DbConnection);
            existingCheckCmd.Parameters.AddWithValue("@id", chatId);
            if ((long)await existingCheckCmd.ExecuteScalarAsync() > 0) return;

            using var cmd = new SQLiteCommand(
                "SELECT TelegramId FROM Users WHERE ReferralCode = @code", DbConnection);
            cmd.Parameters.AddWithValue("@code", referrerCode);
            var referrerId = await cmd.ExecuteScalarAsync();

            if (referrerId != null && (long)referrerId != chatId)
            {
                using var insertCmd = new SQLiteCommand(
                    "INSERT INTO Referrals (ReferrerId, RefereeId, Bonus, Date) VALUES (@referrer, @referee, @bonus, @date)", DbConnection);
                insertCmd.Parameters.AddWithValue("@referrer", referrerId);
                insertCmd.Parameters.AddWithValue("@referee", chatId);
                insertCmd.Parameters.AddWithValue("@bonus", 0); // Initialize Bonus to 0
                insertCmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                await insertCmd.ExecuteNonQueryAsync();

                using var updateCmd = new SQLiteCommand(
                    "UPDATE Users SET ReferralCount = ReferralCount + 1 WHERE TelegramId = @id", DbConnection);
                updateCmd.Parameters.AddWithValue("@id", referrerId);
                await updateCmd.ExecuteNonQueryAsync();

                try
                {
                    await BotClient.SendMessage(
                        chatId: (long)referrerId,
                        text: $"üéâ –ù–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ! ID: {chatId}",
                        parseMode: ParseMode.Html,
                        cancellationToken: CancellationToken.None);
                }
                catch { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ */ }
            }
        }

        private static async Task DeleteRequisiteAsync(int id)
        {
            using var cmd = new SQLiteCommand("DELETE FROM Requisites WHERE Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", id);
            await cmd.ExecuteNonQueryAsync();
        }

        #endregion

        #region Message Handlers

        private static async Task HandleUpdateAsync(ITelegramBotClient botClient, Update update, CancellationToken cancellationToken)
        {
            try
            {
                if (update.Message != null)
                {
                    await HandleMessageAsync(botClient, update.Message, cancellationToken);
                }
                else if (update.CallbackQuery != null)
                {
                    await HandleCallbackQueryAsync(botClient, update.CallbackQuery, cancellationToken);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {ex}");
            }
        }

        private static async Task HandleMessageAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
            var chatId = message.Chat.Id;
            var text = message.Text?.Trim() ?? "";
            var messageId = message.MessageId;
            var username = message.From?.Username ?? "–ù–µ —É–∫–∞–∑–∞–Ω";
            using var cmd = new SQLiteCommand("SELECT IsBlocked FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var isBlocked = await cmd.ExecuteScalarAsync();
            if (isBlocked != null && Convert.ToInt32(isBlocked) == 1)
            {
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>üîí –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
                return;
            }

            await UpdateUsernameAsync(chatId, username);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ (—á–µ–∫–æ–≤)
            if (message.Document != null || message.Photo != null)
            {
                if (UserStates.TryGetValue(chatId, out var depositState) && depositState == "waiting_deposit_proof")
                {
                    await HandleDepositProofAsync(chatId, message, cancellationToken);
                    return;
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (–≤—Å–µ–≥–¥–∞ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
            if (UserStates.TryGetValue(chatId, out var state))
            {
                switch (state)
                {
                    case "waiting_block_user" when AdminIds.Contains(chatId):
                        await ProcessBlockUserAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_unblock_user" when AdminIds.Contains(chatId):
                        await ProcessUnblockUserAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_cancel_deposit" when AdminIds.Contains(chatId):
                        await ProcessCancelDepositAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_requisite":
                        await ProcessRequisiteAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case var currentState when currentState.StartsWith("editing_requisite_"):
                        await ProcessEditRequisiteAsync(chatId, text, messageId, currentState, cancellationToken);
                        break;
                    case "waiting_deposit":
                        await ProcessDepositAsync(text, chatId, messageId, cancellationToken);
                        break;
                    case "waiting_withdrawal":
                        await ProcessWithdrawAsync(text, chatId, messageId, cancellationToken);
                        break;
                    case "waiting_confirm_deposit" when AdminIds.Contains(chatId):
                        await ProcessConfirmDepositAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_confirm_withdrawal" when AdminIds.Contains(chatId):
                        await ProcessConfirmWithdrawalAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_calculator_custom":
                        await ProcessCalculatorCustomAsync(chatId, text, messageId, cancellationToken);
                        break;
                    default:
                        await EditOrSendMessageAsync(
                            botClient, chatId, messageId,
                            "<b>‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</b> –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
                            GetMainMenuKeyboard(), cancellationToken, "error_state", ParseMode.Html);
                        UserStates.Remove(chatId);
                        break;
                }
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
            InlineKeyboardMarkup keyboard;
            if (AdminIds.Contains(chatId) && text == "/admin")
            {
                keyboard = GetAdminMenuKeyboard();
                await EditOrSendMessageAsync(botClient, chatId, messageId,
                    "<b>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>", keyboard, cancellationToken, "admin_menu", ParseMode.Html);
            }
            else if (text == "/start" || text.StartsWith("/start "))
            {
                await RegisterUserAsync(chatId, username);
                if (text.StartsWith("/start ") && text.Length > 7)
                {
                    var referrerCode = text.Substring(7).Trim();
                    await RegisterReferralAsync(chatId, referrerCode);
                }
                keyboard = GetMainMenuKeyboard();
                await EditOrSendMessageAsync(botClient, chatId, messageId,
                    "<b>üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FAST INVEST!</b>", keyboard, cancellationToken, "start", ParseMode.Html);
            }
            else
            {
                keyboard = GetMainMenuKeyboard();
                await EditOrSendMessageAsync(botClient, chatId, messageId,
                    "<b>üîç –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:</b>", keyboard, cancellationToken, "main_menu", ParseMode.Html);
            }
        }

        private static async Task HandleCallbackQueryAsync(ITelegramBotClient botClient, CallbackQuery callbackQuery, CancellationToken cancellationToken)
        {
            var chatId = callbackQuery.Message.Chat.Id;
            var messageId = callbackQuery.Message.MessageId;
            var data = callbackQuery.Data;
            var username = callbackQuery.From.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";

            using var cmd = new SQLiteCommand("SELECT IsBlocked FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var isBlocked = await cmd.ExecuteScalarAsync();
            if (isBlocked != null && Convert.ToInt32(isBlocked) == 1)
            {
                await botClient.AnswerCallbackQuery(
                    callbackQueryId: callbackQuery.Id,
                    text: "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    showAlert: true,
                    cancellationToken: cancellationToken);
                return;
            }
            try
            {
                Console.WriteLine($"Callback –æ—Ç {username} ({chatId}): {data}");

                // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —á–∞—Å–∏–∫–∏
                await botClient.AnswerCallbackQuery(
                    callbackQueryId: callbackQuery.Id,
                    cancellationToken: cancellationToken);

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
                if (LastCallbackData.TryGetValue(chatId, out var lastData) && lastData.Data == data && (DateTime.UtcNow - lastData.Timestamp).TotalSeconds < 2)
                {
                    return;
                }
                LastCallbackData[chatId] = (data, DateTime.UtcNow);

                InlineKeyboardMarkup keyboard = null;
                string text = null;
                bool forceNewMessage = false;

                switch (data)
                {
                    case "main_menu":
                        UserStates.Remove(chatId);
                        keyboard = GetMainMenuKeyboard();
                        text = "<b>üöÄ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";

                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º messageId –∏–∑ callback, –µ—Å–ª–∏ LastMessageIds –ø—É—Å—Ç
                        if (!LastMessageIds.TryGetValue(chatId, out var mainMenuId) || mainMenuId <= 0)
                        {
                            mainMenuId = messageId;
                            LastMessageIds[chatId] = messageId;
                            Console.WriteLine($"LastMessageIds –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ID –¥–ª—è {chatId}, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º messageId: {messageId}");
                        }

                        await EditOrSendMessageAsync(
                            botClient, chatId, mainMenuId,
                            text, keyboard, cancellationToken, "main_menu", ParseMode.Html, forceNewMessage: false);
                        break;

                    case "my_deposit":
                        await ShowDepositPageAsync(botClient, chatId, messageId, cancellationToken);
                        return;

                    case "deposit":
                    case "add_deposit":
                        UserStates[chatId] = "waiting_deposit";
                        keyboard = new InlineKeyboardMarkup(
                            InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit"));
                        text = data == "add_deposit"
                            ? "<b>üí∏ –î–æ–≤–Ω–µ—Å–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –¥–æ–≤–Ω–µ—Å–µ–Ω–∏—è:"
                            : "<b>üí≥ –í–Ω–µ—Å–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n\n–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 10,000 ‚ÇΩ\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞:";
                        forceNewMessage = true;
                        break;

                    case "withdraw":
                        if (await CanWithdrawAsync(chatId))
                        {
                            UserStates[chatId] = "waiting_withdrawal";
                            keyboard = new InlineKeyboardMarkup(
                                InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit"));
                            text = "<b>üí∞ –ó–∞–ø—Ä–æ—Å –≤—ã–≤–æ–¥–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–∞:";
                            forceNewMessage = true;
                        }
                        else
                        {
                            await botClient.AnswerCallbackQuery(
                                callbackQuery.Id,
                                "–í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞",
                                cancellationToken: cancellationToken);
                            return;
                        }
                        break;

                    case "withdraw_disabled":
                        await botClient.AnswerCallbackQuery(
                            callbackQuery.Id,
                            "–í—ã–≤–æ–¥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞",
                            cancellationToken: cancellationToken);
                        return;

                    case "balance":
                        await UpdateUserStatusAsync(chatId);

                        // –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤
                        decimal totalDeposit = 0;
                        using (var depositCmd = new SQLiteCommand(
                            "SELECT SUM(Amount) FROM Deposits WHERE TelegramId = @id AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'",
                            DbConnection))
                        {
                            depositCmd.Parameters.AddWithValue("@id", chatId);
                            var result = await depositCmd.ExecuteScalarAsync(cancellationToken);
                            totalDeposit = result is DBNull ? 0 : Convert.ToDecimal(result);
                            Console.WriteLine($"[Balance] TotalDeposit for chatId {chatId}: {totalDeposit:F2}");
                        }

                        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏ —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        decimal totalInterest = 0;
                        string userStatus = "–ù–æ–≤–∏—á–æ–∫";
                        using (var userCmd = new SQLiteCommand(
                            "SELECT Interest, Status FROM Users WHERE TelegramId = @id",
                            DbConnection))
                        {
                            userCmd.Parameters.AddWithValue("@id", chatId);
                            using var reader = await userCmd.ExecuteReaderAsync(cancellationToken);
                            if (await reader.ReadAsync())
                            {
                                totalInterest = reader.GetDecimal(0);
                                userStatus = reader.GetString(1);
                            }
                            else
                            {
                                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É
                                await EditOrSendMessageAsync(
                                    botClient, chatId, messageId,
                                    "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.",
                                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu")),
                                    cancellationToken, "balance_error", ParseMode.Html, forceNewMessage: true);
                                break;
                            }
                        }

                        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        int referralCount = await GetReferralCountAsync(chatId);
                        username = await GetUsernameAsync(chatId) ?? chatId.ToString();
                        decimal weeklyRate = totalDeposit >= 50000 ? 0.06m : 0.05m;
                        decimal referralBonusRate = referralCount >= 5 ? 0.02m : 0.01m;

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏ —Å—Ç–∞—Ç—É—Å–∞
                        string statusEmoji = userStatus switch
                        {
                            "–ù–æ–≤–∏—á–æ–∫" => "üê£",
                            "–ü—Ä–æ—Ñ–∏" => "ü¶Å",
                            "–ö–∏—Ç" => "üê≥",
                            _ => "‚ùì"
                        };

                        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                        string progressText;
                        string progressBar;
                        int progressPercent;
                        if (userStatus == "–ö–∏—Ç")
                        {
                            progressText = "üéâ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!";
                            progressBar = string.Concat(Enumerable.Repeat("üü¢", 10));
                            progressPercent = 100;
                        }
                        else if (userStatus == "–ü—Ä–æ—Ñ–∏")
                        {
                            decimal depositNeeded = 100000 - totalDeposit;
                            int referralsNeeded = 10 - referralCount;
                            progressPercent = (int)Math.Clamp((totalDeposit / 100000m + referralCount / 10m) / 2m * 100, 0, 100);
                            progressText = $"–î–æ <b>–ö–∏—Ç–∞</b> üê≥: {(depositNeeded > 0 ? $"–≤–Ω–µ—Å–∏—Ç–µ {depositNeeded:F2} ‚ÇΩ –∏ " : "")}–ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ {referralsNeeded} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤";
                            progressBar = string.Concat(Enumerable.Repeat("üü¢", progressPercent / 10)) +
                                          string.Concat(Enumerable.Repeat("‚ö™", 10 - progressPercent / 10));
                        }
                        else
                        {
                            decimal depositNeeded = 50000 - totalDeposit;
                            int referralsNeeded = 5 - referralCount;
                            progressPercent = (int)Math.Clamp(Math.Max(totalDeposit / 50000m * 50, referralCount / 5m * 50), 0, 100);
                            progressText = $"–î–æ <b>–ü—Ä–æ—Ñ–∏</b> ü¶Å: {(depositNeeded > 0 ? $"–≤–Ω–µ—Å–∏—Ç–µ {depositNeeded:F2} ‚ÇΩ –∏–ª–∏ " : "")}–ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ {referralsNeeded} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤";
                            progressBar = string.Concat(Enumerable.Repeat("üü¢", progressPercent / 10)) +
                                          string.Concat(Enumerable.Repeat("‚ö™", 10 - progressPercent / 10));
                        }

                        Console.WriteLine($"[Balance] ProgressPercent for chatId {chatId}: {progressPercent}%");

                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        text = $"""
                            <b>üë§ –ü—Ä–æ—Ñ–∏–ª—å</b>

                            üßë <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: @{HtmlEscape(username)}
                            <b>–°—Ç–∞—Ç—É—Å</b>: {HtmlEscape(userStatus)} {statusEmoji}
                            üìä <b>–î–µ–ø–æ–∑–∏—Ç</b>: {totalDeposit:F2} ‚ÇΩ
                            üíµ <b>–ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã</b>: {totalInterest:F2} ‚ÇΩ
                            üë• <b>–†–µ—Ñ–µ—Ä–∞–ª—ã</b>: {referralCount}
                            üìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞</b>: {(weeklyRate * 100):F1}% –≤ –Ω–µ–¥–µ–ª—é
                            üéÅ <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å</b>: {(referralBonusRate * 100):F1}% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
                            üìà <b>–ü—Ä–æ–≥—Ä–µ—Å—Å ({progressPercent}%)</b>:
                            {progressText}
                                          
                            <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>
                            """;

                        // –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏
                        var buttons = new List<InlineKeyboardButton[]>
                        {
                            new[] { InlineKeyboardButton.WithCallbackData("ü§ù –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞", "referral") },
                            new[] { InlineKeyboardButton.WithCallbackData(totalDeposit > 0 ? "üí∏ –î–æ–≤–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç" : "üí≥ –í–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç", totalDeposit > 0 ? "add_deposit" : "deposit") },
                            new[] { InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu") }
                        };
                        keyboard = new InlineKeyboardMarkup(buttons);

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º messageId –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        int messageIdToUse = LastMessageIds.TryGetValue(chatId, out var storedMessageId) && storedMessageId > 0
                            ? storedMessageId
                            : messageId;
                        LastMessageIds[chatId] = messageIdToUse;

                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        await EditOrSendMessageAsync(
                            botClient, chatId, messageIdToUse,
                            text, keyboard, cancellationToken, "balance", ParseMode.Html, forceNewMessage: false);
                        break;
                    case "referral":
                        var referralCode = await GetReferralCodeAsync(chatId);
                        referralCount = await GetReferralCountAsync(chatId);
                        var bonusRate = referralCount >= 5 ? "2%" : "1%";
                        var bonusAmount = 10000 * (referralCount >= 5 ? 0.02m : 0.01m);

                        // –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤
                        decimal totalReferralBonus = 0;
                        using (var referralcmd = new SQLiteCommand(
                            "SELECT SUM(Bonus) FROM Referrals WHERE ReferrerId = @id",
                            DbConnection))
                        {
                            cmd.Parameters.AddWithValue("@id", chatId);
                            var result = await cmd.ExecuteScalarAsync();
                            Console.WriteLine($"–†–µ–∑—É–ª—å—Ç–∞—Ç SUM(Bonus) –¥–ª—è ReferrerId {chatId}: {result ?? "NULL"}");
                            totalReferralBonus = result is DBNull ? 0 : Convert.ToDecimal(result);
                        }

                        var referralLink = $"https://t.me/{(await botClient.GetMe()).Username}?start={Uri.EscapeDataString(referralCode)}";
                        var shareText = $"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ FAST INVEST! üöÄ\n\n" +
                                        $"–ü–æ–ª—É—á–∞–π 5% –ø—Ä–∏–±—ã–ª–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ!\n" +
                                        $"–ú–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: {referralLink}";

                        keyboard = new InlineKeyboardMarkup(new[]
                        {
                            new[] { InlineKeyboardButton.WithUrl(
                                "üì¢ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
                                $"https://t.me/share/url?url={Uri.EscapeDataString(referralLink)}&text={Uri.EscapeDataString(shareText)}") },
                            new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "main_menu") }
                        });

                                            text = $"""
                            <b>ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>
                            üë§ <b>–í–∞—à –∫–æ–¥</b>: <code>{HtmlEscape(referralCode)}</code>
                            üë• <b>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</b>: {referralCount}
                            üí∞ <b>–í–∞—à –±–æ–Ω—É—Å</b>: {HtmlEscape(bonusRate)} –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ –¥—Ä—É–≥–∞
                            üí∏ <b>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</b>: {totalReferralBonus:F2} ‚ÇΩ
                            üéÅ <b>–ü—Ä–∏–º–µ—Ä</b>: –∑–∞ –¥–µ–ø–æ–∑–∏—Ç 10,000 ‚ÇΩ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ {bonusAmount:F2} ‚ÇΩ
                            üîó <b>–í–∞—à–∞ —Å—Å—ã–ª–∫–∞</b>: <code>{HtmlEscape(referralLink)}</code>
                            """;
                        break;

                    case "calculator":
                        keyboard = new InlineKeyboardMarkup(new[]
                        {
                    new[] { InlineKeyboardButton.WithCallbackData("10,000 ‚ÇΩ", "calc_10000"),
                            InlineKeyboardButton.WithCallbackData("50,000 ‚ÇΩ", "calc_50000"),
                            InlineKeyboardButton.WithCallbackData("100,000 ‚ÇΩ", "calc_100000") },
                    new[] { InlineKeyboardButton.WithCallbackData("1 –Ω–µ–¥–µ–ª—è", "calc_1week"),
                            InlineKeyboardButton.WithCallbackData("4 –Ω–µ–¥–µ–ª–∏", "calc_4week"),
                            InlineKeyboardButton.WithCallbackData("12 –Ω–µ–¥–µ–ª—å", "calc_12week") },
                    new[] { InlineKeyboardButton.WithCallbackData("‚úçÔ∏è –í–≤–µ—Å—Ç–∏ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ", "calc_custom") },
                    new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "main_menu") }
                });
                        text = "<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞, —Å—Ä–æ–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ:";
                        break;

                    case "calc_10000":
                    case "calc_50000":
                    case "calc_100000":
                        var amount = data switch { "calc_10000" => 10000m, "calc_50000" => 50000m, "calc_100000" => 100000m, _ => 10000m };
                        UserStates[chatId] = $"waiting_calculator_amount_{amount}";
                        keyboard = new InlineKeyboardMarkup(new[]
                        {
                    new[] { InlineKeyboardButton.WithCallbackData("1 –Ω–µ–¥–µ–ª—è", "calc_1week"),
                            InlineKeyboardButton.WithCallbackData("4 –Ω–µ–¥–µ–ª–∏", "calc_4week"),
                            InlineKeyboardButton.WithCallbackData("12 –Ω–µ–¥–µ–ª—å", "calc_12week") },
                    new[] { InlineKeyboardButton.WithCallbackData("‚úçÔ∏è –í–≤–µ—Å—Ç–∏ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ", "calc_custom") },
                    new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") }
                });
                        text = $"<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏</b>\n\n–í—ã–±—Ä–∞–Ω–∞ —Å—É–º–º–∞: {amount:F2} ‚ÇΩ\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ:";
                        break;

                    case "calc_1week":
                    case "calc_4week":
                    case "calc_12week":
                        if (!UserStates.TryGetValue(chatId, out var calcState) || !calcState.StartsWith("waiting_calculator_amount_"))
                        {
                            keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") });
                            text = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞.";
                            break;
                        }

                        var calcAmount = decimal.Parse(calcState.Replace("waiting_calculator_amount_", ""));
                        var weeks = data switch { "calc_1week" => 1, "calc_4week" => 4, "calc_12week" => 12, _ => 1 };
                        var resultText = await CalculateProfitAsync(calcAmount, weeks);

                        keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") });
                        text = resultText;
                        UserStates.Remove(chatId);
                        break;

                    case "calc_custom":
                        UserStates[chatId] = "waiting_calculator_custom";
                        keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") });
                        text = "<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏</b>\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä: 15000 8):";
                        forceNewMessage = true;
                        break;

                    case "requisites_menu":
                        await ShowRequisitesMenuAsync(chatId, messageId, cancellationToken);
                        return;

                    case "add_requisite":
                        UserStates[chatId] = "waiting_requisite";
                        keyboard = new InlineKeyboardMarkup(
                            InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "requisites_menu"));
                        text = """
                    <b>üìã –í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:</b>
                    ‚Ä¢ –î–ª—è –∫–∞—Ä—Ç—ã: <code>card|–ë–∞–Ω–∫|–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</code>
                    ‚Ä¢ –î–ª—è –∫—Ä–∏–ø—Ç—ã: <code>crypto|–ú–æ–Ω–µ—Ç–∞|–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞</code>
                    –ü—Ä–∏–º–µ—Ä: <code>card|–°–±–µ—Ä–±–∞–Ω–∫|1234 5678 9012 3456</code>
                    """;
                        forceNewMessage = true;
                        break;

                    case var reqCase when reqCase.StartsWith("requisite_detail_"):
                        if (int.TryParse(reqCase.Split('_')[2], out int reqId))
                        {
                            await ShowRequisiteDetailsAsync(chatId, messageId, reqId, cancellationToken);
                        }
                        return;

                    case var editCase when editCase.StartsWith("edit_requisite_"):
                        if (int.TryParse(editCase.Split('_')[2], out int editId))
                        {
                            UserStates[chatId] = $"editing_requisite_{editId}";
                            var req = await GetRequisiteByIdAsync(editId);
                            keyboard = new InlineKeyboardMarkup(
                                InlineKeyboardButton.WithCallbackData("üîô –û—Ç–º–µ–Ω–∞", $"requisite_detail_{editId}"));
                            text = $"""
                        <b>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤</b>:
                        –¢–µ–∫—É—â–∏–µ: {HtmlEscape(req.Type)}|{HtmlEscape(req.BankOrCoin)}|{HtmlEscape(req.Details)}
                        –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
                        <code>—Ç–∏–ø|–±–∞–Ω–∫/–º–æ–Ω–µ—Ç–∞|—Ä–µ–∫–≤–∏–∑–∏—Ç—ã</code>
                        """;
                            forceNewMessage = true;
                        }
                        break;

                    case var delCase when delCase.StartsWith("delete_requisite_"):
                        if (int.TryParse(delCase.Split('_')[2], out int delId))
                        {
                            await DeleteRequisiteAsync(delId);
                            await ShowRequisitesMenuAsync(chatId, messageId, cancellationToken);
                        }
                        return;

                    case "deposits_list":
                        await ShowDepositsListAsync(chatId, messageId, cancellationToken);
                        return;

                    case var depCase when depCase.StartsWith("confirm_deposit_"):
                        if (int.TryParse(depCase.Split('_')[2], out int depositId))
                        {
                            await ConfirmDepositAsync(chatId, depositId, messageId, cancellationToken);
                        }
                        return;

                    case "withdrawals_list":
                        await ShowWithdrawalsListAsync(botClient, chatId, messageId, cancellationToken);
                        return;

                    case var wCase when wCase.StartsWith("confirm_withdrawal_"):
                        if (int.TryParse(wCase.Split('_')[2], out int withdrawalId))
                        {
                            await ConfirmWithdrawalAsync(chatId, withdrawalId.ToString(), messageId, cancellationToken);
                        }
                        return;

                    case "pending_proofs":
                        await ShowPendingProofsAsync(botClient, chatId, messageId, cancellationToken);
                        return;

                    case "view_deposits":
                        await ViewDepositsAsync(botClient, chatId, messageId, cancellationToken);
                        return;

                    case "view_withdrawals":
                        await ViewWithdrawalsAsync(botClient, chatId, messageId, cancellationToken);
                        return;

                    case "view_referrals":
                        await ViewReferralsAsync(botClient, chatId, messageId, cancellationToken);
                        return;

                    case "confirm_deposit":
                        UserStates[chatId] = "waiting_confirm_deposit";
                        keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") });
                        text = "<b>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –¥–µ–ø–æ–∑–∏—Ç–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:";
                        forceNewMessage = true;
                        break;

                    case "confirm_withdrawal":
                        UserStates[chatId] = "waiting_confirm_withdrawal";
                        keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") });
                        text = "<b>üí∏ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –≤—ã–≤–æ–¥–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:";
                        forceNewMessage = true;
                        break;

                    case "admin_menu":
                        keyboard = GetAdminMenuKeyboard();
                        text = "<b>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";
                        UserStates.Remove(chatId);
                        break;
                    case "block_user":
                        UserStates[chatId] = "waiting_block_user";
                        keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") });
                        text = "<b>üîí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:";
                        forceNewMessage = true;
                        break;

                    case "unblock_user":
                        UserStates[chatId] = "waiting_unblock_user";
                        keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") });
                        text = "<b>üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:";
                        forceNewMessage = true;
                        break;
                    case "cancel_deposit":
                        UserStates.Remove(chatId);
                        keyboard = GetMainMenuKeyboard();
                        text = "<b>üöÄ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:";
                        break;
                    case "cancel_deposit_admin":
                        UserStates[chatId] = "waiting_cancel_deposit";
                        keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") });
                        text = "<b>‚ùå –û—Ç–º–µ–Ω–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –¥–µ–ø–æ–∑–∏—Ç–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã:";
                        forceNewMessage = true;
                        break;

                    default:
                        keyboard = GetMainMenuKeyboard();
                        text = "‚ö† –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                        break;
                }

                if (keyboard != null && text != null)
                {
                    await EditOrSendMessageAsync(
                        botClient, chatId, messageId, text, keyboard, cancellationToken, data, ParseMode.Html, forceNewMessage);
                }
                else
                {
                    Console.WriteLine($"–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã keyboard –∏–ª–∏ text –¥–ª—è callback: {data}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {ex}");
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                    replyMarkup: GetMainMenuKeyboard(),
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
        }

        private static async Task HandleDepositProofAsync(long chatId, Message message, CancellationToken cancellationToken)
        {
            try
            {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞
                if (message.Document == null && message.Photo == null)
                {
                    await EditOrSendMessageAsync(
                        BotClient, chatId, message.MessageId,
                        "‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JPEG, PNG –∏–ª–∏ PDF.",
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")),
                        cancellationToken, "deposit_proof_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º fileId, —Ç–∏–ø —Ñ–∞–π–ª–∞ –∏ —Ä–∞–∑–º–µ—Ä
                string fileId;
                string fileType;
                long? fileSize;

                if (message.Document != null)
                {
                    var validExtensions = new[] { ".pdf", ".jpg", ".jpeg", ".png" };
                    var fileExt = Path.GetExtension(message.Document.FileName)?.ToLower();

                    if (fileExt == null || !validExtensions.Contains(fileExt))
                    {
                        await EditOrSendMessageAsync(
                            BotClient, chatId, message.MessageId,
                            "‚ùå –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF, JPEG –∏–ª–∏ PNG.",
                            new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")),
                            cancellationToken, "deposit_proof_format_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
                        return;
                    }

                    fileId = message.Document.FileId;
                    fileType = "document";
                    fileSize = message.Document.FileSize;
                }
                else
                {
                    var photoSize = message.Photo!.OrderByDescending(p => p.FileSize).First();
                    fileId = photoSize.FileId;
                    fileType = "photo";
                    fileSize = photoSize.FileSize;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 50 –ú–ë –¥–ª—è Telegram Bot API)
                if (fileSize > 50 * 1024 * 1024)
                {
                    await EditOrSendMessageAsync(
                        BotClient, chatId, message.MessageId,
                        "‚ùå –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.",
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")),
                        cancellationToken, "deposit_proof_size_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
                    return;
                }

                // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                using var transaction = DbConnection.BeginTransaction();
                try
                {
                    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–∂–∏–¥–∞—é—â–∏–π –¥–µ–ø–æ–∑–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    int depositId;
                    decimal amount;

                    using (var getDepositCmd = new SQLiteCommand(
                        "SELECT Id, Amount FROM Deposits WHERE TelegramId = @id AND Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY Date DESC LIMIT 1",
                        DbConnection))
                    {
                        getDepositCmd.Parameters.AddWithValue("@id", chatId);
                        using var reader = await getDepositCmd.ExecuteReaderAsync(cancellationToken);
                        if (!reader.HasRows)
                        {
                            await EditOrSendMessageAsync(
                                BotClient, chatId, message.MessageId,
                                "‚ö† –ù–µ –Ω–∞–π–¥–µ–Ω –æ–∂–∏–¥–∞—é—â–∏–π –¥–µ–ø–æ–∑–∏—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–Ω–æ–≤–æ.",
                                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu")),
                                cancellationToken, "deposit_proof_no_deposit", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
                            UserStates.Remove(chatId);
                            return;
                        }

                        await reader.ReadAsync();
                        depositId = reader.GetInt32(0);
                        amount = reader.GetDecimal(1);
                    }

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ–∫ –≤ –±–∞–∑—É
                    using (var insertCmd = new SQLiteCommand(
                        "INSERT INTO DepositProofs (TelegramId, DepositId, FileId, FileType, Date, Status) " +
                        "VALUES (@id, @depositId, @fileId, @type, @date, '–û–∂–∏–¥–∞–µ—Ç')",
                        DbConnection))
                    {
                        insertCmd.Parameters.AddWithValue("@id", chatId);
                        insertCmd.Parameters.AddWithValue("@depositId", depositId);
                        insertCmd.Parameters.AddWithValue("@fileId", fileId);
                        insertCmd.Parameters.AddWithValue("@type", fileType);
                        insertCmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                        await insertCmd.ExecuteNonQueryAsync(cancellationToken);
                    }

                    transaction.Commit();

                    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    var username = await GetUsernameAsync(chatId);
                    var caption = $"–ß–µ–∫ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç {amount:F2} ‚ÇΩ –æ—Ç {username} (ID: {chatId}, –î–µ–ø–æ–∑–∏—Ç ID: {depositId})";

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
                    foreach (var adminId in AdminIds)
                    {
                        try
                        {
                            await BotClient.SendMessage(
                                chatId: adminId,
                                text: $"üîî –ù–æ–≤—ã–π —á–µ–∫ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç {amount:F2} ‚ÇΩ –æ—Ç {username} (ID: {chatId})",
                                cancellationToken: cancellationToken);

                            if (fileType == "document")
                            {
                                await BotClient.SendDocument(
                                    chatId: adminId,
                                    document: new InputFileId(fileId),
                                    caption: caption,
                                    cancellationToken: cancellationToken);
                            }
                            else
                            {
                                await BotClient.SendPhoto(
                                    chatId: adminId,
                                    photo: new InputFileId(fileId),
                                    caption: caption,
                                    cancellationToken: cancellationToken);
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ {adminId}: {ex}");
                        }
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    var sentMessage = await EditOrSendMessageAsync(
                        BotClient, chatId, message.MessageId,
                        $"‚úÖ –ß–µ–∫ –Ω–∞ —Å—É–º–º—É {amount:F2} ‚ÇΩ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!\n–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu")),
                        cancellationToken, "deposit_proof_success", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: false);

                    // –û–±–Ω–æ–≤–ª—è–µ–º LastMessageIds
                    LastMessageIds[chatId] = sentMessage.MessageId;

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    UserStates.Remove(chatId);
                }
                catch (Exception)
                {
                    transaction.Rollback();
                    throw;
                }
            }
            catch (SQLiteException ex)
            {
                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–∞: {ex}");
                var sentMessage = await EditOrSendMessageAsync(
                    BotClient, chatId, message.MessageId,
                    "‚ö† –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu")),
                    cancellationToken, "deposit_proof_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: false);
                LastMessageIds[chatId] = sentMessage.MessageId;
                UserStates.Remove(chatId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ–∫–∞: {ex}");
                var sentMessage = await EditOrSendMessageAsync(
                    BotClient, chatId, message.MessageId,
                    "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu")),
                    cancellationToken, "deposit_proof_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: false);
                LastMessageIds[chatId] = sentMessage.MessageId;
                UserStates.Remove(chatId);
            }
        }

        #endregion

        #region Menu Methods

        private static InlineKeyboardMarkup GetMainMenuKeyboard()
        {
            return new InlineKeyboardMarkup(new[]
            {
                new[] { InlineKeyboardButton.WithCallbackData("üí∞ –ú–æ–π –¥–µ–ø–æ–∑–∏—Ç", "my_deposit") },
                new[] { InlineKeyboardButton.WithCallbackData("ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞", "referral") },
                new[] { InlineKeyboardButton.WithCallbackData("üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏", "calculator") },
                new[] { InlineKeyboardButton.WithCallbackData("üë§ –ü—Ä–æ—Ñ–∏–ª—å", "balance") }
            });
        }

        private static InlineKeyboardMarkup GetAdminMenuKeyboard()
        {
            return new InlineKeyboardMarkup(new[]
            {
                new[] { InlineKeyboardButton.WithCallbackData("üìã –†–µ–∫–≤–∏–∑–∏—Ç—ã", "requisites_menu") },
                new[] { InlineKeyboardButton.WithCallbackData("üí≥ –î–µ–ø–æ–∑–∏—Ç—ã", "deposits_list") },
                new[] { InlineKeyboardButton.WithCallbackData("üí∏ –í—ã–≤–æ–¥—ã", "withdrawals_list") },
                new[] { InlineKeyboardButton.WithCallbackData("üßæ –ß–µ–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É", "pending_proofs") },
                new[] { InlineKeyboardButton.WithCallbackData("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç", "cancel_deposit_admin") },
                new[] { InlineKeyboardButton.WithCallbackData("üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "block_user") },
                new[] { InlineKeyboardButton.WithCallbackData("üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "unblock_user") },
                new[] { InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu") }
            });
        }

        private static async Task ShowRequisitesMenuAsync(long chatId, int messageId, CancellationToken cancellationToken)
        {
            var requisites = await GetAllRequisitesAsync();
            var buttons = requisites.Select(req => new[] { InlineKeyboardButton.WithCallbackData($"{req.Type} ({req.BankOrCoin})", $"requisite_detail_{req.Id}") }).ToList();
            buttons.Add(new[] { InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å", "add_requisite"), InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") });

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                "<b>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏</b>",
                new InlineKeyboardMarkup(buttons), cancellationToken, "requisites_menu", ParseMode.Html);
        }

        private static async Task ShowRequisiteDetailsAsync(long chatId, int messageId, int reqId, CancellationToken cancellationToken)
        {
            var req = await GetRequisiteByIdAsync(reqId);
            if (req == null)
            {
                await BotClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
                return;
            }

            var message = $"""
                <b>üìã –†–µ–∫–≤–∏–∑–∏—Ç—ã</b>\n\n
                <b>–¢–∏–ø</b>: {HtmlEscape(req.Type)}\n\n
                <b>–ë–∞–Ω–∫/–ú–æ–Ω–µ—Ç–∞</b>: {HtmlEscape(req.BankOrCoin)}\n\n
                <b>–î–∞–Ω–Ω—ã–µ</b>: <code>{HtmlEscape(req.Details)}</code>\n\n
                <b>–î–æ–±–∞–≤–ª–µ–Ω–æ</b>: {req.DateAdded:dd.MM.yyyy}
                """;

            var keyboard = new InlineKeyboardMarkup(new[]
            {
                new[]
                {
                    InlineKeyboardButton.WithCallbackData("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", $"edit_requisite_{reqId}"),
                    InlineKeyboardButton.WithCallbackData("‚ùå –£–¥–∞–ª–∏—Ç—å", $"delete_requisite_{reqId}")
                },
                new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "requisites_menu") }
            });

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId, message, keyboard, cancellationToken, $"requisite_detail_{reqId}", ParseMode.Html);
        }

        private static async Task ShowDepositPageAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ–ø–æ–∑–∏—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                decimal totalDeposit = 0;
                DateTime? lastDepositDate = null;
                string lastDepositStatus = "–ù–µ—Ç –¥–µ–ø–æ–∑–∏—Ç–æ–≤";
                int pendingDeposits = 0;

                using (var cmd = new SQLiteCommand(
                    "SELECT Amount, Date, Status FROM Deposits WHERE TelegramId = @id ORDER BY Date DESC",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", chatId);
                    using var reader = await cmd.ExecuteReaderAsync();
                    while (await reader.ReadAsync())
                    {
                        var amount = reader.GetDecimal(0);
                        var status = reader.GetString(2);
                        if (status == "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω")
                        {
                            totalDeposit += amount;
                        }
                        if (lastDepositDate == null)
                        {
                            lastDepositDate = DateTime.Parse(reader.GetString(1));
                            lastDepositStatus = status;
                        }
                        if (status == "–û–∂–∏–¥–∞–µ—Ç")
                        {
                            pendingDeposits++;
                        }
                    }
                }

                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
                decimal totalInterest = 0;
                using (var cmd = new SQLiteCommand(
                    "SELECT Interest FROM Users WHERE TelegramId = @id",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", chatId);
                    using var reader = await cmd.ExecuteReaderAsync();
                    if (await reader.ReadAsync())
                    {
                        totalInterest = reader.GetDecimal(0);
                    }
                }

                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                decimal weeklyRate = totalDeposit >= 50000 ? 0.06m : 0.05m;
                decimal dailyRate = weeklyRate / 7;
                decimal dailyInterest = totalInterest > 0 ? totalDeposit * dailyRate : 0m; // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω

                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–æ –≤—ã–≤–æ–¥–∞
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–æ –≤—ã–≤–æ–¥–∞
                string withdrawalStatus;
                bool canWithdraw = true;
                if (lastDepositDate.HasValue && lastDepositStatus == "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω")
                {
                    var timeSinceDeposit = DateTime.UtcNow - lastDepositDate.Value;
                    var daysUntilWithdrawal = 7 - timeSinceDeposit.TotalDays;
                    if (daysUntilWithdrawal > 0)
                    {
                        canWithdraw = false;
                        var days = (int)Math.Floor(daysUntilWithdrawal);
                        var hours = (int)((daysUntilWithdrawal - days) * 24);
                        withdrawalStatus = $"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å: {Math.Min(days, 7)} –¥–Ω. {hours} —á.";
                    }
                    else
                    {
                        withdrawalStatus = "‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ";
                    }
                }
                else if (lastDepositStatus == "–û–∂–∏–¥–∞–µ—Ç")
                {
                    canWithdraw = false;
                    withdrawalStatus = "‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞";
                }
                else
                {
                    withdrawalStatus = "üìâ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤";
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –º–µ–Ω—é
                var text = $"""
                    <b>üíº –ú–æ–π –¥–µ–ø–æ–∑–∏—Ç</b>

                    üìä <b>–û–±—â–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>: {totalDeposit:F2} ‚ÇΩ
                    üìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞</b>: {(weeklyRate * 100):F1}% –≤ –Ω–µ–¥–µ–ª—é
                    üí∞ <b>–ü—Ä–∏–±—ã–ª—å –∑–∞ —Å–µ–≥–æ–¥–Ω—è</b>: {dailyInterest:F2} ‚ÇΩ
                    üíµ <b>–ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã</b>: {totalInterest:F2} ‚ÇΩ
                    {(pendingDeposits > 0 ? $"üîî <b>–û–∂–∏–¥–∞—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã</b>: {pendingDeposits}" : "")}
                    ‚è∞ <b>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</b>: {withdrawalStatus}

                    –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
                    """;

                // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                var buttons = new List<InlineKeyboardButton[]>();
                if (totalDeposit > 0)
                {
                    buttons.Add(new[] { InlineKeyboardButton.WithCallbackData("üí∏ –î–æ–≤–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç", "add_deposit") });
                    buttons.Add(new[] { InlineKeyboardButton.WithCallbackData(
                canWithdraw ? "üí∞ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥" : "üí∞ –í—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
                canWithdraw ? "withdraw" : "withdraw_disabled") });
                }
                else
                {
                    buttons.Add(new[] { InlineKeyboardButton.WithCallbackData("üí≥ –í–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç", "deposit") });
                }
                buttons.Add(new[] { InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu") });

                var keyboard = new InlineKeyboardMarkup(buttons);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                await EditOrSendMessageAsync(
                    botClient, chatId, messageId,
                    text, keyboard, cancellationToken, "my_deposit", ParseMode.Html, forceNewMessage: false);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {ex}");
                await EditOrSendMessageAsync(
                    botClient, chatId, messageId,
                    "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu")),
                    cancellationToken, "deposit_page_error", ParseMode.Html, forceNewMessage: false);
            }
        }

        private static async Task ShowDepositsListAsync(long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                var deposits = await GetPendingDepositsAsync();
                var message = new StringBuilder("<b>üí≥ –û–∂–∏–¥–∞—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã</b>\n\n");

                if (!deposits.Any())
                {
                    message.AppendLine("–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤.");
                }
                else
                {
                    foreach (var dep in deposits)
                    {
                        message.AppendLine($"<b>üÜî ID</b>: <code>{dep.Id}</code>\n\n");
                        message.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={dep.UserId}\">{HtmlEscape(dep.Username)}</a>\n\n");
                        message.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {dep.Amount:F2} ‚ÇΩ\n\n");
                        message.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {dep.Date:dd.MM.yyyy HH:mm}\n\n");
                        message.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n");
                    }
                }

                var keyboard = new InlineKeyboardMarkup(
                    deposits.Select(dep => new[] { InlineKeyboardButton.WithCallbackData($"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å {dep.Id} ({dep.Amount:F2} ‚ÇΩ)", $"confirm_deposit_{dep.Id}") })
                    .Concat(new[] { new[] { InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "deposits_list"), InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") } }));

                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId, message.ToString(), keyboard, cancellationToken, "deposits_list", ParseMode.Html);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤: {ex}");
                await BotClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
        }

        private static async Task ShowWithdrawalsListAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                var withdrawals = await GetPendingWithdrawalsAsync();
                var message = new StringBuilder("<b>üí∏ –û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–≤–æ–¥—ã</b>\n\n");

                if (!withdrawals.Any())
                {
                    message.AppendLine("–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–≤–æ–¥–æ–≤.");
                }
                else
                {
                    foreach (var w in withdrawals)
                    {
                        message.AppendLine($"<b>üÜî ID</b>: <code>{w.Id}</code>\n\n");
                        message.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={w.UserId}\">{HtmlEscape(w.Username)}</a>\n\n");
                        message.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {w.Amount:F2} ‚ÇΩ\n\n");
                        message.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {w.Date:dd.MM.yyyy HH:mm}\n\n");
                        message.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n");
                    }
                }

                var keyboard = new InlineKeyboardMarkup(
                    withdrawals.Select(w => new[] { InlineKeyboardButton.WithCallbackData($"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å {w.Id} ({w.Amount:F2} ‚ÇΩ)", $"confirm_withdrawal_{w.Id}") })
                    .Concat(new[] { new[] { InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "withdrawals_list"), InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") } }));

                await EditOrSendMessageAsync(
                    botClient, chatId, messageId, message.ToString(), keyboard, cancellationToken, "withdrawals_list", ParseMode.Html);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –≤—ã–≤–æ–¥–æ–≤: {ex}");
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –≤—ã–≤–æ–¥–æ–≤</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
        }

        private static async Task ShowPendingProofsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    @"SELECT dp.Id, dp.DepositId, dp.TelegramId, u.Username, d.Amount, dp.FileId, dp.FileType, dp.Date 
              FROM DepositProofs dp 
              LEFT JOIN Users u ON dp.TelegramId = u.TelegramId
              LEFT JOIN Deposits d ON dp.DepositId = d.Id
              WHERE dp.Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY dp.Date",
                    DbConnection);

                using var reader = await cmd.ExecuteReaderAsync();
                var message = new StringBuilder("<b>üßæ –ß–µ–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</b>\n\n");

                var proofs = new List<(int Id, int DepositId, long UserId, string Username, decimal Amount, string FileId, string FileType, DateTime Date)>();
                while (await reader.ReadAsync())
                {
                    proofs.Add((
                        reader.GetInt32(0),
                        reader.GetInt32(1),
                        reader.GetInt64(2),
                        reader.IsDBNull(3) ? "N/A" : reader.GetString(3),
                        reader.GetDecimal(4),
                        reader.GetString(5),
                        reader.GetString(6),
                        DateTime.Parse(reader.GetString(7))
                    ));
                }

                if (!proofs.Any())
                {
                    message.AppendLine("–ù–µ—Ç —á–µ–∫–æ–≤ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.");
                }

                var keyboardRows = new List<InlineKeyboardButton[]>();
                foreach (var proof in proofs)
                {
                    message.AppendLine($"<b>üÜî ID —á–µ–∫–∞</b>: <code>{proof.Id}</code>\n");
                    message.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={proof.UserId}\">{HtmlEscape(proof.Username)}</a>\n");
                    message.AppendLine($"<b>üí∞ –°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>: {proof.Amount:F2} ‚ÇΩ\n");
                    message.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {proof.Date:dd.MM.yyyy HH:mm}\n");
                    message.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n");

                    keyboardRows.Add(new[]
                    {
                InlineKeyboardButton.WithCallbackData($"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —á–µ–∫ {proof.Id}", $"confirm_deposit_{proof.DepositId}"),
                InlineKeyboardButton.WithCallbackData($"‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å —á–µ–∫ {proof.Id}", $"reject_proof_{proof.Id}")
            });

                    try
                    {
                        if (proof.FileType == "photo")
                        {
                            await botClient.SendPhoto(
                                chatId: chatId,
                                photo: new InputFileId(proof.FileId),
                                caption: $"–ß–µ–∫ ID {proof.Id} –Ω–∞ {proof.Amount:F2} ‚ÇΩ –æ—Ç {HtmlEscape(proof.Username)}",
                                cancellationToken: cancellationToken);
                        }
                        else
                        {
                            await botClient.SendDocument(
                                chatId: chatId,
                                document: new InputFileId(proof.FileId),
                                caption: $"–ß–µ–∫ ID {proof.Id} –Ω–∞ {proof.Amount:F2} ‚ÇΩ –æ—Ç {HtmlEscape(proof.Username)}",
                                cancellationToken: cancellationToken);
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞: {ex}");
                        message.AppendLine($"<b>‚ö† –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–∞ ID {proof.Id}</b>\n");
                    }
                }

                keyboardRows.Add(new[]
                {
                    InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "pending_proofs"),
                    InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")
                });

                await botClient.SendMessage(
                    chatId: chatId,
                    text: message.ToString(),
                    replyMarkup: new InlineKeyboardMarkup(keyboardRows),
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —á–µ–∫–æ–≤: {ex}");
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —á–µ–∫–æ–≤</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
        }


        private static async Task ViewDepositsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT d.Id, d.TelegramId, u.Username, d.Amount, d.Date, d.Status " +
                    "FROM Deposits d LEFT JOIN Users u ON d.TelegramId = u.TelegramId " +
                    "ORDER BY d.Date DESC", DbConnection);
                using var reader = await cmd.ExecuteReaderAsync();
                var response = new StringBuilder("<b>üìã –°–ø–∏—Å–æ–∫ –¥–µ–ø–æ–∑–∏—Ç–æ–≤</b>\n\n");

                bool hasDeposits = false;
                while (await reader.ReadAsync())
                {
                    hasDeposits = true;
                    response.AppendLine($"<b>üÜî ID</b>: <code>{reader.GetInt32(0)}</code>\n\n");
                    response.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={reader.GetInt64(1)}\">{HtmlEscape(reader.IsDBNull(2) ? "N/A" : reader.GetString(2))}</a>\n\n");
                    response.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {reader.GetDecimal(3):F2} ‚ÇΩ\n\n");
                    response.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {DateTime.Parse(reader.GetString(4)):dd.MM.yyyy HH:mm}\n\n");
                    response.AppendLine($"<b>üìå –°—Ç–∞—Ç—É—Å</b>: {HtmlEscape(reader.GetString(5))}\n\n");
                    response.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n");
                }

                if (!hasDeposits)
                {
                    response.AppendLine("–î–µ–ø–æ–∑–∏—Ç–æ–≤ –Ω–µ—Ç.");
                }

                var keyboard = GetAdminMenuKeyboard();
                await EditOrSendMessageAsync(
                    botClient, chatId, messageId, response.ToString(), keyboard, cancellationToken, "view_deposits", ParseMode.Html);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤: {ex}");
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤.</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
        }

        private static async Task ViewWithdrawalsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT w.Id, w.TelegramId, u.Username, w.Amount, w.Date, w.Status " +
                    "FROM Withdrawals w LEFT JOIN Users u ON w.TelegramId = u.TelegramId " +
                    "ORDER BY w.Date DESC", DbConnection);
                using var reader = await cmd.ExecuteReaderAsync();
                var response = new StringBuilder("<b>üí∏ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–≤–æ–¥—ã</b>\n\n");

                bool hasWithdrawals = false;
                while (await reader.ReadAsync())
                {
                    hasWithdrawals = true;
                    response.AppendLine($"<b>üÜî ID</b>: <code>{reader.GetInt32(0)}</code>\n\n");
                    response.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={reader.GetInt64(1)}\">{HtmlEscape(reader.IsDBNull(2) ? "N/A" : reader.GetString(2))}</a>\n\n");
                    response.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {reader.GetDecimal(3):F2} ‚ÇΩ\n\n");
                    response.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {DateTime.Parse(reader.GetString(4)):dd.MM.yyyy HH:mm}\n\n");
                    response.AppendLine($"<b>üìå –°—Ç–∞—Ç—É—Å</b>: {HtmlEscape(reader.GetString(5))}\n\n");
                    response.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n");
                }

                if (!hasWithdrawals)
                {
                    response.AppendLine("–í—ã–≤–æ–¥–æ–≤ –Ω–µ—Ç.");
                }

                var keyboard = new InlineKeyboardMarkup(new[]
                {
                    new[] { InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "view_withdrawals") },
                    new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }
                });

                await EditOrSendMessageAsync(
                    botClient, chatId, messageId, response.ToString(), keyboard, cancellationToken, "view_withdrawals", ParseMode.Html);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –≤—ã–≤–æ–¥–æ–≤: {ex}");
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –≤—ã–≤–æ–¥–æ–≤.</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
        }

        private static async Task ViewReferralsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT r.Id, r.ReferrerId, r.RefereeId, u1.Username AS ReferrerUsername, u2.Username AS RefereeUsername, r.Bonus, r.Date " +
                    "FROM Referrals r " +
                    "LEFT JOIN Users u1 ON r.ReferrerId = u1.TelegramId " +
                    "LEFT JOIN Users u2 ON r.RefereeId = u2.TelegramId " +
                    "ORDER BY r.Date DESC", DbConnection);
                using var reader = await cmd.ExecuteReaderAsync();
                var response = new StringBuilder("<b>ü§ù –°–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</b>\n\n");

                bool hasReferrals = false;
                while (await reader.ReadAsync())
                {
                    hasReferrals = true;
                    response.AppendLine($"<b>üÜî ID</b>: <code>{reader.GetInt32(0)}</code>\n\n");
                    response.AppendLine($"<b>üë§ –†–µ—Ñ–µ—Ä–µ—Ä</b>: <a href=\"tg://user?id={reader.GetInt64(1)}\">{HtmlEscape(reader.IsDBNull(3) ? "N/A" : reader.GetString(3))}</a>\n\n");
                    response.AppendLine($"<b>üë§ –†–µ—Ñ–µ—Ä–∞–ª</b>: <a href=\"tg://user?id={reader.GetInt64(2)}\">{HtmlEscape(reader.IsDBNull(4) ? "N/A" : reader.GetString(4))}</a>\n\n");
                    response.AppendLine($"<b>üí∞ –ë–æ–Ω—É—Å</b>: {reader.GetDecimal(5):F2} ‚ÇΩ\n\n");
                    response.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {DateTime.Parse(reader.GetString(6)):dd.MM.yyyy HH:mm}\n\n");
                    response.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n\n");
                }

                if (!hasReferrals)
                {
                    response.AppendLine("–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ –Ω–µ—Ç.");
                }

                var keyboard = new InlineKeyboardMarkup(new[]
                {
                    new[] { InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "view_referrals") },
                    new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }
                });

                await EditOrSendMessageAsync(
                    botClient, chatId, messageId, response.ToString(), keyboard, cancellationToken, "view_referrals", ParseMode.Html);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {ex}");
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤.</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
        }

        #endregion

        #region Processing Methods

        private static async Task ProcessRequisiteAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            var parts = text.Split('|');
            if (parts.Length == 3 && (parts[0].Trim() == "card" || parts[0].Trim() == "crypto"))
            {
                using var cmd = new SQLiteCommand(
                    "INSERT INTO Requisites (Type, BankOrCoin, Details, DateAdded) VALUES (@type, @bank, @details, @date)",
                    DbConnection);
                cmd.Parameters.AddWithValue("@type", parts[0].Trim());
                cmd.Parameters.AddWithValue("@bank", parts[1].Trim());
                cmd.Parameters.AddWithValue("@details", parts[2].Trim());
                cmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                await cmd.ExecuteNonQueryAsync();

                await ShowRequisitesMenuAsync(chatId, messageId, cancellationToken);
                UserStates.Remove(chatId);
            }
            else
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    """
                    <b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.</b> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n\n
                    <code>—Ç–∏–ø|–±–∞–Ω–∫|–º–æ–Ω–µ—Ç–∞|—Ä–µ–∫–≤–∏–∑–∏—Ç—ã</code>\n\n
                    –ü—Ä–∏–º–µ—Ä: <code>card –°–±–µ—Ä–±–∞–Ω–∫ 1234567890123456</code>
                    """,
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "requisites_menu")),
                    cancellationToken, "requisite_error", ParseMode.Html);
            }
        }

        private static async Task ProcessEditRequisiteAsync(long chatId, string text, int messageId, string state, CancellationToken cancellationToken)
        {
            var editId = int.Parse(state.Split('_')[2]);
            var parts = text.Split('|');

            if (parts.Length == 3 && (parts[0].Trim() == "card" || parts[0].Trim() == "crypto"))
            {
                using var cmd = new SQLiteCommand(
                    "UPDATE Requisites SET Type = @type, BankOrCoin = @bank, Details = @details WHERE Id = @id",
                    DbConnection);
                cmd.Parameters.AddWithValue("@type", parts[0].Trim());
                cmd.Parameters.AddWithValue("@bank", parts[1].Trim());
                cmd.Parameters.AddWithValue("@details", parts[2].Trim());
                cmd.Parameters.AddWithValue("@id", editId);
                await cmd.ExecuteNonQueryAsync();

                await ShowRequisiteDetailsAsync(chatId, messageId, editId, cancellationToken);
                UserStates.Remove(chatId);
            }
            else
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.</b> –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:\n\n<code>—Ç–∏–ø|–±–∞–Ω–∫/–º–æ–Ω–µ—Ç–∞|—Ä–µ–∫–≤–∏–∑–∏—Ç—ã</code>",
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –û—Ç–º–µ–Ω–∞", $"requisite_detail_{editId}")),
                    cancellationToken, "edit_requisite_error", ParseMode.Html);
            }
        }
        private static async Task ProcessBlockUserAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!long.TryParse(text, out long userId))
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π Telegram ID:",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "block_user_error", ParseMode.Html);
                return;
            }

            using var cmd = new SQLiteCommand(
                "UPDATE Users SET IsBlocked = 1 WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", userId);
            var rowsAffected = await cmd.ExecuteNonQueryAsync();

            if (rowsAffected == 0)
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ö† –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.</b>",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "block_user_error", ParseMode.Html);
                return;
            }

            await BotClient.SendMessage(
                chatId: userId,
                text: "<b>üîí –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</b>",
                parseMode: ParseMode.Html,
                cancellationToken: cancellationToken);

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                $"<b>‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {userId} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</b>",
                new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                cancellationToken, "block_user_success", ParseMode.Html);
            UserStates.Remove(chatId);
        }

        private static async Task ProcessUnblockUserAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!long.TryParse(text, out long userId))
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π Telegram ID:",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "unblock_user_error", ParseMode.Html);
                return;
            }

            using var cmd = new SQLiteCommand(
                "UPDATE Users SET IsBlocked = 0 WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", userId);
            var rowsAffected = await cmd.ExecuteNonQueryAsync();

            if (rowsAffected == 0)
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ö† –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.</b>",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "unblock_user_error", ParseMode.Html);
                return;
            }

            await BotClient.SendMessage(
                chatId: userId,
                text: "<b>üîì –í–∞—à –∞–∫–∫–∞—É–Ω—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</b>",
                parseMode: ParseMode.Html,
                cancellationToken: cancellationToken);

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                $"<b>‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {userId} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</b>",
                new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                cancellationToken, "unblock_user_success", ParseMode.Html);
            UserStates.Remove(chatId);
        }
        private static async Task ProcessDepositAsync(string text, long chatId, int messageId, CancellationToken cancellationToken)
        {
            // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            Console.WriteLine($"[ProcessDepositAsync] –í–≤–µ–¥—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: {text} (chatId: {chatId})");

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É–º–º—É
            string errorMessage;
            if (!decimal.TryParse(text.Replace(" ", "").Replace(",", "."), NumberStyles.Any, CultureInfo.InvariantCulture, out var amount))
            {
                errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15000 –∏–ª–∏ 15000.50). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                Console.WriteLine($"[ProcessDepositAsync] –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ ({text})");
            }
            else if (amount < 10000)
            {
                errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ ‚Äî 10000 ‚ÇΩ. –í–≤–µ–¥–∏—Ç–µ –±–æ–ª—å—à—É—é —Å—É–º–º—É.";
                Console.WriteLine($"[ProcessDepositAsync] –û—à–∏–±–∫–∞: –°—É–º–º–∞ –º–µ–Ω—å—à–µ 10000 ({amount})");
            }
            else
            {
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Requisites
                string type = "card";
                string bankOrCoin = "–°–±–µ—Ä–±–∞–Ω–∫";
                string details = "1234 5678 9012 3456"; // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                try
                {
                    using (var reqCmd = new SQLiteCommand(
                        "SELECT Type, BankOrCoin, Details FROM Requisites ORDER BY Id DESC LIMIT 1", DbConnection))
                    {
                        using var reader = await reqCmd.ExecuteReaderAsync(cancellationToken);
                        if (await reader.ReadAsync())
                        {
                            type = reader.GetString(0);
                            bankOrCoin = reader.GetString(1);
                            details = reader.GetString(2);
                        }
                        else
                        {
                            Console.WriteLine("[ProcessDepositAsync] –û—à–∏–±–∫–∞: –†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ Requisites.");
                            errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø–æ–¥–¥–µ—Ä–∂–∫–µ.";
                            await EditOrSendMessageAsync(
                                BotClient, chatId, messageId,
                                errorMessage,
                                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")),
                                cancellationToken, "deposit_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
                            return;
                        }
                    }
                }
                catch (SQLiteException ex)
                {
                    Console.WriteLine($"[ProcessDepositAsync] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤: {ex.Message}");
                    errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø–æ–¥–¥–µ—Ä–∂–∫–µ.";
                    await EditOrSendMessageAsync(
                        BotClient, chatId, messageId,
                        errorMessage,
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")),
                        cancellationToken, "deposit_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
                    return;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–ø–æ–∑–∏—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ Deposits
                long depositId;
                using (var insertCmd = new SQLiteCommand(
                    "INSERT INTO Deposits (TelegramId, Amount, Status, Date) VALUES (@id, @amount, '–û–∂–∏–¥–∞–µ—Ç', @date)",
                    DbConnection))
                {
                    insertCmd.Parameters.AddWithValue("@id", chatId);
                    insertCmd.Parameters.AddWithValue("@amount", amount);
                    insertCmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss"));
                    await insertCmd.ExecuteNonQueryAsync(cancellationToken);
                    depositId = DbConnection.LastInsertRowId;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ waiting_deposit_proof
                UserStates[chatId] = "waiting_deposit_proof";

                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                string username = await GetUsernameAsync(chatId) ?? chatId.ToString();

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    $"""
            <b>üí≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</b>
            –°—É–º–º–∞: {amount:F2} ‚ÇΩ
            –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
            ‚Ä¢ <b>–ë–∞–Ω–∫/–º–æ–Ω–µ—Ç–∞: {bankOrCoin} </b>
            ‚Ä¢ <b>–†–µ–∫–≤–∏–∑–∏—Ç—ã: {details} </b>
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ PDF —á–µ–∫–∞ –æ –ø–µ—Ä–µ–≤–æ–¥–µ.
            <b>–ß–µ–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:</b>
            ‚Ä¢ –°—É–º–º—É –ø–µ—Ä–µ–≤–æ–¥–∞ ({amount:F2} ‚ÇΩ)
            ‚Ä¢ –†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            ‚Ä¢ –î–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–µ—Ä–µ–≤–æ–¥–∞
            """,
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")),
                    cancellationToken, "deposit", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);

                // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                foreach (var adminChatId in AdminIds)
                {
                    try
                    {
                        await BotClient.SendMessage(
                            adminChatId,
                            $"""
                    <b>üîî –ù–æ–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç</b>
                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{username} ({chatId})
                    –°—É–º–º–∞: {amount:F2} ‚ÇΩ
                    –†–µ–∫–≤–∏–∑–∏—Ç—ã: {type} | {bankOrCoin} | {details}
                    –û–∂–∏–¥–∞–µ—Ç—Å—è —á–µ–∫.
                    """,
                            parseMode: ParseMode.Html,
                            cancellationToken: cancellationToken);
                    }
                    catch (Telegram.Bot.Exceptions.ApiRequestException ex) when (ex.Message.Contains("chat not found"))
                    {
                        Console.WriteLine($"[ProcessDepositAsync] –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {adminChatId}: {ex.Message}");
                    }
                }
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                errorMessage,
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")),
                cancellationToken, "deposit_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
        }

        private static async Task ProcessWithdrawAsync(string text, long chatId, int messageId, CancellationToken cancellationToken)
        {
            // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            Console.WriteLine($"[ProcessWithdrawAsync] –í–≤–µ–¥—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: {text} (chatId: {chatId})");

            // –†–∞–∑–±–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç
            var parts = text.Split('|', StringSplitOptions.TrimEntries);
            string errorMessage;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞
            if (parts.Length != 4)
            {
                errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: <code>—Å—É–º–º–∞|—Ç–∏–ø|–±–∞–Ω–∫/–º–æ–Ω–µ—Ç–∞|—Ä–µ–∫–≤–∏–∑–∏—Ç—ã</code>\n–ü—Ä–∏–º–µ—Ä: <code>15000|card|–°–±–µ—Ä–±–∞–Ω–∫|1234 5678 9012 3456</code>";
                Console.WriteLine($"[ProcessWithdrawAsync] –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–µ–π ({parts.Length})");
            }
            else if (!decimal.TryParse(parts[0].Replace(" ", "").Replace(",", "."), NumberStyles.Any, CultureInfo.InvariantCulture, out var amount))
            {
                errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15000 –∏–ª–∏ 15000.50). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                Console.WriteLine($"[ProcessWithdrawAsync] –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞ ({parts[0]})");
            }
            else if (amount < 1000)
            {
                errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞ ‚Äî 1000 ‚ÇΩ. –í–≤–µ–¥–∏—Ç–µ –±–æ–ª—å—à—É—é —Å—É–º–º—É.";
                Console.WriteLine($"[ProcessWithdrawAsync] –û—à–∏–±–∫–∞: –°—É–º–º–∞ –º–µ–Ω—å—à–µ 1000 ({amount})");
            }
            else if (!new[] { "card", "crypto" }.Contains(parts[1].ToLower()))
            {
                errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–¢–∏–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 'card' –∏–ª–∏ 'crypto'. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                Console.WriteLine($"[ProcessWithdrawAsync] –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø ({parts[1]})");
            }
            else
            {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                decimal balance = 0;
                using (var balanceCmd = new SQLiteCommand(
                    "SELECT Balance FROM Users WHERE TelegramId = @id", DbConnection))
                {
                    balanceCmd.Parameters.AddWithValue("@id", chatId);
                    var result = await balanceCmd.ExecuteScalarAsync(cancellationToken);
                    balance = result is DBNull ? 0 : Convert.ToDecimal(result);
                }

                if (amount > balance)
                {
                    errorMessage = "<b>‚ùó –û—à–∏–±–∫–∞</b>\n\n–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ. –í–∞—à –±–∞–ª–∞–Ω—Å: {balance:F2} ‚ÇΩ.";
                    Console.WriteLine($"[ProcessWithdrawAsync] –û—à–∏–±–∫–∞: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (amount: {amount}, balance: {balance})");
                }
                else
                {
                    // –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –æ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ –≤—ã–≤–æ–¥
                    long withdrawalId;
                    using (var insertCmd = new SQLiteCommand(
                        "INSERT INTO Withdrawals (TelegramId, Amount, Requisites, Status, CreatedAt) VALUES (@id, @amount, @requisites, '–û–∂–∏–¥–∞–µ—Ç', @createdAt)",
                        DbConnection))
                    {
                        insertCmd.Parameters.AddWithValue("@id", chatId);
                        insertCmd.Parameters.AddWithValue("@amount", amount);
                        insertCmd.Parameters.AddWithValue("@requisites", $"{parts[1]}|{parts[2]}|{parts[3]}");
                        insertCmd.Parameters.AddWithValue("@createdAt", DateTime.UtcNow);
                        await insertCmd.ExecuteNonQueryAsync(cancellationToken);
                        withdrawalId = DbConnection.LastInsertRowId;
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
                    using (var adminCmd = new SQLiteCommand(
                        "SELECT TelegramId FROM Users WHERE IsAdmin = 1", DbConnection))
                    {
                        using var reader = await adminCmd.ExecuteReaderAsync(cancellationToken);
                        while (await reader.ReadAsync())
                        {
                            long adminChatId = reader.GetInt64(0);
                            await BotClient.SendMessage(
                                adminChatId,
                                $"""
                                <b>üîî –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥</b>
                                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {chatId}
                                –°—É–º–º–∞: {amount:F2} ‚ÇΩ
                                –†–µ–∫–≤–∏–∑–∏—Ç—ã: {parts[1]} | {parts[2]} | {parts[3]}
                                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ:
                                """,
                                replyMarkup: new InlineKeyboardMarkup(new[]
                                {
                            InlineKeyboardButton.WithCallbackData("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", $"confirm_withdrawal|{withdrawalId}"),
                            InlineKeyboardButton.WithCallbackData("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", $"cancel_withdrawal|{withdrawalId}")
                                }),
                                parseMode: ParseMode.Html,
                                cancellationToken: cancellationToken);
                        }
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                    await EditOrSendMessageAsync(
                        BotClient, chatId, messageId,
                        $"""
                        <b>üí∏ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥</b>
                        –°—É–º–º–∞: {amount:F2} ‚ÇΩ
                        –†–µ–∫–≤–∏–∑–∏—Ç—ã: {parts[1]} | {parts[2]} | {parts[3]}
                        –í–∞—à –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
                        """,
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "main_menu")),
                        cancellationToken, "withdraw", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
                    return;
                }
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                errorMessage,
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "main_menu")),
                cancellationToken, "withdraw_error", ParseMode.Html, forceNewMessage: true, ignoreLastMessageId: true);
        }
        private static async Task ProcessCancelDepositAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!int.TryParse(text, out int depositId))
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –¥–µ–ø–æ–∑–∏—Ç–∞.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID:",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "cancel_deposit_error", ParseMode.Html);
                return;
            }

            var deposit = await GetDepositByIdAsync(depositId);
            if (deposit == null || deposit.Status != "–û–∂–∏–¥–∞–µ—Ç")
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ö† –û—à–∏–±–∫–∞</b>\n\n–î–µ–ø–æ–∑–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "cancel_deposit_error", ParseMode.Html);
                return;
            }

            using var cmd = new SQLiteCommand(
                "UPDATE Deposits SET Status = '–û—Ç–º–µ–Ω—ë–Ω' WHERE Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", depositId);
            await cmd.ExecuteNonQueryAsync();

            await BotClient.SendMessage(
                chatId: deposit.UserId,
                text: $"<b>‚ùå –í–∞—à –¥–µ–ø–æ–∑–∏—Ç –Ω–∞ {deposit.Amount:F2} ‚ÇΩ –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω.</b>",
                parseMode: ParseMode.Html,
                cancellationToken: cancellationToken);

            await ShowDepositsListAsync(chatId, messageId, cancellationToken);
            UserStates.Remove(chatId);
        }
        private static async Task ProcessConfirmDepositAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!int.TryParse(text, out int depositId))
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –¥–µ–ø–æ–∑–∏—Ç–∞.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID:",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "confirm_deposit_error", ParseMode.Html);
                return;
            }
            await ConfirmDepositAsync(chatId, depositId, messageId, cancellationToken);
        }

        private static async Task ProcessConfirmWithdrawalAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            await ConfirmWithdrawalAsync(chatId, text, messageId, cancellationToken);
        }

        private static async Task ProcessCalculatorCustomAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            var keyboard = new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") });
            var parts = text.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length != 2 || !decimal.TryParse(parts[0], out var amount) || !int.TryParse(parts[1], out var weeks) || amount < 10000 || weeks <= 0)
            {
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    """
                    <b>‚ùó –û—à–∏–±–∫–∞</b>\n\n
                    –§–æ—Ä–º–∞—Ç: —Å—É–º–º–∞ (–º–∏–Ω. 10,000 ‚ÇΩ) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä: 15000 8).\n\n
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:
                    """,
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") }),
                    cancellationToken,
                    "calculator_custom_error",
                    ParseMode.Html,
                    forceNewMessage: true,
                    ignoreLastMessageId: true);
                return;
            }

            var resultText = await CalculateProfitAsync(amount, weeks);
            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                resultText,
                new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") }),
                cancellationToken,
                $"calculator_result_{amount}_{weeks}",
                ParseMode.Html,
                forceNewMessage: true);
        }

        private static async Task ConfirmDepositAsync(long chatId, int depositId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                var deposit = await GetDepositByIdAsync(depositId);
                if (deposit == null || deposit.Status != "–û–∂–∏–¥–∞–µ—Ç")
                {
                    await EditOrSendMessageAsync(
                        BotClient, chatId, messageId,
                        "<b>‚ö† –û—à–∏–±–∫–∞</b>\n\n–î–µ–ø–æ–∑–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.",
                        new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                        cancellationToken, "confirm_deposit_error", ParseMode.Html);
                    return;
                }

                using var transaction = DbConnection.BeginTransaction();
                try
                {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–æ–∑–∏—Ç–∞
                    using var cmd = new SQLiteCommand(
                        "UPDATE Deposits SET Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' WHERE Id = @id", DbConnection);
                    cmd.Parameters.AddWithValue("@id", depositId);
                    await cmd.ExecuteNonQueryAsync(cancellationToken);

                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    cmd.CommandText = @"UPDATE Users 
                SET Deposit = Deposit + @amount, 
                    Status = CASE 
                        WHEN Deposit + @amount >= 100000 THEN '–ö–∏—Ç'
                        WHEN Deposit + @amount >= 50000 THEN '–ü—Ä–æ—Ñ–∏'
                        ELSE '–ù–æ–≤–∏—á–æ–∫'
                    END
                WHERE TelegramId = @userId";
                    cmd.Parameters.Clear();
                    cmd.Parameters.AddWithValue("@amount", deposit.Amount);
                    cmd.Parameters.AddWithValue("@userId", deposit.UserId);
                    await cmd.ExecuteNonQueryAsync(cancellationToken);

                    // –ù–∞—á–∏—Å–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å
                    long? referrerId = null;
                    using (var getReferrerCmd = new SQLiteCommand(
                        "SELECT ReferrerId FROM Referrals WHERE RefereeId = @id",
                        DbConnection))
                    {
                        getReferrerCmd.Parameters.AddWithValue("@id", deposit.UserId);
                        var result = await getReferrerCmd.ExecuteScalarAsync(cancellationToken);
                        if (result != null && result != DBNull.Value)
                        {
                            referrerId = Convert.ToInt64(result);
                        }
                    }

                    if (referrerId.HasValue)
                    {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã —É —Ä–µ—Ñ–µ—Ä–∞–ª–∞
                        using (var checkDepositCmd = new SQLiteCommand(
                            "SELECT COUNT(*) FROM Deposits WHERE TelegramId = @refereeId AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' AND Id != @depositId",
                            DbConnection))
                        {
                            checkDepositCmd.Parameters.AddWithValue("@refereeId", deposit.UserId);
                            checkDepositCmd.Parameters.AddWithValue("@depositId", depositId);
                            var depositCount = Convert.ToInt32(await checkDepositCmd.ExecuteScalarAsync(cancellationToken));

                            // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç
                            if (depositCount == 0)
                            {
                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –±–æ–Ω—É—Å–∞
                                int referralCount;
                                using (var countCmd = new SQLiteCommand(
                                    "SELECT COUNT(*) FROM Referrals WHERE ReferrerId = @referrerId",
                                    DbConnection))
                                {
                                    countCmd.Parameters.AddWithValue("@referrerId", referrerId.Value);
                                    referralCount = Convert.ToInt32(await countCmd.ExecuteScalarAsync(cancellationToken));
                                }

                                decimal bonusRate = referralCount >= 5 ? 0.02m : 0.01m;
                                decimal bonus = deposit.Amount * bonusRate;

                                // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å
                                using (var updateBonusCmd = new SQLiteCommand(
                                    "UPDATE Referrals SET Bonus = COALESCE(Bonus, 0) + @bonus WHERE RefereeId = @id AND ReferrerId = @referrerId",
                                    DbConnection))
                                {
                                    updateBonusCmd.Parameters.AddWithValue("@bonus", bonus);
                                    updateBonusCmd.Parameters.AddWithValue("@id", deposit.UserId);
                                    updateBonusCmd.Parameters.AddWithValue("@referrerId", referrerId.Value);
                                    await updateBonusCmd.ExecuteNonQueryAsync(cancellationToken);
                                }

                                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –ù–∞—á–∏—Å–ª–µ–Ω –±–æ–Ω—É—Å {bonus:F2} ‚ÇΩ —Ä–µ—Ñ–µ—Ä–µ—Ä—É {referrerId} –∑–∞ –¥–µ–ø–æ–∑–∏—Ç {deposit.Amount:F2} ‚ÇΩ –æ—Ç {deposit.UserId}");
                            }
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ–∫–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –¥–µ–ø–æ–∑–∏—Ç–æ–º
                    using (var updateProofCmd = new SQLiteCommand(
                        "UPDATE DepositProofs SET Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' WHERE DepositId = @depositId",
                        DbConnection))
                    {
                        updateProofCmd.Parameters.AddWithValue("@depositId", depositId);
                        await updateProofCmd.ExecuteNonQueryAsync(cancellationToken);
                    }

                    transaction.Commit();

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await BotClient.SendMessage(
                        chatId: deposit.UserId,
                        text: $"<b>‚úÖ –í–∞—à –¥–µ–ø–æ–∑–∏—Ç –Ω–∞ {deposit.Amount:F2} ‚ÇΩ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!</b>",
                        parseMode: ParseMode.Html,
                        cancellationToken: cancellationToken);

                    await ShowDepositPageAsync(BotClient, deposit.UserId, 0, cancellationToken);
                    await ShowDepositsListAsync(chatId, messageId, cancellationToken);
                    UserStates.Remove(chatId);
                }
                catch (Exception)
                {
                    transaction.Rollback();
                    throw;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞: {ex}");
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞</b>",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "confirm_deposit_error", ParseMode.Html);
            }
        }

        private static async Task ConfirmWithdrawalAsync(long chatId, string withdrawalIdText, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                if (!int.TryParse(withdrawalIdText, out int withdrawalId))
                {
                    await EditOrSendMessageAsync(
                        BotClient, chatId, messageId,
                        "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –≤—ã–≤–æ–¥–∞.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID:",
                        new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                        cancellationToken, "confirm_withdrawal_error", ParseMode.Html);
                    return;
                }

                var withdrawal = await GetWithdrawalByIdAsync(withdrawalId);
                if (withdrawal == null || withdrawal.Status != "–û–∂–∏–¥–∞–µ—Ç")
                {
                    await EditOrSendMessageAsync(
                        BotClient, chatId, messageId,
                        "<b>‚ö† –û—à–∏–±–∫–∞</b>\n\n–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.",
                        new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                        cancellationToken, "confirm_withdrawal_error", ParseMode.Html);
                    return;
                }

                var (deposit, interest, _) = await GetUserInfoAsync(withdrawal.UserId);
                if (withdrawal.Amount > deposit + interest)
                {
                    await EditOrSendMessageAsync(
                        BotClient, chatId, messageId,
                        "<b>‚ö† –û—à–∏–±–∫–∞</b>\n\n–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
                        new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                        cancellationToken, "confirm_withdrawal_error", ParseMode.Html);
                    return;
                }

                using var cmd = new SQLiteCommand(
                    "UPDATE Withdrawals SET Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' WHERE Id = @id", DbConnection);
                cmd.Parameters.AddWithValue("@id", withdrawalId);
                await cmd.ExecuteNonQueryAsync();

                cmd.CommandText = "UPDATE Users SET Deposit = Deposit - @amount WHERE TelegramId = @userId";
                cmd.Parameters.Clear();
                cmd.Parameters.AddWithValue("@amount", withdrawal.Amount);
                cmd.Parameters.AddWithValue("@userId", withdrawal.UserId);
                await cmd.ExecuteNonQueryAsync();

                await BotClient.SendMessage(
                    chatId: withdrawal.UserId,
                    text: $"<b>‚úÖ –í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ {withdrawal.Amount:F2} ‚ÇΩ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);

                await ShowDepositPageAsync(BotClient, withdrawal.UserId, 0, cancellationToken);
                await ShowWithdrawalsListAsync(BotClient, chatId, messageId, cancellationToken);
                UserStates.Remove(chatId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞: {ex}");
                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –≤—ã–≤–æ–¥–∞</b>",
                    new InlineKeyboardMarkup(new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }),
                    cancellationToken, "confirm_withdrawal_error", ParseMode.Html);
            }
        }

        #endregion

        #region Helper Methods

        private static async Task<Withdrawal> GetWithdrawalByIdAsync(int id)
        {
            using var cmd = new SQLiteCommand(
                "SELECT w.Id, w.TelegramId, u.Username, w.Amount, w.Date, w.Status " +
                "FROM Withdrawals w LEFT JOIN Users u ON w.TelegramId = u.TelegramId " +
                "WHERE w.Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", id);
            using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                return new Withdrawal
                {
                    Id = reader.GetInt32(0),
                    UserId = reader.GetInt64(1),
                    Username = reader.IsDBNull(2) ? "N/A" : reader.GetString(2),
                    Amount = reader.GetDecimal(3),
                    Date = DateTime.Parse(reader.GetString(4)),
                    Status = reader.GetString(5)
                };
            }
            return null;
        }

        private static async Task<bool> CanWithdrawAsync(long chatId)
        {
            var lastDepositDate = await GetLastDepositDateAsync(chatId);
            if (!lastDepositDate.HasValue) return false;
            return DateTime.UtcNow >= lastDepositDate.Value.AddDays(7);
        }

        private static async Task<string> CalculateProfitAsync(decimal amount, int weeks)
        {
            decimal rate = amount >= 50000 ? 0.06m : 0.05m;
            decimal profit = amount * rate * weeks;
            return $"""
                <b>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞</b>
                <b>–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>: {amount:F2} ‚ÇΩ
                <b>–°—Ä–æ–∫</b>: {weeks} –Ω–µ–¥–µ–ª—å
                <b>–°—Ç–∞–≤–∫–∞</b>: {(rate * 100):F0}%
                <b>–ü—Ä–∏–±—ã–ª—å</b>: {profit:F2} ‚ÇΩ
                <b>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</b>: {(amount + profit):F2} ‚ÇΩ
                """;
        }

        private static async Task CalculateInterestAsync()
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT TelegramId, Deposit, ReferralCount FROM Users WHERE Deposit > 0", DbConnection);
                using var reader = await cmd.ExecuteReaderAsync();
                var users = new List<(long UserId, decimal Deposit, int ReferralCount)>();

                while (await reader.ReadAsync())
                {
                    users.Add((
                        reader.GetInt64(0),
                        reader.GetDecimal(1),
                        reader.GetInt32(2)
                    ));
                }

                foreach (var user in users)
                {
                    decimal rate = user.Deposit >= 50000 ? 0.06m : 0.05m;
                    decimal interest = user.Deposit * rate;
                    decimal referralBonus = user.ReferralCount >= 5 ? user.Deposit * 0.02m : user.Deposit * 0.01m;

                    using var updateCmd = new SQLiteCommand(
                        "UPDATE Users SET Interest = Interest + @interest WHERE TelegramId = @id", DbConnection);
                    updateCmd.Parameters.AddWithValue("@interest", interest + referralBonus);
                    updateCmd.Parameters.AddWithValue("@id", user.UserId);
                    await updateCmd.ExecuteNonQueryAsync();

                    await BotClient.SendMessage(
                        chatId: user.UserId,
                        text: $"<b>üí∏ –ù–∞—á–∏—Å–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ–Ω—Ç—ã: {interest:F2} ‚ÇΩ</b>\n\n–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å: {referralBonus:F2} ‚ÇΩ",
                        parseMode: ParseMode.Html,
                        cancellationToken: CancellationToken.None);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤: {ex}");
            }
        }

        private static async Task<Message?> EditOrSendMessageAsync(
            ITelegramBotClient botClient,
            long chatId,
            int messageId,
            string text,
            InlineKeyboardMarkup keyboard,
            CancellationToken cancellationToken,
            string messageKey,
            ParseMode parseMode,
            bool forceNewMessage = false,
            bool ignoreLastMessageId = false)
        {
            try
            {
                // –ï—Å–ª–∏ forceNewMessage –∏–ª–∏ LastMessageIds –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ID, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (forceNewMessage || !LastMessageIds.TryGetValue(chatId, out var lastMessageId) || lastMessageId <= 0)
                {
                    Console.WriteLine($"–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è {chatId}, key: {messageKey}");
                    var sentMessage = await botClient.SendMessage(
                        chatId: chatId,
                        text: text,
                        replyMarkup: keyboard,
                        parseMode: parseMode,
                        cancellationToken: cancellationToken);

                    if (!ignoreLastMessageId)
                    {
                        LastMessageIds[chatId] = sentMessage.MessageId;
                        Console.WriteLine($"–°–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–æ–≤—ã–π MessageId: {sentMessage.MessageId} –¥–ª—è {chatId}");
                    }
                    return sentMessage; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                }

                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                Console.WriteLine($"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è {lastMessageId} –¥–ª—è {chatId}, key: {messageKey}");
                try
                {
                    var editedMessage = await botClient.EditMessageText(
                        chatId: chatId,
                        messageId: lastMessageId,
                        text: text,
                        replyMarkup: keyboard,
                        parseMode: parseMode,
                        cancellationToken: cancellationToken);
                    Console.WriteLine($"–£—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ {lastMessageId} –¥–ª—è {chatId}");
                    return editedMessage; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                }
                catch (Exception ex) when (ex.Message.Contains("message is not modified"))
                {
                    Console.WriteLine($"–°–æ–æ–±—â–µ–Ω–∏–µ {lastMessageId} –¥–ª—è {chatId} –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, key: {messageKey}");
                    // –î–ª—è balance –∏ main_menu —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
                    if (messageKey == "balance" || messageKey == "main_menu")
                    {
                        return null; // –°–æ–æ–±—â–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                    }
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤ –ø—Ä–æ–±—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π messageId
                    Console.WriteLine($"–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å messageId {messageId} –¥–ª—è {chatId}");
                    try
                    {
                        var editedMessage = await botClient.EditMessageText(
                            chatId: chatId,
                            messageId: messageId,
                            text: text,
                            replyMarkup: keyboard,
                            parseMode: parseMode,
                            cancellationToken: cancellationToken);
                        LastMessageIds[chatId] = messageId;
                        Console.WriteLine($"–°–æ—Ö—Ä–∞–Ω—ë–Ω MessageId –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {messageId} –¥–ª—è {chatId}");
                        return editedMessage; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                    catch (Exception ex2)
                    {
                        Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è {messageId} –¥–ª—è {chatId}: {ex2.Message}");
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        var sentMessage = await botClient.SendMessage(
                            chatId: chatId,
                            text: text,
                            replyMarkup: keyboard,
                            parseMode: parseMode,
                            cancellationToken: cancellationToken);
                        if (!ignoreLastMessageId)
                        {
                            LastMessageIds[chatId] = sentMessage.MessageId;
                            Console.WriteLine($"–°–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–æ–≤—ã–π MessageId –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏: {sentMessage.MessageId} –¥–ª—è {chatId}");
                        }
                        return sentMessage; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è {lastMessageId} –¥–ª—è {chatId}: {ex.Message}");
                    // –ü—Ä–æ–±—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π messageId
                    try
                    {
                        Console.WriteLine($"–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å messageId {messageId} –¥–ª—è {chatId}");
                        var editedMessage = await botClient.EditMessageText(
                            chatId: chatId,
                            messageId: messageId,
                            text: text,
                            replyMarkup: keyboard,
                            parseMode: parseMode,
                            cancellationToken: cancellationToken);
                        LastMessageIds[chatId] = messageId;
                        Console.WriteLine($"–°–æ—Ö—Ä–∞–Ω—ë–Ω MessageId –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {messageId} –¥–ª—è {chatId}");
                        return editedMessage; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                    catch (Exception ex2)
                    {
                        Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è {messageId} –¥–ª—è {chatId}: {ex2.Message}");
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        var sentMessage = await botClient.SendMessage(
                            chatId: chatId,
                            text: text,
                            replyMarkup: keyboard,
                            parseMode: parseMode,
                            cancellationToken: cancellationToken);
                        if (!ignoreLastMessageId)
                        {
                            LastMessageIds[chatId] = sentMessage.MessageId;
                            Console.WriteLine($"–°–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–æ–≤—ã–π MessageId –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏: {sentMessage.MessageId} –¥–ª—è {chatId}");
                        }
                        return sentMessage; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è ({messageKey}): {ex}");
                var sentMessage = await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</b>",
                    parseMode: ParseMode.Html,
                    replyMarkup: new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu")),
                    cancellationToken: cancellationToken);
                if (!ignoreLastMessageId)
                {
                    LastMessageIds[chatId] = sentMessage.MessageId;
                    Console.WriteLine($"–°–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–æ–≤—ã–π MessageId –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏: {sentMessage.MessageId} –¥–ª—è {chatId}");
                }
                return sentMessage; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            }
        }
        private static string HtmlEscape(string text)
        {
            if (string.IsNullOrEmpty(text)) return text;
            return text.Replace("&", "&amp;")
                      .Replace("<", "&lt;")
                      .Replace(">", "&gt;")
                      .Replace("\"", "&quot;");
        }

        private static Task HandleErrorAsync(ITelegramBotClient botClient, Exception exception, CancellationToken cancellationToken)
        {
            Console.WriteLine($"–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ: {exception}");
            return Task.CompletedTask;
        }

        #endregion
    }

}
