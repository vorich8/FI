using System;
using System.Collections.Generic;
using System.Data.SQLite;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Telegram.Bot;
using Telegram.Bot.Polling;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;
using Telegram.Bot.Types.ReplyMarkups;
using static InvestmentBot.Program;

namespace InvestmentBot
{
    public static class StringExtensions
    {
        public static string Repeat(this string input, int count)
        {
            if (count <= 0) return string.Empty;
            return string.Concat(Enumerable.Repeat(input, count));
        }
    }
    class Program
    {
        #region Constants and Fields

        private const string BotToken = "8306720947:AAHKnXBWxuRT5uWVQQO6R6mcxeFnMxsFrsY";
        private static readonly long[] AdminIds = { 1800817933 };
        private static readonly TimeSpan InterestInterval = TimeSpan.FromDays(7);
        private static readonly ITelegramBotClient BotClient = new TelegramBotClient(BotToken);
        private static readonly SQLiteConnection DbConnection = new SQLiteConnection("Data Source=investments.db;Version=3;");
        private static readonly System.Timers.Timer InterestTimer = new System.Timers.Timer(InterestInterval.TotalMilliseconds);
        private static readonly Dictionary<long, string> UserStates = new Dictionary<long, string>();
        private static readonly Dictionary<long, int> LastMessageIds = new Dictionary<long, int>();
        private static readonly Dictionary<long, (string Data, DateTime Timestamp)> LastCallbackData =
            new Dictionary<long, (string Data, DateTime Timestamp)>();

        #endregion

        #region Data Models

        
        public class Deposit
        {
            public int Id { get; set; }
            public long UserId { get; set; }
            public string Username { get; set; }
            public decimal Amount { get; set; }
            public DateTime Date { get; set; }
            public string Status { get; set; }
        }

        public class Withdrawal
        {
            public int Id { get; set; }
            public long UserId { get; set; }
            public string Username { get; set; }
            public decimal Amount { get; set; }
            public DateTime Date { get; set; }
            public string Status { get; set; }
        }

        public class Requisite
        {
            public int Id { get; set; }
            public string Type { get; set; }
            public string BankOrCoin { get; set; }
            public string Details { get; set; }
            public DateTime DateAdded { get; set; }
        }

        #endregion

        #region Program Initialization

        static Program()
        {
            InterestTimer.Elapsed += async (sender, e) => await CalculateInterestAsync();
            InterestTimer.AutoReset = true;
        }

        static async Task Main(string[] args)
        {
            try
            {
                await DbConnection.OpenAsync();
                await InitializeDatabaseAsync();
                InterestTimer.Start();

                var cts = new CancellationTokenSource();
                var receiverOptions = new ReceiverOptions { AllowedUpdates = { } };
                BotClient.StartReceiving(HandleUpdateAsync, HandleErrorAsync, receiverOptions, cts.Token);

                Console.WriteLine("–ë–æ—Ç FAST INVEST –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è –≤—ã—Ö–æ–¥–∞.");
                Console.ReadKey();

                cts.Cancel();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {ex}");
            }
            finally
            {
                await DbConnection.CloseAsync();
            }
        }

        #endregion

        #region Database Methods

        private static async Task InitializeDatabaseAsync()
        {
            string[] queries = {
                @"CREATE TABLE IF NOT EXISTS Users (
                    TelegramId INTEGER PRIMARY KEY,
                    Username TEXT,
                    Deposit REAL DEFAULT 0,
                    Interest REAL DEFAULT 0,
                    Status TEXT DEFAULT '–ù–æ–≤–∏—á–æ–∫',
                    ReferralCode TEXT,
                    ReferralCount INTEGER DEFAULT 0,
                    IsBlocked INTEGER DEFAULT 0
                )",
                @"CREATE TABLE IF NOT EXISTS Deposits (
                    Id INTEGER PRIMARY KEY AUTOINCREMENT,
                    TelegramId INTEGER,
                    Amount REAL,
                    Date TEXT,
                    Status TEXT DEFAULT '–û–∂–∏–¥–∞–µ—Ç'
                )",
                @"CREATE TABLE IF NOT EXISTS Withdrawals (
                    Id INTEGER PRIMARY KEY AUTOINCREMENT,
                    TelegramId INTEGER,
                    Amount REAL,
                    Date TEXT,
                    Status TEXT DEFAULT '–û–∂–∏–¥–∞–µ—Ç'
                )",
                @"CREATE TABLE IF NOT EXISTS Referrals (
                    Id INTEGER PRIMARY KEY AUTOINCREMENT,
                    ReferrerId INTEGER NOT NULL,
                    RefereeId INTEGER NOT NULL,
                    BonusAmount REAL DEFAULT 0,
                    BonusPaid INTEGER DEFAULT 0,
                    FirstDepositAmount REAL,
                    Date TEXT NOT NULL,
                    PaidDate TEXT,
                    FOREIGN KEY(ReferrerId) REFERENCES Users(TelegramId),
                    FOREIGN KEY(RefereeId) REFERENCES Users(TelegramId),
                    UNIQUE(RefereeId)
                )",
                @"CREATE TRIGGER IF NOT EXISTS update_referral_count 
                    AFTER INSERT ON Referrals
                    FOR EACH ROW
                    BEGIN
                        UPDATE Users 
                        SET ReferralCount = ReferralCount + 1 
                        WHERE TelegramId = NEW.ReferrerId;
                    END;",
                @"CREATE TABLE IF NOT EXISTS Requisites (
                    Id INTEGER PRIMARY KEY AUTOINCREMENT,
                    Type TEXT,
                    BankOrCoin TEXT,
                    Details TEXT,
                    DateAdded TEXT
                )",
                @"CREATE TABLE IF NOT EXISTS DepositProofs (
                    Id INTEGER PRIMARY KEY AUTOINCREMENT,
                    TelegramId INTEGER,
                    DepositId INTEGER,
                    FileId TEXT,
                    FileType TEXT,
                    Date TEXT,
                    Status TEXT DEFAULT '–û–∂–∏–¥–∞–µ—Ç',
                    FOREIGN KEY(DepositId) REFERENCES Deposits(Id)
                )"
            };

            foreach (var query in queries)
            {
                using var cmd = new SQLiteCommand(query, DbConnection);
                await cmd.ExecuteNonQueryAsync();
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É IsBlocked –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            using var checkBlockedColumnCmd = new SQLiteCommand(
                "PRAGMA table_info(Users)", DbConnection);
            using var blockedReader = await checkBlockedColumnCmd.ExecuteReaderAsync();

            bool hasBlockedColumn = false;
            while (await blockedReader.ReadAsync())
            {
                if (blockedReader.GetString(1) == "IsBlocked")
                {
                    hasBlockedColumn = true;
                    break;
                }
            }

            if (!hasBlockedColumn)
            {
                using var alterBlockedCmd = new SQLiteCommand(
                    "ALTER TABLE Users ADD COLUMN IsBlocked INTEGER DEFAULT 0", DbConnection);
                await alterBlockedCmd.ExecuteNonQueryAsync();
            }
        }

        private static async Task RegisterUserAsync(long chatId, string username)
        {
            using var checkCmd = new SQLiteCommand("SELECT COUNT(*) FROM Users WHERE TelegramId = @id", DbConnection);
            checkCmd.Parameters.AddWithValue("@id", chatId);
            var exists = (long)await checkCmd.ExecuteScalarAsync() > 0;

            if (!exists)
            {
                string referralCode;
                do
                {
                    referralCode = Guid.NewGuid().ToString().Substring(0, 8);
                    using var codeCheckCmd = new SQLiteCommand("SELECT COUNT(*) FROM Users WHERE ReferralCode = @code", DbConnection);
                    codeCheckCmd.Parameters.AddWithValue("@code", referralCode);
                    var codeExists = (long)await codeCheckCmd.ExecuteScalarAsync() > 0;
                    if (!codeExists) break;
                } while (true);

                using var cmd = new SQLiteCommand(
                    "INSERT INTO Users (TelegramId, Username, ReferralCode) VALUES (@id, @username, @code)", DbConnection);
                cmd.Parameters.AddWithValue("@id", chatId);
                cmd.Parameters.AddWithValue("@username", username);
                cmd.Parameters.AddWithValue("@code", referralCode);
                await cmd.ExecuteNonQueryAsync();
            }
            else
            {
                await UpdateUsernameAsync(chatId, username);
            }
        }

        private static async Task UpdateUserStatusAsync(long telegramId)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞
                decimal totalDeposit = 0;
                using (var cmd = new SQLiteCommand(
                    "SELECT SUM(Amount) FROM Deposits WHERE TelegramId = @id AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", telegramId);
                    var result = await cmd.ExecuteScalarAsync();
                    totalDeposit = result is DBNull ? 0 : Convert.ToDecimal(result);
                }

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                int referralCount = 0;
                using (var cmd = new SQLiteCommand(
                    "SELECT COUNT(*) FROM Referrals WHERE ReferrerId = @id",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", telegramId);
                    referralCount = Convert.ToInt32(await cmd.ExecuteScalarAsync());
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                string status;
                if (totalDeposit >= 100000 && referralCount >= 10)
                {
                    status = "–ö–∏—Ç";
                }
                else if (totalDeposit >= 50000 || referralCount >= 5)
                {
                    status = "–ü—Ä–æ—Ñ–∏";
                }
                else
                {
                    status = "–ù–æ–≤–∏—á–æ–∫";
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ
                using (var cmd = new SQLiteCommand(
                    "UPDATE Users SET Status = @status WHERE TelegramId = @id",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@status", status);
                    cmd.Parameters.AddWithValue("@id", telegramId);
                    await cmd.ExecuteNonQueryAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è {telegramId}: {ex}");
            }
        }

        private static async Task UpdateUsernameAsync(long chatId, string username)
        {
            using var cmd = new SQLiteCommand(
                "UPDATE Users SET Username = @username WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@username", username);
            cmd.Parameters.AddWithValue("@id", chatId);
            await cmd.ExecuteNonQueryAsync();
        }

        private static async Task<string> GetReferralCodeAsync(long chatId)
        {
            using var cmd = new SQLiteCommand("SELECT ReferralCode FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var result = await cmd.ExecuteScalarAsync();
            return result?.ToString() ?? string.Empty;
        }

        private static async Task<string> GetUsernameAsync(long chatId)
        {
            using var cmd = new SQLiteCommand("SELECT Username FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var result = await cmd.ExecuteScalarAsync();
            return result?.ToString() ?? "–ù–µ —É–∫–∞–∑–∞–Ω";
        }

        private static async Task<int> GetReferralCountAsync(long telegramId)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT COUNT(*) FROM Referrals WHERE ReferrerId = @id",
                    DbConnection);
                cmd.Parameters.AddWithValue("@id", telegramId);
                return Convert.ToInt32(await cmd.ExecuteScalarAsync());
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {ex}");
                return 0;
            }
        }

        private static async Task<(decimal deposit, decimal interest, string status)> GetUserInfoAsync(long chatId)
        {
            using var cmd = new SQLiteCommand(
                "SELECT Deposit, Interest, Status FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                return (reader.GetDecimal(0), reader.GetDecimal(1), reader.GetString(2));
            }
            return (0, 0, "–ù–æ–≤–∏—á–æ–∫");
        }

        private static async Task<DateTime?> GetLastDepositDateAsync(long chatId)
        {
            using var cmd = new SQLiteCommand(
                "SELECT Date FROM Deposits WHERE TelegramId = @id AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' ORDER BY Date DESC LIMIT 1",
                DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var result = await cmd.ExecuteScalarAsync();
            return result != null ? DateTime.Parse(result.ToString()) : (DateTime?)null;
        }

        private static async Task<Requisite> GetRequisiteByIdAsync(int id)
        {
            using var cmd = new SQLiteCommand("SELECT * FROM Requisites WHERE Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", id);
            using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                return new Requisite
                {
                    Id = reader.GetInt32(0),
                    Type = reader.GetString(1),
                    BankOrCoin = reader.GetString(2),
                    Details = reader.GetString(3),
                    DateAdded = DateTime.Parse(reader.GetString(4))
                };
            }
            return null;
        }

        private static async Task<List<Requisite>> GetAllRequisitesAsync()
        {
            var requisites = new List<Requisite>();
            using var cmd = new SQLiteCommand("SELECT * FROM Requisites ORDER BY DateAdded DESC", DbConnection);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                requisites.Add(new Requisite
                {
                    Id = reader.GetInt32(0),
                    Type = reader.GetString(1),
                    BankOrCoin = reader.GetString(2),
                    Details = reader.GetString(3),
                    DateAdded = DateTime.Parse(reader.GetString(4))
                });
            }
            return requisites;
        }

        private static async Task<Deposit> GetDepositByIdAsync(int id)
        {
            using var cmd = new SQLiteCommand(
                "SELECT Id, TelegramId, Amount, Date, Status FROM Deposits WHERE Id = @id",
                DbConnection);
            cmd.Parameters.AddWithValue("@id", id);

            using var reader = await cmd.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                return new Deposit
                {
                    Id = reader.GetInt32(0),
                    UserId = reader.GetInt64(1),
                    Amount = reader.GetDecimal(2),
                    Date = DateTime.Parse(reader.GetString(3)),
                    Status = reader.GetString(4)
                };
            }
            return null;
        }

        private static async Task<List<Deposit>> GetPendingDepositsAsync()
        {
            var deposits = new List<Deposit>();
            using var cmd = new SQLiteCommand(
                "SELECT d.Id, d.TelegramId, u.Username, d.Amount, d.Date, d.Status " +
                "FROM Deposits d LEFT JOIN Users u ON d.TelegramId = u.TelegramId " +
                "WHERE d.Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY d.Date", DbConnection);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                deposits.Add(new Deposit
                {
                    Id = reader.GetInt32(0),
                    UserId = reader.GetInt64(1),
                    Username = reader.IsDBNull(2) ? "N/A" : reader.GetString(2),
                    Amount = reader.GetDecimal(3),
                    Date = DateTime.Parse(reader.GetString(4)),
                    Status = reader.GetString(5)
                });
            }
            return deposits;
        }

        private static async Task<List<Withdrawal>> GetPendingWithdrawalsAsync()
        {
            var withdrawals = new List<Withdrawal>();
            using var cmd = new SQLiteCommand(
                "SELECT w.Id, w.TelegramId, u.Username, w.Amount, w.Date, w.Status " +
                "FROM Withdrawals w LEFT JOIN Users u ON w.TelegramId = u.TelegramId " +
                "WHERE w.Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY w.Date", DbConnection);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                withdrawals.Add(new Withdrawal
                {
                    Id = reader.GetInt32(0),
                    UserId = reader.GetInt64(1),
                    Username = reader.IsDBNull(2) ? "N/A" : reader.GetString(2),
                    Amount = reader.GetDecimal(3),
                    Date = DateTime.Parse(reader.GetString(4)),
                    Status = reader.GetString(5)
                });
            }
            return withdrawals;
        }

        private static async Task RegisterReferralAsync(long chatId, string referrerCode, CancellationToken cancellationToken)
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Å–µ–±–µ —Ä–µ—Ñ–µ—Ä–µ—Ä–æ–º
            using (var selfCheckCmd = new SQLiteCommand(
                "SELECT COUNT(*) FROM Users WHERE TelegramId = @id AND ReferralCode = @code",
                DbConnection))
            {
                selfCheckCmd.Parameters.AddWithValue("@id", chatId);
                selfCheckCmd.Parameters.AddWithValue("@code", referrerCode);
                if ((long)await selfCheckCmd.ExecuteScalarAsync() > 0)
                {
                    Console.WriteLine($"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {chatId} –ø–æ–ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥");
                    return;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ
            using (var existingCheckCmd = new SQLiteCommand(
                "SELECT COUNT(*) FROM Referrals WHERE RefereeId = @id",
                DbConnection))
            {
                existingCheckCmd.Parameters.AddWithValue("@id", chatId);
                if ((long)await existingCheckCmd.ExecuteScalarAsync() > 0)
                {
                    Console.WriteLine($"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {chatId} —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–∞–ª");
                    return;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –¥–µ–ø–æ–∑–∏—Ç—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            using (var depositsCheckCmd = new SQLiteCommand(
                "SELECT COUNT(*) FROM Deposits WHERE TelegramId = @id AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'",
                DbConnection))
            {
                depositsCheckCmd.Parameters.AddWithValue("@id", chatId);
                if ((long)await depositsCheckCmd.ExecuteScalarAsync() > 0)
                {
                    Console.WriteLine($"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {chatId} —É–∂–µ –∏–º–µ–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç—ã");
                    return;
                }
            }

            // –ü–æ–ª—É—á–∞–µ–º ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
            long? referrerId = null;
            using (var cmd = new SQLiteCommand(
                "SELECT TelegramId FROM Users WHERE ReferralCode = @code",
                DbConnection))
            {
                cmd.Parameters.AddWithValue("@code", referrerCode);
                var result = await cmd.ExecuteScalarAsync();
                if (result != null) referrerId = (long)result;
            }

            if (referrerId == null || referrerId == chatId)
            {
                Console.WriteLine($"–†–µ—Ñ–µ—Ä–µ—Ä —Å –∫–æ–¥–æ–º {referrerCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {chatId}");
                return;
            }

            // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
            using var transaction = DbConnection.BeginTransaction();
            try
            {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ —Ä–µ—Ñ–µ—Ä–∞–ª–µ
                using (var insertCmd = new SQLiteCommand(
                    "INSERT INTO Referrals (ReferrerId, RefereeId, Date) VALUES (@referrer, @referee, @date)",
                    DbConnection, transaction))
                {
                    insertCmd.Parameters.AddWithValue("@referrer", referrerId);
                    insertCmd.Parameters.AddWithValue("@referee", chatId);
                    insertCmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                    await insertCmd.ExecuteNonQueryAsync();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
                using (var updateCmd = new SQLiteCommand(
                    "UPDATE Users SET ReferralCount = ReferralCount + 1 WHERE TelegramId = @id",
                    DbConnection, transaction))
                {
                    updateCmd.Parameters.AddWithValue("@id", referrerId);
                    await updateCmd.ExecuteNonQueryAsync();
                }

                transaction.Commit();

                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                try
                {
                    await BotClient.SendMessage(
                        chatId: (long)referrerId,
                        text: $"üéâ –ù–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ! ID: {chatId}\n" +
                              "–í—ã –ø–æ–ª—É—á–∏—Ç–µ 1% –æ—Ç –µ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞ (2% –µ—Å–ª–∏ —É –≤–∞—Å 5+ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤).",
                        parseMode: ParseMode.Html,
                        cancellationToken: CancellationToken.None);

                    await ShowMainMenu(chatId, 0, cancellationToken);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ {referrerId}: {ex}");
                }

                Console.WriteLine($"–£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞: {chatId} –ø–æ —Å—Å—ã–ª–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {referrerId}");
            }
            catch (Exception ex)
            {
                transaction.Rollback();
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ {chatId}: {ex}");

                try
                {
                    await BotClient.SendMessage(
                        chatId: chatId,
                        text: "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                        parseMode: ParseMode.Html,
                        cancellationToken: CancellationToken.None);
                }
                catch { /* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ */ }
            }
        }

        private static async Task DeleteRequisiteAsync(int id)
        {
            using var cmd = new SQLiteCommand("DELETE FROM Requisites WHERE Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", id);
            await cmd.ExecuteNonQueryAsync();
        }

        #endregion

        #region Message Handlers

        private static async Task HandleUpdateAsync(ITelegramBotClient botClient, Update update, CancellationToken cancellationToken)
        {
            try
            {
                if (update.Message != null)
                {
                    await HandleMessageAsync(botClient, update.Message, cancellationToken);
                }
                else if (update.CallbackQuery != null)
                {
                    await HandleCallbackQueryAsync(botClient, update.CallbackQuery, cancellationToken);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {ex}");
                if (update.Message != null)
                {
                    await SendErrorMessage(update.Message.Chat.Id,"", cancellationToken);
                }
                else if (update.CallbackQuery != null)
                {
                    await SendErrorMessage(update.CallbackQuery.Message.Chat.Id, "", cancellationToken);
                }
            }
        }

        private static async Task HandleMessageAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
            var chatId = message.Chat.Id;
            var text = message.Text?.Trim() ?? "";
            var messageId = message.MessageId;
            var username = message.From?.Username ?? "–ù–µ —É–∫–∞–∑–∞–Ω";

            await RegisterUserAsync(chatId, username);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            using var cmd = new SQLiteCommand("SELECT IsBlocked FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var isBlocked = await cmd.ExecuteScalarAsync();
            if (isBlocked != null && Convert.ToInt32(isBlocked) == 1)
            {
                await botClient.SendMessage(
                    chatId: chatId,
                    text: "<b>üîí –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</b>",
                    parseMode: ParseMode.Html,
                    replyMarkup: GetMainMenuKeyboard(),
                    cancellationToken: cancellationToken);
                return;
            }

            await UpdateUsernameAsync(chatId, username);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ (—á–µ–∫–æ–≤)
            if (message.Document != null || message.Photo != null)
            {
                if (UserStates.TryGetValue(chatId, out var depositState) && depositState == "waiting_deposit_proof")
                {
                    await HandleDepositProofAsync(chatId, message, cancellationToken);
                    return;
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (–≤—Å–µ–≥–¥–∞ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
            if (UserStates.TryGetValue(chatId, out var state))
            {
                switch (state)
                {
                    case "waiting_block_user" when AdminIds.Contains(chatId):
                        await ProcessBlockUserAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_unblock_user" when AdminIds.Contains(chatId):
                        await ProcessUnblockUserAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_cancel_deposit" when AdminIds.Contains(chatId):
                        await ProcessCancelDepositAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_requisite":
                        await ProcessRequisiteAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case var currentState when currentState.StartsWith("editing_requisite_"):
                        await ProcessEditRequisiteAsync(chatId, text, messageId, currentState, cancellationToken);
                        break;
                    case "waiting_deposit":
                        await ProcessDepositAsync(text, chatId, messageId, cancellationToken);
                        break;
                    case "waiting_withdrawal":
                        await ProcessWithdrawAsync(text, chatId, messageId, cancellationToken);
                        break;
                    case "waiting_confirm_deposit" when AdminIds.Contains(chatId):
                        await ProcessConfirmDepositAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_confirm_withdrawal" when AdminIds.Contains(chatId):
                        await ProcessConfirmWithdrawalAsync(chatId, text, messageId, cancellationToken);
                        break;
                    case "waiting_calculator_custom":
                        await ProcessCalculatorCustomAsync(chatId, text, messageId, cancellationToken);
                        break;
                    default:
                        await SendMessageWithMenu(
                            chatId,
                            "<b>‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.</b> –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
                            cancellationToken,
                            "error_state");
                        UserStates.Remove(chatId);
                        break;
                }
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
            if (AdminIds.Contains(chatId) && text == "/admin")
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>",
                    cancellationToken,
                    "admin_menu",
                    GetAdminMenuKeyboard());
            }
            else if (text == "/start" || text.StartsWith("/start "))
            {
                await RegisterUserAsync(chatId, username);
                if (text.StartsWith("/start ") && text.Length > 7)
                {
                    var referrerCode = text.Substring(7).Trim();
                    await RegisterReferralAsync(chatId, referrerCode, cancellationToken);
                }
                await SendMessageWithMenu(
                    chatId,
                    "<b>üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FAST INVEST!</b>",
                    cancellationToken,
                    "start");
            }
            else
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>üîç –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:</b>",
                    cancellationToken,
                    "main_menu");
            }
        }

        private static async Task HandleCallbackQueryAsync(ITelegramBotClient botClient, CallbackQuery callbackQuery, CancellationToken cancellationToken)
        {
            var chatId = callbackQuery.Message.Chat.Id;
            var messageId = callbackQuery.Message.MessageId;
            var data = callbackQuery.Data;
            var username = callbackQuery.From.Username ?? "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            using var cmd = new SQLiteCommand("SELECT IsBlocked FROM Users WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var isBlocked = await cmd.ExecuteScalarAsync();
            if (isBlocked != null && Convert.ToInt32(isBlocked) == 1)
            {
                await botClient.AnswerCallbackQuery(
                    callbackQueryId: callbackQuery.Id,
                    text: "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    showAlert: true,
                    cancellationToken: cancellationToken);
                return;
            }

            try
            {
                Console.WriteLine($"Callback –æ—Ç {username} ({chatId}): {data}");

                // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —á–∞—Å–∏–∫–∏
                await botClient.AnswerCallbackQuery(
                    callbackQueryId: callbackQuery.Id,
                    cancellationToken: cancellationToken);

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
                if (LastCallbackData.TryGetValue(chatId, out var lastData) && lastData.Data == data && (DateTime.UtcNow - lastData.Timestamp).TotalSeconds < 2)
                {
                    return;
                }
                LastCallbackData[chatId] = (data, DateTime.UtcNow);

                switch (data)
                {
                    case "main_menu":
                        await ShowMainMenu(chatId, messageId, cancellationToken);
                        break;
                    case "my_deposit":
                        await ShowDepositPageAsync(chatId, callbackQuery.Message.MessageId, cancellationToken);
                        break;
                    case "add_deposit":
                    case "deposit":
                        await StartDepositProcess(chatId, callbackQuery.Message.MessageId, cancellationToken);
                        break;
                    case "withdraw":
                        await StartWithdrawalProcess(chatId, messageId, cancellationToken);
                        break;
                    case "withdraw_disabled":
                        await botClient.AnswerCallbackQuery(
                            callbackQuery.Id,
                            "–í—ã–≤–æ–¥ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞",
                            cancellationToken: cancellationToken);
                        break;
                    case "balance":
                        await ShowBalance(chatId, messageId, cancellationToken);
                        break;
                    case "referral":
                        await ShowReferralInfo(chatId, messageId, cancellationToken);
                        break;
                    case "calculator":
                        await ShowCalculator(chatId, messageId, cancellationToken);
                        break;
                    case var calcCase when calcCase.StartsWith("calc_"):
                        await HandleCalculatorCases(chatId, messageId, calcCase, cancellationToken);
                        break;
                    case "requisites_menu":
                        await ShowRequisitesMenuAsync(chatId, messageId, cancellationToken);
                        break;
                    case "add_requisite":
                        await StartAddRequisite(chatId, messageId, cancellationToken);
                        break;
                    case var reqCase when reqCase.StartsWith("requisite_detail_"):
                        await ShowRequisiteDetails(chatId, messageId, reqCase, cancellationToken);
                        break;
                    case var editCase when editCase.StartsWith("edit_requisite_"):
                        await StartEditRequisite(chatId, messageId, editCase, cancellationToken);
                        break;
                    case var delCase when delCase.StartsWith("delete_requisite_"):
                        await DeleteRequisite(chatId, messageId, delCase, cancellationToken);
                        break;
                    case "deposits_list":
                        await ShowDepositsListAsync(chatId, messageId, cancellationToken);
                        break;
                    case var depCase when depCase.StartsWith("confirm_deposit_"):
                        if (int.TryParse(depCase.Split('_').Last(), out int depositIdToConfirm))
                        {
                            await ConfirmDeposit(
                                chatId,
                                depositIdToConfirm,
                                callbackQuery.Message.MessageId,
                                cancellationToken);
                        }
                        break;
                    case "withdrawals_list":
                        await ShowWithdrawalsListAsync(botClient, chatId, messageId, cancellationToken);
                        break;
                    case var wCase when wCase.StartsWith("confirm_withdrawal_"):
                        await ConfirmWithdrawal(chatId, messageId, wCase, cancellationToken);
                        break;
                    case "pending_proofs":
                        await ShowPendingProofsAsync(botClient, chatId, messageId, cancellationToken);
                        break;
                    case "view_deposits":
                        await ViewDepositsAsync(botClient, chatId, messageId, cancellationToken);
                        break;
                    case "view_withdrawals":
                        await ViewWithdrawalsAsync(botClient, chatId, messageId, cancellationToken);
                        break;
                    case "view_referrals":
                        await ViewReferralsAsync(botClient, chatId, messageId, cancellationToken);
                        break;
                    case "confirm_deposit":
                        await StartConfirmDeposit(chatId, messageId, cancellationToken);
                        break;
                    case "confirm_withdrawal":
                        await StartConfirmWithdrawal(chatId, messageId, cancellationToken);
                        break;
                    case "admin_menu":
                        await ShowAdminMenu(chatId, messageId, cancellationToken);
                        break;
                    case "block_user":
                        await StartBlockUser(chatId, messageId, cancellationToken);
                        break;
                    case "unblock_user":
                        await StartUnblockUser(chatId, messageId, cancellationToken);
                        break;
                    case "cancel_deposit":
                        await ShowMainMenu(chatId, messageId, cancellationToken);
                        break;
                    case "cancel_deposit_admin":
                        await StartCancelDeposit(chatId, messageId, cancellationToken);
                        break;
                    default:
                        await SendMessageWithMenu(
                            chatId,
                            "‚ö† –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
                            cancellationToken,
                            "unknown_command");
                        break;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {ex}");
                await SendErrorMessage(chatId, "", cancellationToken);
            }
        }

        private static async Task HandleDepositProofAsync(long chatId, Message message, CancellationToken cancellationToken)
        {
            try
            {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞
                if (message.Document == null && message.Photo == null)
                {
                    await SendMessageWithMenu(
                        chatId,
                        "‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JPEG, PNG –∏–ª–∏ PDF.",
                        cancellationToken,
                        "deposit_proof_error",
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")));
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º fileId, —Ç–∏–ø —Ñ–∞–π–ª–∞ –∏ —Ä–∞–∑–º–µ—Ä
                string fileId;
                string fileType;
                long? fileSize;

                if (message.Document != null)
                {
                    var validExtensions = new[] { ".pdf", ".jpg", ".jpeg", ".png" };
                    var fileExt = Path.GetExtension(message.Document.FileName)?.ToLower();

                    if (fileExt == null || !validExtensions.Contains(fileExt))
                    {
                        await SendMessageWithMenu(
                            chatId,
                            "‚ùå –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF, JPEG –∏–ª–∏ PNG.",
                            cancellationToken,
                            "deposit_proof_format_error",
                            new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")));
                        return;
                    }

                    fileId = message.Document.FileId;
                    fileType = "document";
                    fileSize = message.Document.FileSize;
                }
                else
                {
                    var photoSize = message.Photo!.OrderByDescending(p => p.FileSize).First();
                    fileId = photoSize.FileId;
                    fileType = "photo";
                    fileSize = photoSize.FileSize;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 50 –ú–ë –¥–ª—è Telegram Bot API)
                if (fileSize > 50 * 1024 * 1024)
                {
                    await SendMessageWithMenu(
                        chatId,
                        "‚ùå –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.",
                        cancellationToken,
                        "deposit_proof_size_error",
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")));
                    return;
                }

                // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                using var transaction = DbConnection.BeginTransaction();
                try
                {
                    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–∂–∏–¥–∞—é—â–∏–π –¥–µ–ø–æ–∑–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    int depositId;
                    decimal amount;

                    using (var getDepositCmd = new SQLiteCommand(
                        "SELECT Id, Amount FROM Deposits WHERE TelegramId = @id AND Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY Date DESC LIMIT 1",
                        DbConnection))
                    {
                        getDepositCmd.Parameters.AddWithValue("@id", chatId);
                        using var reader = await getDepositCmd.ExecuteReaderAsync(cancellationToken);
                        if (!reader.HasRows)
                        {
                            await SendMessageWithMenu(
                                chatId,
                                "‚ö† –ù–µ –Ω–∞–π–¥–µ–Ω –æ–∂–∏–¥–∞—é—â–∏–π –¥–µ–ø–æ–∑–∏—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–Ω–æ–≤–æ.",
                                cancellationToken,
                                "deposit_proof_no_deposit");
                            UserStates.Remove(chatId);
                            return;
                        }

                        await reader.ReadAsync();
                        depositId = reader.GetInt32(0);
                        amount = reader.GetDecimal(1);
                    }

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ–∫ –≤ –±–∞–∑—É
                    using (var insertCmd = new SQLiteCommand(
                        "INSERT INTO DepositProofs (TelegramId, DepositId, FileId, FileType, Date, Status) " +
                        "VALUES (@id, @depositId, @fileId, @type, @date, '–û–∂–∏–¥–∞–µ—Ç')",
                        DbConnection))
                    {
                        insertCmd.Parameters.AddWithValue("@id", chatId);
                        insertCmd.Parameters.AddWithValue("@depositId", depositId);
                        insertCmd.Parameters.AddWithValue("@fileId", fileId);
                        insertCmd.Parameters.AddWithValue("@type", fileType);
                        insertCmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                        await insertCmd.ExecuteNonQueryAsync(cancellationToken);
                    }

                    transaction.Commit();

                    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    var username = await GetUsernameAsync(chatId);
                    var caption = $"–ß–µ–∫ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç {amount:F2} ‚ÇΩ –æ—Ç {username} (ID: {chatId}, –î–µ–ø–æ–∑–∏—Ç ID: {depositId})";

                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
                    foreach (var adminId in AdminIds)
                    {
                        try
                        {
                            await BotClient.SendMessage(
                                chatId: adminId,
                                text: $"üîî –ù–æ–≤—ã–π —á–µ–∫ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç {amount:F2} ‚ÇΩ –æ—Ç {username} (ID: {chatId})",
                                cancellationToken: cancellationToken);

                            if (fileType == "document")
                            {
                                await BotClient.SendDocument(
                                    chatId: adminId,
                                    document: new InputFileId(fileId),
                                    caption: caption,
                                    cancellationToken: cancellationToken);
                            }
                            else
                            {
                                await BotClient.SendPhoto(
                                    chatId: adminId,
                                    photo: new InputFileId(fileId),
                                    caption: caption,
                                    cancellationToken: cancellationToken);
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ {adminId}: {ex}");
                        }
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    await SendMessageWithMenu(
                        chatId,
                        $"‚úÖ –ß–µ–∫ –Ω–∞ —Å—É–º–º—É {amount:F2} ‚ÇΩ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!\n–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.",
                        cancellationToken,
                        "deposit_proof_success");

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    UserStates.Remove(chatId);
                }
                catch (Exception)
                {
                    transaction.Rollback();
                    throw;
                }
            }
            catch (SQLiteException ex)
            {
                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–∞: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "‚ö† –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                    cancellationToken,
                    "deposit_proof_error");
                UserStates.Remove(chatId);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ–∫–∞: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                    cancellationToken,
                    "deposit_proof_error");
                UserStates.Remove(chatId);
            }
        }

        #endregion

        #region Menu Navigation Methods

        private static async Task ShowMainMenu(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates.Remove(chatId);
            await EditOrSendMessageAsync(
                botClient: BotClient,
                chatId: chatId,
                messageId: messageId,
                text: "<b>üöÄ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                keyboard: GetMainMenuKeyboard(),
                cancellationToken: cancellationToken,
                messageKey: "main_menu",
                isNavigation: true);  // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ!
        }

        private static async Task ShowAdminMenu(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates.Remove(chatId);
            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                "<b>üõ† –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                GetAdminMenuKeyboard(),
                cancellationToken,
                "admin_menu", ParseMode.Html,
                isNavigation: true);
        }

        private static async Task ShowBalance(long chatId, int messageId, CancellationToken cancellationToken)
        {
            await UpdateUserStatusAsync(chatId);
            var (deposit, interest, status) = await GetUserInfoAsync(chatId);
            int referralCount = await GetReferralCountAsync(chatId);
            string username = await GetUsernameAsync(chatId) ?? chatId.ToString();

            decimal weeklyRate = deposit >= 50000 ? 0.06m : 0.05m;
            decimal referralBonusRate = referralCount >= 5 ? 0.02m : 0.01m;

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
            string statusProgress = CalculateStatusProgress(deposit, referralCount, status);

            var message = $"""
                <b>üë§ –ü—Ä–æ—Ñ–∏–ª—å</b>

                üßë <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: @{HtmlEscape(username)}
                <b>–°—Ç–∞—Ç—É—Å</b>: {HtmlEscape(status)} {GetStatusEmoji(status)}
                {statusProgress}
                üìä <b>–î–µ–ø–æ–∑–∏—Ç</b>: {deposit:F2} ‚ÇΩ
                üíµ <b>–ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã</b>: {interest:F2} ‚ÇΩ
                üë• <b>–†–µ—Ñ–µ—Ä–∞–ª—ã</b>: {referralCount}
                üìà <b>–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞</b>: {(weeklyRate * 100):F1}% –≤ –Ω–µ–¥–µ–ª—é
                üéÅ <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å</b>: {(referralBonusRate * 100):F1}% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞

                <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>
                """;

            var keyboard = new InlineKeyboardMarkup(new[]
            {
                new[] { InlineKeyboardButton.WithCallbackData("ü§ù –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–∞", "referral") },
                new[] { InlineKeyboardButton.WithCallbackData(deposit > 0 ? "üí∏ –î–æ–≤–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç" : "üí≥ –í–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç",
                    deposit > 0 ? "add_deposit" : "deposit") },
                new[] { InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu") }
            });

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                message, keyboard, cancellationToken,
                "balance", ParseMode.Html,
                isNavigation: true);
        }

        private static async Task ShowReferralInfo(long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                var referralCode = await GetReferralCodeAsync(chatId);
                int referralCount = await GetReferralCountAsync(chatId);
                decimal totalReferralBonus = 0;

                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å - –∏—Å–ø–æ–ª—å–∑—É–µ–º BonusAmount –≤–º–µ—Å—Ç–æ Bonus
                using (var cmd = new SQLiteCommand(
                    "SELECT SUM(BonusAmount) FROM Referrals WHERE ReferrerId = @id AND BonusPaid = 1",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", chatId);
                    var result = await cmd.ExecuteScalarAsync();
                    totalReferralBonus = result is DBNull ? 0 : Convert.ToDecimal(result);
                }

                var bonusRate = referralCount >= 5 ? 0.02m : 0.01m;
                var bonusAmount = 10000 * bonusRate;
                var referralLink = $"https://t.me/{(await BotClient.GetMe()).Username}?start={Uri.EscapeDataString(referralCode)}";
                var shareText = $"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ FAST INVEST! üöÄ\n\n–ü–æ–ª—É—á–∞–π 5% –ø—Ä–∏–±—ã–ª–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ!\n–ú–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: {referralLink}";

                var message = $"""
                    <b>ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>

                    üë§ <b>–í–∞—à –∫–æ–¥</b>: <code>{HtmlEscape(referralCode)}</code>
                    üë• <b>–†–µ—Ñ–µ—Ä–∞–ª–æ–≤</b>: {referralCount}
                    üí∞ <b>–í–∞—à –±–æ–Ω—É—Å</b>: {bonusRate * 100}% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ –¥—Ä—É–≥–∞
                    üí∏ <b>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</b>: {totalReferralBonus:F2} ‚ÇΩ
                    üéÅ <b>–ü—Ä–∏–º–µ—Ä</b>: –∑–∞ –¥–µ–ø–æ–∑–∏—Ç 10,000 ‚ÇΩ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ {bonusAmount:F2} ‚ÇΩ
                    üîó <b>–í–∞—à–∞ —Å—Å—ã–ª–∫–∞</b>: <code>{HtmlEscape(referralLink)}</code>
                    """;

                var keyboard = new InlineKeyboardMarkup(new[]
                {
                    new[] { InlineKeyboardButton.WithUrl("üì¢ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
                        $"https://t.me/share/url?url={Uri.EscapeDataString(referralLink)}&text={Uri.EscapeDataString(shareText)}") },
                    new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "main_menu") }
                });

                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    message, keyboard, cancellationToken,
                    "referral", ParseMode.Html,
                    isNavigation: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –≤ ShowReferralInfo: {ex}");
                await SendErrorMessage(chatId, "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", cancellationToken);
            }
        }

        private static async Task ShowCalculator(long chatId, int messageId, CancellationToken cancellationToken)
        {
            var keyboard = new InlineKeyboardMarkup(new[]
            {
        new[] {
            InlineKeyboardButton.WithCallbackData("10,000 ‚ÇΩ", "calc_10000"),
            InlineKeyboardButton.WithCallbackData("50,000 ‚ÇΩ", "calc_50000"),
            InlineKeyboardButton.WithCallbackData("100,000 ‚ÇΩ", "calc_100000")
        },
        new[] {
            InlineKeyboardButton.WithCallbackData("1 –Ω–µ–¥–µ–ª—è", "calc_1week"),
            InlineKeyboardButton.WithCallbackData("4 –Ω–µ–¥–µ–ª–∏", "calc_4week"),
            InlineKeyboardButton.WithCallbackData("12 –Ω–µ–¥–µ–ª—å", "calc_12week")
            },
                new[] { InlineKeyboardButton.WithCallbackData("‚úçÔ∏è –í–≤–µ—Å—Ç–∏ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ", "calc_custom") },
                new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "main_menu") }
            });

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                "<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞, —Å—Ä–æ–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ:",
                keyboard, cancellationToken,
                "calculator", ParseMode.Html,
                isNavigation: true); // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }

        private static async Task HandleCalculatorCases(long chatId, int messageId, string calcCase, CancellationToken cancellationToken)
        {
            if (calcCase.StartsWith("calc_") && calcCase.Length > 5)
            {
                var value = calcCase[5..];
                if (decimal.TryParse(value, out var amount))
                {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Å—É–º–º—É
                    UserStates[chatId] = $"waiting_calculator_amount_{amount}";
                    await ShowCalculatorPeriods(chatId, messageId, amount, cancellationToken);
                }
                else if (value.EndsWith("week") && int.TryParse(value.Replace("week", ""), out var weeks))
                {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –ø–µ—Ä–∏–æ–¥
                    if (UserStates.TryGetValue(chatId, out var state) && state.StartsWith("waiting_calculator_amount_"))
                    {
                        var amountStr = state.Replace("waiting_calculator_amount_", "");
                        if (decimal.TryParse(amountStr, out amount))
                        {
                            var result = await CalculateProfitAsync(amount, weeks);
                            await SendMessageWithMenu(
                                chatId,
                                result,
                                cancellationToken,
                                $"calc_result_{amount}_{weeks}",
                                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator")));
                            UserStates.Remove(chatId);
                        }
                    }
                }
                else if (value == "custom")
                {
                    UserStates[chatId] = "waiting_calculator_custom";
                    await SendMessageWithMenu(
                        chatId,
                        "<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏</b>\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä: 15000 8):",
                        cancellationToken,
                        "calculator_custom",
                        new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator")));
                }
            }
        }

        private static async Task ShowCalculatorPeriods(long chatId, int messageId, decimal amount, CancellationToken cancellationToken)
        {
            var keyboard = new InlineKeyboardMarkup(new[]
            {
                new[] {
                    InlineKeyboardButton.WithCallbackData("1 –Ω–µ–¥–µ–ª—è", "calc_1week"),
                    InlineKeyboardButton.WithCallbackData("4 –Ω–µ–¥–µ–ª–∏", "calc_4week"),
                    InlineKeyboardButton.WithCallbackData("12 –Ω–µ–¥–µ–ª—å", "calc_12week")
                },
                new[] { InlineKeyboardButton.WithCallbackData("‚úçÔ∏è –í–≤–µ—Å—Ç–∏ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ", "calc_custom") },
                new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator") }
            });

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                $"<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏</b>\n\n–í—ã–±—Ä–∞–Ω–∞ —Å—É–º–º–∞: {amount:F2} ‚ÇΩ\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ:",
                keyboard, cancellationToken, $"calculator_amount_{amount}", ParseMode.Html);
        }

        private static async Task StartDepositProcess(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates[chatId] = "waiting_deposit";
            await EditOrSendMessageAsync(
                botClient: BotClient,
                chatId: chatId,
                messageId: 0, // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                text: "<b>üí≥ –í–Ω–µ—Å–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞ (–º–∏–Ω: 10000 ‚ÇΩ)</b>\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É:",
                keyboard: new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("–û—Ç–º–µ–Ω–∞", "my_deposit")),
                cancellationToken: cancellationToken,
                messageKey: "deposit_input",
                isNavigation: false);
        }

        private static async Task StartWithdrawalProcess(long chatId, int messageId, CancellationToken cancellationToken)
        {
            if (await CanWithdrawAsync(chatId))
            {
                UserStates[chatId] = "waiting_withdrawal";
                await SendMessageWithMenu(
                    chatId,
                    "<b>üí∞ –ó–∞–ø—Ä–æ—Å –≤—ã–≤–æ–¥–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–∞:",
                    cancellationToken,
                    "withdraw",
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "my_deposit")));
            }
            else
            {
                await BotClient.AnswerCallbackQuery(
                    callbackQueryId: "",
                    text: "–í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞",
                    cancellationToken: cancellationToken);
            }
        }
        private static async Task AddMissingColumns()
        {
                string[] columnsToAdd = {
            "BonusAmount REAL DEFAULT 0",
            "BonusPaid INTEGER DEFAULT 0",
            "FirstDepositAmount REAL",
            "PaidDate TEXT"
        };

            foreach (var column in columnsToAdd)
            {
                try
                {
                    var columnName = column.Split(' ')[0];
                    using var checkCmd = new SQLiteCommand(
                        $"SELECT COUNT(*) FROM pragma_table_info('Referrals') WHERE name='{columnName}'",
                        DbConnection);

                    if ((long)await checkCmd.ExecuteScalarAsync() == 0)
                    {
                        using var alterCmd = new SQLiteCommand(
                            $"ALTER TABLE Referrals ADD COLUMN {column}",
                            DbConnection);
                        await alterCmd.ExecuteNonQueryAsync();
                        Console.WriteLine($"–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ {columnName}");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏: {ex}");
                }
            }
        }
        private static async Task StartAddRequisite(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates[chatId] = "waiting_requisite";
            await SendMessageWithMenu(
                chatId,
                """
                <b>üìã –í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:</b>
                ‚Ä¢ –î–ª—è –∫–∞—Ä—Ç—ã: <code>card|–ë–∞–Ω–∫|–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</code>
                ‚Ä¢ –î–ª—è –∫—Ä–∏–ø—Ç—ã: <code>crypto|–ú–æ–Ω–µ—Ç–∞|–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞</code>
                –ü—Ä–∏–º–µ—Ä: <code>card|–°–±–µ—Ä–±–∞–Ω–∫|1234 5678 9012 3456</code>
                """,
                cancellationToken,
                "add_requisite",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "requisites_menu")));
        }

        private static async Task ShowRequisiteDetails(long chatId, int messageId, string reqCase, CancellationToken cancellationToken)
        {
            if (int.TryParse(reqCase.Split('_').Last(), out int reqId))
            {
                var req = await GetRequisiteByIdAsync(reqId);
                if (req == null)
                {
                    await SendMessageWithMenu(
                        chatId,
                        "<b>‚ö† –†–µ–∫–≤–∏–∑–∏—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</b>",
                        cancellationToken,
                        "requisite_not_found");
                    return;
                }

                var message = $"""
                    <b>üìã –†–µ–∫–≤–∏–∑–∏—Ç—ã</b>

                    <b>–¢–∏–ø</b>: {HtmlEscape(req.Type)}
                    <b>–ë–∞–Ω–∫/–ú–æ–Ω–µ—Ç–∞</b>: {HtmlEscape(req.BankOrCoin)}
                    <b>–î–∞–Ω–Ω—ã–µ</b>: <code>{HtmlEscape(req.Details)}</code>
                    <b>–î–æ–±–∞–≤–ª–µ–Ω–æ</b>: {req.DateAdded:dd.MM.yyyy}
                    """;

                var keyboard = new InlineKeyboardMarkup(new[]
                {
                    new[]
                    {
                        InlineKeyboardButton.WithCallbackData("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", $"edit_requisite_{reqId}"),
                        InlineKeyboardButton.WithCallbackData("‚ùå –£–¥–∞–ª–∏—Ç—å", $"delete_requisite_{reqId}")
                    },
                    new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "requisites_menu") }
                });

                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    message, keyboard, cancellationToken, $"requisite_detail_{reqId}", ParseMode.Html);
            }
        }

        private static async Task StartEditRequisite(long chatId, int messageId, string editCase, CancellationToken cancellationToken)
        {
            if (int.TryParse(editCase.Split('_').Last(), out int editId))
            {
                UserStates[chatId] = $"editing_requisite_{editId}";
                var req = await GetRequisiteByIdAsync(editId);
                await SendMessageWithMenu(
                    chatId,
                    $"""
                    <b>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤</b>
                    –¢–µ–∫—É—â–∏–µ: {HtmlEscape(req.Type)}|{HtmlEscape(req.BankOrCoin)}|{HtmlEscape(req.Details)}
                    –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
                    <code>—Ç–∏–ø|–±–∞–Ω–∫/–º–æ–Ω–µ—Ç–∞|—Ä–µ–∫–≤–∏–∑–∏—Ç—ã</code>
                    """,
                    cancellationToken,
                    $"edit_requisite_{editId}",
                    new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –û—Ç–º–µ–Ω–∞", $"requisite_detail_{editId}")));
            }
        }

        private static async Task DeleteRequisite(long chatId, int messageId, string delCase, CancellationToken cancellationToken)
        {
            if (int.TryParse(delCase.Split('_').Last(), out int delId))
            {
                await DeleteRequisiteAsync(delId);
                await ShowRequisitesMenuAsync(chatId, messageId, cancellationToken);
            }
        }

        private static async Task StartConfirmDeposit(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates[chatId] = "waiting_confirm_deposit";
            await SendMessageWithMenu(
                chatId,
                "<b>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –¥–µ–ø–æ–∑–∏—Ç–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:",
                cancellationToken,
                "confirm_deposit",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")));
        }

        private static async Task StartConfirmWithdrawal(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates[chatId] = "waiting_confirm_withdrawal";
            await SendMessageWithMenu(
                chatId,
                "<b>üí∏ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –≤—ã–≤–æ–¥–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:",
                cancellationToken,
                "confirm_withdrawal",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")));
        }

        private static async Task StartBlockUser(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates[chatId] = "waiting_block_user";
            await SendMessageWithMenu(
                chatId,
                "<b>üîí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:",
                cancellationToken,
                "block_user",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")));
        }

        private static async Task StartUnblockUser(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates[chatId] = "waiting_unblock_user";
            await SendMessageWithMenu(
                chatId,
                "<b>üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n–í–≤–µ–¥–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:",
                cancellationToken,
                "unblock_user",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")));
        }

        private static async Task StartCancelDeposit(long chatId, int messageId, CancellationToken cancellationToken)
        {
            UserStates[chatId] = "waiting_cancel_deposit";
            await SendMessageWithMenu(
                chatId,
                "<b>‚ùå –û—Ç–º–µ–Ω–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –¥–µ–ø–æ–∑–∏—Ç–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã:",
                cancellationToken,
                "cancel_deposit",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")), forceNewMessage: true);
        }

        private static async Task ConfirmDeposit(long adminChatId, int depositId, int adminMessageId, CancellationToken cancellationToken)
        {
            try
            {
                // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–µ–ø–æ–∑–∏—Ç–µ
                var deposit = await GetDepositByIdAsync(depositId);
                if (deposit == null || deposit.Status != "–û–∂–∏–¥–∞–µ—Ç")
                {
                    await SendMessageWithMenu(
                        adminChatId,
                        "<b>‚ö† –î–µ–ø–æ–∑–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</b>",
                        cancellationToken,
                        "deposit_not_found");
                    return;
                }

                // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                using var transaction = DbConnection.BeginTransaction();
                try
                {
                    // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–æ–∑–∏—Ç–∞
                    using (var cmd = new SQLiteCommand(
                        "UPDATE Deposits SET Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' WHERE Id = @id",
                        DbConnection, transaction))
                    {
                        cmd.Parameters.AddWithValue("@id", depositId);
                        await cmd.ExecuteNonQueryAsync();
                    }

                    // 3. –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    using (var cmd = new SQLiteCommand(
                        "UPDATE Users SET Deposit = Deposit + @amount WHERE TelegramId = @userId",
                        DbConnection, transaction))
                    {
                        cmd.Parameters.AddWithValue("@amount", deposit.Amount);
                        cmd.Parameters.AddWithValue("@userId", deposit.UserId);
                        await cmd.ExecuteNonQueryAsync();
                    }

                    // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    using (var cmd = new SQLiteCommand(
                        "UPDATE DepositProofs SET Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω' WHERE DepositId = @depositId",
                        DbConnection, transaction))
                    {
                        cmd.Parameters.AddWithValue("@depositId", depositId);
                        await cmd.ExecuteNonQueryAsync();
                    }

                    // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–≤—ã–π –ª–∏ —ç—Ç–æ –¥–µ–ø–æ–∑–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    bool isFirstDeposit = false;
                    using (var checkCmd = new SQLiteCommand(
                        "SELECT COUNT(*) FROM Deposits WHERE TelegramId = @userId AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'",
                        DbConnection, transaction))
                    {
                        checkCmd.Parameters.AddWithValue("@userId", deposit.UserId);
                        isFirstDeposit = (long)await checkCmd.ExecuteScalarAsync() == 1;
                    }

                    // 6. –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç - –Ω–∞—á–∏—Å–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å
                    if (isFirstDeposit)
                    {
                        using (var referrerCmd = new SQLiteCommand(
                            "SELECT ReferrerId FROM Referrals WHERE RefereeId = @userId AND BonusPaid = 0",
                            DbConnection, transaction))
                        {
                            referrerCmd.Parameters.AddWithValue("@userId", deposit.UserId);
                            var referrerIdObj = await referrerCmd.ExecuteScalarAsync();

                            if (referrerIdObj != null)
                            {
                                long referrerId = (long)referrerIdObj;

                                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏
                                int referralCount = 0;
                                using (var countCmd = new SQLiteCommand(
                                    "SELECT ReferralCount FROM Users WHERE TelegramId = @referrerId",
                                    DbConnection, transaction))
                                {
                                    countCmd.Parameters.AddWithValue("@referrerId", referrerId);
                                    referralCount = Convert.ToInt32(await countCmd.ExecuteScalarAsync());
                                }

                                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –±–æ–Ω—É—Å (1% –∏–ª–∏ 2% –µ—Å–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ >=5)
                                decimal referralRate = referralCount >= 5 ? 0.02m : 0.01m;
                                decimal referralBonus = deposit.Amount * referralRate;

                                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ —Ä–µ—Ñ–µ—Ä–∞–ª–µ
                                using (var updateCmd = new SQLiteCommand(
                                    @"UPDATE Referrals SET 
                                BonusAmount = @bonus,
                                FirstDepositAmount = @amount,
                                BonusPaid = 1,
                                PaidDate = @date
                              WHERE RefereeId = @userId AND ReferrerId = @referrerId",
                                    DbConnection, transaction))
                                {
                                    updateCmd.Parameters.AddWithValue("@bonus", referralBonus);
                                    updateCmd.Parameters.AddWithValue("@amount", deposit.Amount);
                                    updateCmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                                    updateCmd.Parameters.AddWithValue("@userId", deposit.UserId);
                                    updateCmd.Parameters.AddWithValue("@referrerId", referrerId);
                                    await updateCmd.ExecuteNonQueryAsync();
                                }

                                // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å —Ä–µ—Ñ–µ—Ä–µ—Ä—É
                                using (var bonusCmd = new SQLiteCommand(
                                    "UPDATE Users SET Interest = Interest + @bonus WHERE TelegramId = @referrerId",
                                    DbConnection, transaction))
                                {
                                    bonusCmd.Parameters.AddWithValue("@bonus", referralBonus);
                                    bonusCmd.Parameters.AddWithValue("@referrerId", referrerId);
                                    await bonusCmd.ExecuteNonQueryAsync();
                                }

                                // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
                                try
                                {
                                    await BotClient.SendMessage(
                                        chatId: referrerId,
                                        text: $"üéâ –í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª (ID: {deposit.Username}) —Å–¥–µ–ª–∞–ª –ø–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç!\n" +
                                              $"–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω –±–æ–Ω—É—Å: {referralBonus:F2} ‚ÇΩ",
                                        parseMode: ParseMode.Html,
                                        cancellationToken: cancellationToken);

                                    await ShowMainMenu(referrerId, 0, cancellationToken);
                                }
                                catch (Exception ex)
                                {
                                    Console.WriteLine($"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–µ—Ä–∞: {ex}");
                                }
                            }
                        }
                    }

                    transaction.Commit();

                    // 7. –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    try
                    {
                        await BotClient.SendMessage(
                            chatId: deposit.UserId,
                            text: $"<b>‚úÖ –í–∞—à –¥–µ–ø–æ–∑–∏—Ç –Ω–∞ {deposit.Amount:F2} ‚ÇΩ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!</b>",
                            parseMode: ParseMode.Html,
                            cancellationToken: cancellationToken);

                        await ShowDepositPageAsync(deposit.UserId, 0, cancellationToken);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {ex}");
                    }

                    // 8. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
                    await ShowDepositsListAsync(adminChatId, adminMessageId, cancellationToken);
                }
                catch (Exception ex)
                {
                    transaction.Rollback();
                    Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞: {ex}");
                    await SendMessageWithMenu(
                        adminChatId,
                        "<b>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞</b>",
                        cancellationToken,
                        "deposit_confirm_error");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {ex}");
                await SendMessageWithMenu(
                    adminChatId,
                    "<b>‚ùå –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ</b>",
                    cancellationToken,
                    "transaction_error");
            }
        }

        private static async Task ConfirmWithdrawal(long chatId, int messageId, string wCase, CancellationToken cancellationToken)
        {
            if (int.TryParse(wCase.Split('_').Last(), out int withdrawalId))
            {
                await ConfirmWithdrawal(chatId, withdrawalId, messageId.ToString(), cancellationToken);
            }
        }
        private static async Task ShowDepositPageAsync(long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ–ø–æ–∑–∏—Ç–∞—Ö
                decimal totalDeposit = 0;
                DateTime? newestConfirmedDepositDate = null;
                int pendingDepositsCount = 0;
                bool hasConfirmedDeposits = false;

                using (var cmd = new SQLiteCommand(
                    "SELECT Amount, Date, Status FROM Deposits WHERE TelegramId = @id ORDER BY Date DESC",
                    DbConnection))
                {
                    cmd.Parameters.AddWithValue("@id", chatId);
                    using var reader = await cmd.ExecuteReaderAsync();
                    while (await reader.ReadAsync())
                    {
                        var amount = reader.GetDecimal(0);
                        var date = DateTime.Parse(reader.GetString(1));
                        var status = reader.GetString(2);

                        if (status == "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω")
                        {
                            totalDeposit += amount;
                            hasConfirmedDeposits = true;
                            if (newestConfirmedDepositDate == null || date > newestConfirmedDepositDate)
                            {
                                newestConfirmedDepositDate = date;
                            }
                        }
                        else if (status == "–û–∂–∏–¥–∞–µ—Ç")
                        {
                            pendingDepositsCount++;
                        }
                    }
                }

                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
                decimal totalInterest = await GetUserInterestAsync(chatId);

                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –≤—ã–≤–æ–¥–∞
                string withdrawalStatus;
                bool canWithdraw = false;

                if (pendingDepositsCount > 0)
                {
                    withdrawalStatus = "‚è≥ –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞";
                }
                else if (hasConfirmedDeposits)
                {
                    if (newestConfirmedDepositDate.HasValue)
                    {
                        var depositDate = newestConfirmedDepositDate.Value;
                        var availableDate = depositDate.AddDays(7);
                        var timeLeft = availableDate - DateTime.UtcNow;

                        if (timeLeft <= TimeSpan.Zero)
                        {
                            withdrawalStatus = "‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ";
                            canWithdraw = true;
                        }
                        else
                        {
                            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã–µ –¥–Ω–∏ –¥–æ –≤—ã–≤–æ–¥–∞
                            int days = (int)Math.Ceiling(timeLeft.TotalDays);

                            if (days > 7)
                            {
                                withdrawalStatus = "‚è≥ –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: 7 –¥–Ω."; // –ú–∞–∫—Å–∏–º—É–º 7 –¥–Ω–µ–π
                            }
                            else
                            {
                                withdrawalStatus = $"‚è≥ –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: {days} –¥–Ω.";
                            }
                        }
                    }
                    else
                    {
                        withdrawalStatus = "‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ";
                        canWithdraw = true;
                    }
                }
                else
                {
                    withdrawalStatus = "üìâ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤";
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                await SendDepositInfoMessage(chatId, messageId, totalDeposit, totalInterest,
                                           pendingDepositsCount, withdrawalStatus, canWithdraw,
                                           cancellationToken);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –≤ ShowDepositPageAsync: {ex}");
                await SendErrorMessage(chatId, cancellationToken);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        private static async Task<decimal> GetUserInterestAsync(long chatId)
        {
            using var cmd = new SQLiteCommand(
                "SELECT Interest FROM Users WHERE TelegramId = @id",
                DbConnection);
            cmd.Parameters.AddWithValue("@id", chatId);
            var result = await cmd.ExecuteScalarAsync();
            return result != null && result != DBNull.Value ? Convert.ToDecimal(result) : 0;
        }

        private static async Task SendDepositInfoMessage(long chatId, int messageId, decimal totalDeposit,
                                                      decimal totalInterest, int pendingDepositsCount,
                                                      string withdrawalStatus, bool canWithdraw,
                                                      CancellationToken cancellationToken)
        {
            var message = $"""
                <b>üíº –ú–æ–π –¥–µ–ø–æ–∑–∏—Ç</b>

                üìä <b>–û–±—â–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>: {totalDeposit:F2} ‚ÇΩ
                üí∞ <b>–ù–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã</b>: {totalInterest:F2} ‚ÇΩ
                {(pendingDepositsCount > 0 ? $"üîî <b>–û–∂–∏–¥–∞—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã</b>: {pendingDepositsCount}" : "")}
                ‚è∞ <b>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</b>: {withdrawalStatus}
                """;

            var keyboard = BuildDepositKeyboard(hasConfirmedDeposits: totalDeposit > 0,
                                               pendingDeposits: pendingDepositsCount > 0,
                                               canWithdraw: canWithdraw);

            await EditOrSendMessageAsync(
                BotClient, chatId, messageId,
                message, keyboard, cancellationToken,
                "my_deposit", ParseMode.Html,
                isNavigation: true);
        }

        private static InlineKeyboardMarkup BuildDepositKeyboard(bool hasConfirmedDeposits, bool pendingDeposits, bool canWithdraw)
        {
            var buttons = new List<InlineKeyboardButton[]>();

            if (hasConfirmedDeposits || pendingDeposits)
            {
                buttons.Add(new[] { InlineKeyboardButton.WithCallbackData("üí∏ –î–æ–≤–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç", "add_deposit") });
            }
            else
            {
                buttons.Add(new[] { InlineKeyboardButton.WithCallbackData("üí≥ –í–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç", "deposit") });
            }

            buttons.Add(new[] {
                InlineKeyboardButton.WithCallbackData(
                    canWithdraw ? "üí∞ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–≤–æ–¥" : "üí∞ –í—ã–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
                    canWithdraw ? "withdraw" : "withdraw_disabled")
            });

            buttons.Add(new[] { InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu") });

            return new InlineKeyboardMarkup(buttons);
        }

        private static async Task SendErrorMessage(long chatId, CancellationToken cancellationToken)
        {
            await SendMessageWithMenu(
                chatId,
                "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                cancellationToken,
                "deposit_error");
        }
        private static async Task ShowDepositsListAsync(long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                var deposits = await GetPendingDepositsAsync();
                var message = new StringBuilder("<b>üí≥ –û–∂–∏–¥–∞—é—â–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã</b>\n\n");

                if (!deposits.Any())
                {
                    message.AppendLine("–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤.");
                }
                else
                {
                    foreach (var dep in deposits)
                    {
                        message.AppendLine($"<b>üÜî ID</b>: <code>{dep.Id}</code>");
                        message.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={dep.UserId}\">{HtmlEscape(dep.Username)}</a>");
                        message.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {dep.Amount:F2} ‚ÇΩ");
                        message.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {dep.Date:dd.MM.yyyy HH:mm}");
                        message.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n");
                    }
                }

                var keyboard = new InlineKeyboardMarkup(
                    deposits.Select(dep => new[]
                    {
                InlineKeyboardButton.WithCallbackData($"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å {dep.Id}", $"confirm_deposit_{dep.Id}"),
                InlineKeyboardButton.WithCallbackData($"‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", $"cancel_deposit_admin")
                    })
                    .Concat(new[]
                    {
                new[]
                {
                    InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "deposits_list"),
                    InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")
                }
                    }));

                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    message.ToString(), keyboard,
                    cancellationToken, "deposits_list", ParseMode.Html, isNavigation: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤</b>",
                    cancellationToken,
                    "deposits_error");
            }
        }

        private static async Task ShowWithdrawalsListAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                var withdrawals = await GetPendingWithdrawalsAsync();
                var message = new StringBuilder("<b>üí∏ –û–∂–∏–¥–∞—é—â–∏–µ –≤—ã–≤–æ–¥—ã</b>\n\n");

                if (!withdrawals.Any())
                {
                    message.AppendLine("–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–≤–æ–¥–æ–≤.");
                }
                else
                {
                    foreach (var w in withdrawals)
                    {
                        message.AppendLine($"<b>üÜî ID</b>: <code>{w.Id}</code>");
                        message.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={w.UserId}\">{HtmlEscape(w.Username)}</a>");
                        message.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {w.Amount:F2} ‚ÇΩ");
                        message.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {w.Date:dd.MM.yyyy HH:mm}");
                        message.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n");
                    }
                }

                var keyboard = new InlineKeyboardMarkup(
                    withdrawals.Select(w => new[]
                    {
                InlineKeyboardButton.WithCallbackData($"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å {w.Id}", $"confirm_withdrawal_{w.Id}"),
                InlineKeyboardButton.WithCallbackData($"‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", $"cancel_withdrawal_{w.Id}")
                    })
                    .Concat(new[]
                    {
                new[]
                {
                    InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "withdrawals_list"),
                    InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")
                }
                    }));

                await EditOrSendMessageAsync(
                    botClient, chatId, messageId,
                    message.ToString(), keyboard,
                    cancellationToken, "withdrawals_list", ParseMode.Html, isNavigation: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –≤—ã–≤–æ–¥–æ–≤: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –≤—ã–≤–æ–¥–æ–≤</b>",
                    cancellationToken,
                    "withdrawals_error");
            }
        }
        private static string CalculateStatusProgress(decimal deposit, int referralCount, string currentStatus)
        {
            string GetProgressEmoji(float percentage)
            {
                return percentage switch
                {
                    >= 1.0f => "üü£", // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π - –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                    >= 0.8f => "üü¢", // –ó–µ–ª–µ–Ω—ã–π - –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ
                    >= 0.5f => "üü°", // –ñ–µ–ª—Ç—ã–π - –ø–æ–ª–æ–≤–∏–Ω–∞
                    >= 0.2f => "üü†", // –û—Ä–∞–Ω–∂–µ–≤—ã–π - –Ω–∞—á–∞—Ç
                    _ => "‚ö™"  // –ë–µ–ª—ã–π - –Ω–µ –Ω–∞—á–∞—Ç
                };
            }

            string CreateCombinedProgress(decimal dep, int refs, decimal depMax, int refMax)
            {
                var depProgress = (float)(dep / depMax);
                var refProgress = (float)refs / refMax;

                return "üî∑ –î–µ–ø–æ–∑–∏—Ç " + GetProgressEmoji(depProgress) + " " +
                       (dep >= depMax ? $"{depMax:N0}‚ÇΩ ‚úÖ" : $"{dep:N0} / {depMax:N0}‚ÇΩ") +
                       "\nüë• –†–µ—Ñ–µ—Ä–∞–ª—ã " + GetProgressEmoji(refProgress) + " " +
                       (refs >= refMax ? $"{refMax} ‚úÖ" : $"{refs} / {refMax}");
            }

            return currentStatus switch
            {
                "–ù–æ–≤–∏—á–æ–∫" => CreateCombinedProgress(deposit, referralCount, 50_000, 5) +
                             $"\n\n<b>–°–ª–µ–¥. —Å—Ç–∞—Ç—É—Å:</b> –ü—Ä–æ—Ñ–∏ ü¶Å (50k ‚ÇΩ –∏–ª–∏ 5 —Ä–µ—Ñ.)",

                "–ü—Ä–æ—Ñ–∏" => CreateCombinedProgress(deposit, referralCount, 100_000, 10) +
                           $"\n\n<b>–°–ª–µ–¥. —Å—Ç–∞—Ç—É—Å:</b> –ö–∏—Ç üêã (100k ‚ÇΩ –∏ 10 —Ä–µ—Ñ.)",

                "–ö–∏—Ç" => "üéâ <b>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å</b> üêã\n" +
                         $"üí∞ –î–µ–ø–æ–∑–∏—Ç: {deposit:N0}‚ÇΩ\nüë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: {referralCount}",

                _ => ""
            };
        }
        private static async Task<string> CalculateProfitAsync(decimal amount, int weeks)
        {
            decimal rate = amount >= 50000 ? 0.06m : 0.05m;
            decimal profit = amount * (decimal)Math.Pow(1 + (double)rate, weeks) - amount;
            decimal total = amount + profit;

            return $"""
                <b>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞</b>
        
                <b>–°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>: {amount:F2} ‚ÇΩ
                <b>–°—Ä–æ–∫</b>: {weeks} –Ω–µ–¥–µ–ª—å
                <b>–°—Ç–∞–≤–∫–∞</b>: {(rate * 100):F0}% –≤ –Ω–µ–¥–µ–ª—é
                <b>–ü—Ä–∏–±—ã–ª—å</b>: {profit:F2} ‚ÇΩ
                <b>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</b>: {total:F2} ‚ÇΩ
        
                <i>–†–∞—Å—á—ë—Ç –ø—Ä–∏–≤–µ–¥—ë–Ω –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∏ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</i>
                """;
        }

        private static async Task<bool> CanWithdrawAsync(long chatId)
        {
            var lastDepositDate = await GetLastDepositDateAsync(chatId);
            if (!lastDepositDate.HasValue) return false;

            return DateTime.UtcNow >= lastDepositDate.Value.AddDays(7);
        }

        private static async Task ProcessBlockUserAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!long.TryParse(text, out long userId))
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π Telegram ID:",
                    cancellationToken,
                    "block_user_error");
                return;
            }

            using var cmd = new SQLiteCommand(
                "UPDATE Users SET IsBlocked = 1 WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", userId);
            int rowsAffected = await cmd.ExecuteNonQueryAsync();

            if (rowsAffected == 0)
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.</b>",
                    cancellationToken,
                    "block_user_not_found");
                return;
            }

            try
            {
                await BotClient.SendMessage(
                    chatId: userId,
                    text: "<b>üîí –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {ex}");
            }

            await SendMessageWithMenu(
                chatId,
                $"<b>‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {userId} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</b>",
                cancellationToken,
                "block_user_success");
            UserStates.Remove(chatId);
        }

        private static async Task ProcessUnblockUserAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!long.TryParse(text, out long userId))
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π Telegram ID:",
                    cancellationToken,
                    "unblock_user_error");
                return;
            }

            using var cmd = new SQLiteCommand(
                "UPDATE Users SET IsBlocked = 0 WHERE TelegramId = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", userId);
            int rowsAffected = await cmd.ExecuteNonQueryAsync();

            if (rowsAffected == 0)
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.</b>",
                    cancellationToken,
                    "unblock_user_not_found");
                return;
            }

            try
            {
                await BotClient.SendMessage(
                    chatId: userId,
                    text: "<b>üîì –í–∞—à –∞–∫–∫–∞—É–Ω—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {ex}");
            }

            await SendMessageWithMenu(
                chatId,
                $"<b>‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {userId} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</b>",
                cancellationToken,
                "unblock_user_success");
            UserStates.Remove(chatId);
        }

        private static async Task ProcessCancelDepositAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!int.TryParse(text, out int depositId))
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –¥–µ–ø–æ–∑–∏—Ç–∞.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID:",
                    cancellationToken,
                    "cancel_deposit_error");
                return;
            }

            var deposit = await GetDepositByIdAsync(depositId);
            if (deposit == null || deposit.Status != "–û–∂–∏–¥–∞–µ—Ç")
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –î–µ–ø–æ–∑–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω.</b>",
                    cancellationToken,
                    "cancel_deposit_not_found");
                return;
            }

            using var cmd = new SQLiteCommand(
                "UPDATE Deposits SET Status = '–û—Ç–º–µ–Ω—ë–Ω' WHERE Id = @id", DbConnection);
            cmd.Parameters.AddWithValue("@id", depositId);
            await cmd.ExecuteNonQueryAsync();

            try
            {
                await BotClient.SendMessage(
                    chatId: deposit.UserId,
                    text: $"<b>‚ùå –í–∞—à –¥–µ–ø–æ–∑–∏—Ç –Ω–∞ {deposit.Amount:F2} ‚ÇΩ –±—ã–ª –æ—Ç–º–µ–Ω—ë–Ω.</b>",
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {ex}");
            }

            await ShowDepositsListAsync(chatId, messageId, cancellationToken);
            UserStates.Remove(chatId);
        }

        private static async Task ProcessRequisiteAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            var parts = text.Split('|', StringSplitOptions.TrimEntries);
            if (parts.Length != 3 || (parts[0] != "card" && parts[0] != "crypto"))
            {
                await SendMessageWithMenu(
                    chatId,
                    """
            <b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.</b> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
            ‚Ä¢ –î–ª—è –∫–∞—Ä—Ç—ã: <code>card|–ë–∞–Ω–∫|–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</code>
            ‚Ä¢ –î–ª—è –∫—Ä–∏–ø—Ç—ã: <code>crypto|–ú–æ–Ω–µ—Ç–∞|–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞</code>
            –ü—Ä–∏–º–µ—Ä: <code>card|–°–±–µ—Ä–±–∞–Ω–∫|1234 5678 9012 3456</code>
            """,
                    cancellationToken,
                    "requisite_format_error");
                return;
            }

            using var cmd = new SQLiteCommand(
                "INSERT INTO Requisites (Type, BankOrCoin, Details, DateAdded) " +
                "VALUES (@type, @bank, @details, @date)", DbConnection);

            cmd.Parameters.AddWithValue("@type", parts[0]);
            cmd.Parameters.AddWithValue("@bank", parts[1]);
            cmd.Parameters.AddWithValue("@details", parts[2]);
            cmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));

            await cmd.ExecuteNonQueryAsync();

            await ShowRequisitesMenuAsync(chatId, messageId, cancellationToken);
            UserStates.Remove(chatId);
        }

        private static async Task ProcessEditRequisiteAsync(long chatId, string text, int messageId, string state, CancellationToken cancellationToken)
        {
            if (!int.TryParse(state.Split('_').Last(), out int reqId))
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.</b>",
                    cancellationToken,
                    "edit_requisite_error");
                return;
            }

            var parts = text.Split('|', StringSplitOptions.TrimEntries);
            if (parts.Length != 3 || (parts[0] != "card" && parts[0] != "crypto"))
            {
                await SendMessageWithMenu(
                    chatId,
                    """
            <b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.</b> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
            ‚Ä¢ –î–ª—è –∫–∞—Ä—Ç—ã: <code>card|–ë–∞–Ω–∫|–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</code>
            ‚Ä¢ –î–ª—è –∫—Ä–∏–ø—Ç—ã: <code>crypto|–ú–æ–Ω–µ—Ç–∞|–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞</code>
            –ü—Ä–∏–º–µ—Ä: <code>card|–°–±–µ—Ä–±–∞–Ω–∫|1234 5678 9012 3456</code>
            """,
                    cancellationToken,
                    "edit_requisite_format_error");
                return;
            }

            using var cmd = new SQLiteCommand(
                "UPDATE Requisites SET Type = @type, BankOrCoin = @bank, Details = @details " +
                "WHERE Id = @id", DbConnection);

            cmd.Parameters.AddWithValue("@type", parts[0]);
            cmd.Parameters.AddWithValue("@bank", parts[1]);
            cmd.Parameters.AddWithValue("@details", parts[2]);
            cmd.Parameters.AddWithValue("@id", reqId);

            await cmd.ExecuteNonQueryAsync();

            await ShowRequisiteDetails(chatId, messageId, reqId.ToString(), cancellationToken);
            UserStates.Remove(chatId);
        }

        private static async Task ProcessDepositAsync(string text, long chatId, int messageId, CancellationToken cancellationToken)
        {
            if (!decimal.TryParse(text.Replace(" ", "").Replace(",", "."),
                NumberStyles.Any, CultureInfo.InvariantCulture, out decimal amount) || amount < 10000)
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞.</b> –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç - 10,000 ‚ÇΩ. –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —á–∏—Å–ª–æ–º:",
                    cancellationToken,
                    "deposit_amount_error");
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
            var requisites = await GetAllRequisitesAsync();
            var lastRequisite = requisites.FirstOrDefault();

            if (lastRequisite == null)
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤.</b> –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    cancellationToken,
                    "deposit_no_requisites");
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –¥–µ–ø–æ–∑–∏—Ç–µ
            using (var cmd = new SQLiteCommand(
                "INSERT INTO Deposits (TelegramId, Amount, Date, Status) " +
                "VALUES (@id, @amount, @date, '–û–∂–∏–¥–∞–µ—Ç')", DbConnection))
            {
                cmd.Parameters.AddWithValue("@id", chatId);
                cmd.Parameters.AddWithValue("@amount", amount);
                cmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                await cmd.ExecuteNonQueryAsync();
            }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —á–µ–∫–∞
            UserStates[chatId] = "waiting_deposit_proof";

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            await SendMessageWithMenu(
                chatId,
                $"""
        <b>üí≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</b>
        
        –°—É–º–º–∞: {amount:F2} ‚ÇΩ
        –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
        ‚Ä¢ <b>–¢–∏–ø</b>: {lastRequisite.Type}
        ‚Ä¢ <b>–ë–∞–Ω–∫/–ú–æ–Ω–µ—Ç–∞</b>: {lastRequisite.BankOrCoin}
        ‚Ä¢ <b>–†–µ–∫–≤–∏–∑–∏—Ç—ã</b>: <code>{lastRequisite.Details}</code>
        
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ PDF —á–µ–∫–∞ –æ –ø–µ—Ä–µ–≤–æ–¥–µ.
        <b>–ß–µ–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:</b>
        ‚Ä¢ –°—É–º–º—É –ø–µ—Ä–µ–≤–æ–¥–∞ ({amount:F2} ‚ÇΩ)
        ‚Ä¢ –†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        ‚Ä¢ –î–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–µ—Ä–µ–≤–æ–¥–∞
        """,
                cancellationToken,
                "deposit_instructions",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", "cancel_deposit")));
        }

        private static async Task ProcessWithdrawAsync(string text, long chatId, int messageId, CancellationToken cancellationToken)
        {
            var parts = text.Split('|', StringSplitOptions.TrimEntries);
            if (parts.Length != 3 || !decimal.TryParse(parts[0].Replace(" ", "").Replace(",", "."),
                NumberStyles.Any, CultureInfo.InvariantCulture, out decimal amount) || amount < 1000)
            {
                await SendMessageWithMenu(
                    chatId,
                    """
            <b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.</b> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
            <code>—Å—É–º–º–∞|—Ç–∏–ø|—Ä–µ–∫–≤–∏–∑–∏—Ç—ã</code>
            –ü—Ä–∏–º–µ—Ä: <code>15000|card|1234 5678 9012 3456</code>
            –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 1,000 ‚ÇΩ
            """,
                    cancellationToken,
                    "withdraw_format_error");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
            var (deposit, interest, _) = await GetUserInfoAsync(chatId);
            if (amount > deposit + interest)
            {
                await SendMessageWithMenu(
                    chatId,
                    $"<b>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.</b> –î–æ—Å—Ç—É–ø–Ω–æ: {(deposit + interest):F2} ‚ÇΩ",
                    cancellationToken,
                    "withdraw_insufficient_funds");
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥
            using (var cmd = new SQLiteCommand(
                "INSERT INTO Withdrawals (TelegramId, Amount, Status, Date) " +
                "VALUES (@id, @amount, '–û–∂–∏–¥–∞–µ—Ç', @date)", DbConnection))
            {
                cmd.Parameters.AddWithValue("@id", chatId);
                cmd.Parameters.AddWithValue("@amount", amount);
                cmd.Parameters.AddWithValue("@date", DateTime.UtcNow.ToString("o"));
                await cmd.ExecuteNonQueryAsync();
            }

            // –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
            foreach (var adminId in AdminIds)
            {
                try
                {
                    await BotClient.SendMessage(
                        chatId: adminId,
                        text: $"üîî –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥:\n\n" +
                              $"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {chatId}\n" +
                              $"üí∞ –°—É–º–º–∞: {amount:F2} ‚ÇΩ\n" +
                              $"üìã –†–µ–∫–≤–∏–∑–∏—Ç—ã: {parts[1]}|{parts[2]}",
                        parseMode: ParseMode.Html,
                        cancellationToken: cancellationToken);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞: {ex}");
                }
            }

            await SendMessageWithMenu(
                chatId,
                $"<b>‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ {amount:F2} ‚ÇΩ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É.</b>",
                cancellationToken,
                "withdraw_success");
            UserStates.Remove(chatId);
        }

        private static async Task ProcessConfirmDepositAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!int.TryParse(text, out int depositId))
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –¥–µ–ø–æ–∑–∏—Ç–∞.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID:",
                    cancellationToken,
                    "confirm_deposit_error");
                return;
            }

            await ConfirmDeposit(chatId, depositId, messageId, cancellationToken);
        }

        private static async Task ProcessConfirmWithdrawalAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            if (!int.TryParse(text, out int withdrawalId))
            {
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –≤—ã–≤–æ–¥–∞.</b> –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID:",
                    cancellationToken,
                    "confirm_withdrawal_error");
                return;
            }

            await ConfirmWithdrawal(chatId, withdrawalId, messageId.ToString(), cancellationToken);
        }

        private static async Task ProcessCalculatorCustomAsync(long chatId, string text, int messageId, CancellationToken cancellationToken)
        {
            var parts = text.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length != 2 || !decimal.TryParse(parts[0], out decimal amount) ||
                !int.TryParse(parts[1], out int weeks) || amount < 10000 || weeks <= 0)
            {
                await SendMessageWithMenu(
                    chatId,
                    """
            <b>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.</b> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
            <code>—Å—É–º–º–∞ –Ω–µ–¥–µ–ª–∏</code>
            –ü—Ä–∏–º–µ—Ä: <code>15000 8</code>
            –ú–∏–Ω–∏–º—É–º: 10,000 ‚ÇΩ –∏ 1 –Ω–µ–¥–µ–ª—è
            """,
                    cancellationToken,
                    "calculator_error");
                return;
            }

            var result = await CalculateProfitAsync(amount, weeks);
            await SendMessageWithMenu(
                chatId,
                result,
                cancellationToken,
                "calculator_result",
                new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "calculator")));
            UserStates.Remove(chatId);
        }
        private static async Task ShowPendingProofsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    @"SELECT dp.Id, dp.DepositId, dp.TelegramId, u.Username, d.Amount, dp.FileId, dp.FileType, dp.Date 
              FROM DepositProofs dp 
              LEFT JOIN Users u ON dp.TelegramId = u.TelegramId
              LEFT JOIN Deposits d ON dp.DepositId = d.Id
              WHERE dp.Status = '–û–∂–∏–¥–∞–µ—Ç' ORDER BY dp.Date",
                    DbConnection);

                using var reader = await cmd.ExecuteReaderAsync();
                var message = new StringBuilder("<b>üßæ –ß–µ–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</b>\n\n");

                var proofs = new List<(int Id, int DepositId, long UserId, string Username, decimal Amount, string FileId, string FileType, DateTime Date)>();
                while (await reader.ReadAsync())
                {
                    proofs.Add((
                        reader.GetInt32(0),
                        reader.GetInt32(1),
                        reader.GetInt64(2),
                        reader.IsDBNull(3) ? "N/A" : reader.GetString(3),
                        reader.GetDecimal(4),
                        reader.GetString(5),
                        reader.GetString(6),
                        DateTime.Parse(reader.GetString(7))
                    ));
                }

                if (!proofs.Any())
                {
                    message.AppendLine("–ù–µ—Ç —á–µ–∫–æ–≤ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.");
                }

                var keyboardRows = new List<InlineKeyboardButton[]>();
                foreach (var proof in proofs)
                {
                    message.AppendLine($"<b>üÜî ID —á–µ–∫–∞</b>: <code>{proof.Id}</code>");
                    message.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={proof.UserId}\">{HtmlEscape(proof.Username)}</a>");
                    message.AppendLine($"<b>üí∞ –°—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</b>: {proof.Amount:F2} ‚ÇΩ");
                    message.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {proof.Date:dd.MM.yyyy HH:mm}");
                    message.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n");

                    keyboardRows.Add(new[]
                    {
                InlineKeyboardButton.WithCallbackData($"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —á–µ–∫ {proof.Id}", $"confirm_proof_{proof.Id}"),
                InlineKeyboardButton.WithCallbackData($"‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å —á–µ–∫ {proof.Id}", $"reject_proof_{proof.Id}")
            });

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∞–º —á–µ–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                    try
                    {
                        if (proof.FileType == "photo")
                        {
                            await botClient.SendPhoto(
                                chatId: chatId,
                                photo: new InputFileId(proof.FileId),
                                caption: $"–ß–µ–∫ ID {proof.Id} –Ω–∞ {proof.Amount:F2} ‚ÇΩ –æ—Ç {HtmlEscape(proof.Username)}",
                                cancellationToken: cancellationToken);
                        }
                        else
                        {
                            await botClient.SendDocument(
                                chatId: chatId,
                                document: new InputFileId(proof.FileId),
                                caption: $"–ß–µ–∫ ID {proof.Id} –Ω–∞ {proof.Amount:F2} ‚ÇΩ –æ—Ç {HtmlEscape(proof.Username)}",
                                cancellationToken: cancellationToken);
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞: {ex}");
                        message.AppendLine($"<b>‚ö† –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–∞ ID {proof.Id}</b>\n");
                    }
                }

                keyboardRows.Add(new[]
                {
            InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "pending_proofs"),
            InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")
        });

                await botClient.SendMessage(
                    chatId: chatId,
                    text: message.ToString(),
                    replyMarkup: new InlineKeyboardMarkup(keyboardRows),
                    parseMode: ParseMode.Html,
                    cancellationToken: cancellationToken);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —á–µ–∫–æ–≤: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —á–µ–∫–æ–≤</b>",
                    cancellationToken,
                    "proofs_error");
            }
        }

        private static async Task ViewDepositsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT d.Id, d.TelegramId, u.Username, d.Amount, d.Date, d.Status " +
                    "FROM Deposits d LEFT JOIN Users u ON d.TelegramId = u.TelegramId " +
                    "ORDER BY d.Date DESC LIMIT 50", DbConnection);

                using var reader = await cmd.ExecuteReaderAsync();
                var response = new StringBuilder("<b>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç—ã</b>\n\n");

                bool hasDeposits = false;
                while (await reader.ReadAsync())
                {
                    hasDeposits = true;
                    response.AppendLine($"<b>üÜî ID</b>: <code>{reader.GetInt32(0)}</code>");
                    response.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={reader.GetInt64(1)}\">{HtmlEscape(reader.IsDBNull(2) ? "N/A" : reader.GetString(2))}</a>");
                    response.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {reader.GetDecimal(3):F2} ‚ÇΩ");
                    response.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {DateTime.Parse(reader.GetString(4)):dd.MM.yyyy HH:mm}");
                    response.AppendLine($"<b>üìå –°—Ç–∞—Ç—É—Å</b>: {HtmlEscape(reader.GetString(5))}");
                    response.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n");
                }

                if (!hasDeposits)
                {
                    response.AppendLine("–î–µ–ø–æ–∑–∏—Ç–æ–≤ –Ω–µ—Ç.");
                }

                var keyboard = new InlineKeyboardMarkup(new[]
                {
            new[] { InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "view_deposits") },
            new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }
        });

                await EditOrSendMessageAsync(
                    botClient, chatId, messageId,
                    response.ToString(), keyboard,
                    cancellationToken, "view_deposits", ParseMode.Html, isNavigation: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤.</b>",
                    cancellationToken,
                    "view_deposits_error");
            }
        }

        private static async Task ViewWithdrawalsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT w.Id, w.TelegramId, u.Username, w.Amount, w.Date, w.Status " +
                    "FROM Withdrawals w LEFT JOIN Users u ON w.TelegramId = u.TelegramId " +
                    "ORDER BY w.Date DESC LIMIT 50", DbConnection);

                using var reader = await cmd.ExecuteReaderAsync();
                var response = new StringBuilder("<b>üí∏ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–≤–æ–¥—ã</b>\n\n");

                bool hasWithdrawals = false;
                while (await reader.ReadAsync())
                {
                    hasWithdrawals = true;
                    response.AppendLine($"<b>üÜî ID</b>: <code>{reader.GetInt32(0)}</code>");
                    response.AppendLine($"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</b>: <a href=\"tg://user?id={reader.GetInt64(1)}\">{HtmlEscape(reader.IsDBNull(2) ? "N/A" : reader.GetString(2))}</a>");
                    response.AppendLine($"<b>üí∞ –°—É–º–º–∞</b>: {reader.GetDecimal(3):F2} ‚ÇΩ");
                    response.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {DateTime.Parse(reader.GetString(4)):dd.MM.yyyy HH:mm}");
                    response.AppendLine($"<b>üìå –°—Ç–∞—Ç—É—Å</b>: {HtmlEscape(reader.GetString(5))}");
                    response.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n");
                }

                if (!hasWithdrawals)
                {
                    response.AppendLine("–í—ã–≤–æ–¥–æ–≤ –Ω–µ—Ç.");
                }

                var keyboard = new InlineKeyboardMarkup(new[]
                {
            new[] { InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "view_withdrawals") },
            new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }
        });

                await EditOrSendMessageAsync(
                    botClient, chatId, messageId,
                    response.ToString(), keyboard,
                    cancellationToken, "view_withdrawals", ParseMode.Html, isNavigation: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –≤—ã–≤–æ–¥–æ–≤: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –≤—ã–≤–æ–¥–æ–≤.</b>",
                    cancellationToken,
                    "view_withdrawals_error");
            }
        }
        private static async Task EnsureReferralColumnsExist()
        {
                string[] columns = {
            "BonusAmount REAL DEFAULT 0",
            "BonusPaid INTEGER DEFAULT 0",
            "FirstDepositAmount REAL",
            "PaidDate TEXT"
        };

            foreach (var column in columns)
            {
                try
                {
                    var columnName = column.Split(' ')[0];
                    using var checkCmd = new SQLiteCommand(
                        $"SELECT COUNT(*) FROM pragma_table_info('Referrals') WHERE name='{columnName}'",
                        DbConnection);

                    if ((long)await checkCmd.ExecuteScalarAsync() == 0)
                    {
                        using var alterCmd = new SQLiteCommand(
                            $"ALTER TABLE Referrals ADD COLUMN {column}",
                            DbConnection);
                        await alterCmd.ExecuteNonQueryAsync();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏/–¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ {column}: {ex}");
                }
            }
        }
        private static async Task ViewReferralsAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                using var cmd = new SQLiteCommand(
                    "SELECT r.Id, r.ReferrerId, r.RefereeId, u1.Username AS ReferrerUsername, " +
                    "u2.Username AS RefereeUsername, r.Bonus, r.Date " +
                    "FROM Referrals r " +
                    "LEFT JOIN Users u1 ON r.ReferrerId = u1.TelegramId " +
                    "LEFT JOIN Users u2 ON r.RefereeId = u2.TelegramId " +
                    "ORDER BY r.Date DESC LIMIT 50", DbConnection);

                using var reader = await cmd.ExecuteReaderAsync();
                var response = new StringBuilder("<b>ü§ù –°–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</b>\n\n");

                bool hasReferrals = false;
                while (await reader.ReadAsync())
                {
                    hasReferrals = true;
                    response.AppendLine($"<b>üÜî ID</b>: <code>{reader.GetInt32(0)}</code>");
                    response.AppendLine($"<b>üë§ –†–µ—Ñ–µ—Ä–µ—Ä</b>: <a href=\"tg://user?id={reader.GetInt64(1)}\">{HtmlEscape(reader.IsDBNull(3) ? "N/A" : reader.GetString(3))}</a>");
                    response.AppendLine($"<b>üë§ –†–µ—Ñ–µ—Ä–∞–ª</b>: <a href=\"tg://user?id={reader.GetInt64(2)}\">{HtmlEscape(reader.IsDBNull(4) ? "N/A" : reader.GetString(4))}</a>");
                    response.AppendLine($"<b>üí∞ –ë–æ–Ω—É—Å</b>: {reader.GetDecimal(5):F2} ‚ÇΩ");
                    response.AppendLine($"<b>üìÖ –î–∞—Ç–∞</b>: {DateTime.Parse(reader.GetString(6)):dd.MM.yyyy HH:mm}");
                    response.AppendLine("‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨\n");
                }

                if (!hasReferrals)
                {
                    response.AppendLine("–†–µ—Ñ–µ—Ä–∞–ª–æ–≤ –Ω–µ—Ç.");
                }

                var keyboard = new InlineKeyboardMarkup(new[]
                {
            new[] { InlineKeyboardButton.WithCallbackData("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "view_referrals") },
            new[] { InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu") }
        });

                await EditOrSendMessageAsync(
                    botClient, chatId, messageId,
                    response.ToString(), keyboard,
                    cancellationToken, "view_referrals", ParseMode.Html);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤.</b>",
                    cancellationToken,
                    "view_referrals_error");
            }
        }
        private static async Task ShowRequisitesMenuAsync(long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                var requisites = await GetAllRequisitesAsync();
                var buttons = requisites.Select(req => new[] {
                    InlineKeyboardButton.WithCallbackData($"{req.Type} ({req.BankOrCoin})", $"requisite_detail_{req.Id}")
                }).ToList();

                buttons.Add(new[] {
                    InlineKeyboardButton.WithCallbackData("‚ûï –î–æ–±–∞–≤–∏—Ç—å", "add_requisite"),
                    InlineKeyboardButton.WithCallbackData("üîô –ù–∞–∑–∞–¥", "admin_menu")
                });

                await EditOrSendMessageAsync(
                    BotClient, chatId, messageId,
                    "<b>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏</b>",
                    new InlineKeyboardMarkup(buttons), cancellationToken, "requisites_menu", ParseMode.Html, isNavigation: true);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤: {ex}");
                await SendMessageWithMenu(
                    chatId,
                    "<b>‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤</b>",
                    cancellationToken,
                    "requisites_error");
            }
        }

        private static async Task CalculateInterestAsync()
        {
            try
            {
                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –ù–∞—á–∞–ª–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤");

                using var cmd = new SQLiteCommand(
                    "SELECT TelegramId, Deposit, ReferralCount FROM Users WHERE Deposit > 0", DbConnection);
                using var reader = await cmd.ExecuteReaderAsync();

                var users = new List<(long UserId, decimal Deposit, int ReferralCount)>();
                while (await reader.ReadAsync())
                {
                    users.Add((
                        reader.GetInt64(0),
                        reader.GetDecimal(1),
                        reader.GetInt32(2)
                    ));
                }

                foreach (var user in users)
                {
                    decimal rate = user.Deposit >= 50000 ? 0.06m : 0.05m;
                    decimal interest = user.Deposit * rate;

                    // –ù–∞—á–∏—Å–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å (1% —Ç–æ–ª—å–∫–æ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞)
                    decimal referralBonus = 0;
                    using (var referralCmd = new SQLiteCommand(
                        @"SELECT d.Amount FROM Deposits d 
                  JOIN Referrals r ON d.TelegramId = r.RefereeId 
                  WHERE r.ReferrerId = @id AND d.Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω'
                  AND d.Id = (SELECT MIN(Id) FROM Deposits WHERE TelegramId = r.RefereeId AND Status = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω')",
                        DbConnection))
                    {
                        referralCmd.Parameters.AddWithValue("@id", user.UserId);
                        using var referralReader = await referralCmd.ExecuteReaderAsync();

                        while (await referralReader.ReadAsync())
                        {
                            decimal referralRate = user.ReferralCount >= 5 ? 0.02m : 0.01m;
                            referralBonus += referralReader.GetDecimal(0) * referralRate;
                        }
                    }

                    decimal totalToAdd = interest + referralBonus;

                    using (var updateCmd = new SQLiteCommand(
                        "UPDATE Users SET Interest = Interest + @interest WHERE TelegramId = @id", DbConnection))
                    {
                        updateCmd.Parameters.AddWithValue("@interest", totalToAdd);
                        updateCmd.Parameters.AddWithValue("@id", user.UserId);
                        await updateCmd.ExecuteNonQueryAsync();
                    }

                    try
                    {
                        string bonusMessage = referralBonus > 0 ?
                            $"\nüéÅ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å: {referralBonus:F2} ‚ÇΩ (1% –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞)" :
                            "";

                        await BotClient.SendMessage(
                            chatId: user.UserId,
                            text: $"""
                        <b>üí∏ –ù–∞—á–∏—Å–ª–µ–Ω—ã –ø—Ä–æ—Ü–µ–Ω—Ç—ã!</b>
                        
                        üìà –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã: {interest:F2} ‚ÇΩ
                        {bonusMessage}
                        üí∞ –ò—Ç–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ: {totalToAdd:F2} ‚ÇΩ
                        """,
                            parseMode: ParseMode.Html,
                            cancellationToken: CancellationToken.None);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.UserId}: {ex}");
                    }
                }

                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –ü—Ä–æ—Ü–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –¥–ª—è {users.Count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}] –û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤: {ex}");
            }
        }

        private static async Task<Message> EditOrSendMessageAsync(
            ITelegramBotClient botClient,
            long chatId,
            int messageId,
            string text,
            InlineKeyboardMarkup keyboard,
            CancellationToken cancellationToken,
            string messageKey,
            ParseMode parseMode = ParseMode.Html,
            bool isNavigation = false)  // –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: true –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, false –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        {
            try
            {
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –º–µ–Ω—é) –∏ –µ—Å—Ç—å messageId ‚Üí —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
                if (isNavigation && messageId != 0)
                {
                    try
                    {
                        var msg = await botClient.EditMessageText(
                            chatId: chatId,
                            messageId: messageId,
                            text: text,
                            replyMarkup: keyboard,
                            parseMode: parseMode,
                            cancellationToken: cancellationToken);

                        LastMessageIds[chatId] = msg.MessageId;
                        return msg;
                    }
                    catch (Exception ex) when (ex.Message.Contains("message is not modified"))
                    {
                        return null;  // –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                    }
                    catch (Exception)
                    {
                        // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                    }
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                var sentMessage = await botClient.SendMessage(
                    chatId: chatId,
                    text: text,
                    replyMarkup: keyboard,
                    parseMode: parseMode,
                    cancellationToken: cancellationToken);

                LastMessageIds[chatId] = sentMessage.MessageId;
                return sentMessage;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"–û—à–∏–±–∫–∞: {ex}");
                throw;
            }
        }

        #endregion

        #region Helper Methods

        private static string GetStatusEmoji(string status)
        {
            return status switch
            {
                "–ù–æ–≤–∏—á–æ–∫" => "üê£",
                "–ü—Ä–æ—Ñ–∏" => "ü¶Å",
                "–ö–∏—Ç" => "üê≥",
                _ => "‚ùì"
            };
        }

        private static async Task SendMessageWithMenu(
            long chatId,
            string text,
            CancellationToken cancellationToken,
            string messageKey,
            InlineKeyboardMarkup keyboard = null,
            bool forceNewMessage = false)
        {
            keyboard ??= GetMainMenuKeyboard();
            await EditOrSendMessageAsync(
                BotClient, chatId, 0,
                text, keyboard, cancellationToken,
                messageKey, ParseMode.Html,
                isNavigation: messageKey != "main_menu" && messageKey != "admin_menu" || forceNewMessage);
        }

        private static async Task SendErrorMessage(long chatId, string errorText, CancellationToken cancellationToken)
        {
            await EditOrSendMessageAsync(
                botClient: BotClient,
                chatId: chatId,
                messageId: 0,  // 0 = –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                text: $"<b>‚ùå –û—à–∏–±–∫–∞:</b> {errorText}",
                keyboard: new InlineKeyboardMarkup(InlineKeyboardButton.WithCallbackData("–ù–∞–∑–∞–¥", "main_menu")),
                cancellationToken: cancellationToken,
                messageKey: "error_message",
                isNavigation: false);  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }

        private static InlineKeyboardMarkup GetMainMenuKeyboard()
        {
            return new InlineKeyboardMarkup(new[]
            {
                new[] { InlineKeyboardButton.WithCallbackData("üí∞ –ú–æ–π –¥–µ–ø–æ–∑–∏—Ç", "my_deposit") },
                new[] { InlineKeyboardButton.WithCallbackData("ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞", "referral") },
                new[] { InlineKeyboardButton.WithCallbackData("üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏", "calculator") },
                new[] { InlineKeyboardButton.WithCallbackData("üë§ –ü—Ä–æ—Ñ–∏–ª—å", "balance") }
            });
        }

        private static InlineKeyboardMarkup GetAdminMenuKeyboard()
        {
            return new InlineKeyboardMarkup(new[]
            {
                new[] { InlineKeyboardButton.WithCallbackData("üìã –†–µ–∫–≤–∏–∑–∏—Ç—ã", "requisites_menu") },
                new[] { InlineKeyboardButton.WithCallbackData("üí≥ –î–µ–ø–æ–∑–∏—Ç—ã", "deposits_list") },
                new[] { InlineKeyboardButton.WithCallbackData("üí∏ –í—ã–≤–æ–¥—ã", "withdrawals_list") },
                new[] { InlineKeyboardButton.WithCallbackData("üßæ –ß–µ–∫–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É", "pending_proofs") },
                new[] { InlineKeyboardButton.WithCallbackData("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç", "cancel_deposit_admin") },
                new[] { InlineKeyboardButton.WithCallbackData("üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "block_user") },
                new[] { InlineKeyboardButton.WithCallbackData("üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "unblock_user") },
                new[] { InlineKeyboardButton.WithCallbackData("üîô –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "main_menu") }
            });
        }

        private static string HtmlEscape(string text)
        {
            if (string.IsNullOrEmpty(text)) return text;
            return text.Replace("&", "&amp;")
                      .Replace("<", "&lt;")
                      .Replace(">", "&gt;")
                      .Replace("\"", "&quot;");
        }

        private static Task HandleErrorAsync(ITelegramBotClient botClient, Exception exception, CancellationToken cancellationToken)
        {
            Console.WriteLine($"–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ: {exception}");
            return Task.CompletedTask;
        }

        #endregion
    }
}
